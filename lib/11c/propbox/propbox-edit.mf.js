
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
(function(b,e){e.require("dojo.date.stamp");e.require("dojo.date.locale");e.require("dojo.number");b.fn.validate_input=function(c){return this.each(function(){var g=b(this);if(g.is(":text")){var h=g.data("$.validate_input");h&&h._destroy();h=new f(this,c);g.data("$.validate_input",h)}})};var f=b.validate_input=function(c,g){var h=this.options=b.extend(true,{},f.defaults,g);if(typeof h.validator!=="function")throw"A validator is required";if(!h.lang)h.lang="/lang/en";h.lang=h.lang==="/lang/en"?["lang/en"]:
[h.lang,"/lang/en"];h.locales=[];b.each(h.lang,function(a,j){h.locales[a]=e.i18n.normalizeLocale(j.split("/").pop())});this.input=b(c);this.original_value=this.input.val();this.init();var i=this;this.input.bind("remove",function(){i._destroy()});return this};f.prototype={init:function(){var c=this;this.input.bind("keyup.validate_input",function(g){c.textchange(g)}).bind(b.browser.msie?"paste.validate_input":"input.validate_input",function(g){c.textchange(g)})},_destroy:function(){this.input.unbind(".validate_input")},
original:function(){this.input.trigger("original")},valid:function(c){this.input.trigger("valid",c)},invalid:function(c,g){this.input.trigger("invalid",g)},textchange:function(){clearTimeout(this.textchange_timeout);var c=this;this.textchange_timeout=setTimeout(function(){c.validate()},200)},validate:function(c){c&&clearTimeout(this.textchange_timeout);c=this.input.val();if(this.original_value===c)return this.original(c);c=b.trim(c);var g=this.options;try{return this.valid(g.validator(c,g))}catch(h){return this.invalid(c,
""+h)}}};b.extend(f,{defaults:{validator:function(c){return{text:c,value:c}}},log:function(){},invalid:function(c,g,h,i){throw new Error("Invalid "+h+(i?": "+i:""));},text:function(c,g){if(c.lengh>4096)return this.invalid(c,g,type,"Text too long");return{text:c,value:c}},topic:function(){return f.defaults.validator},enumerated:function(){return f.defaults.validator},"boolean":function(){return f.defaults.validator},uri:function(c,g){var h=f.uri.regex;if(!h)h=f.uri.regex=/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
if(h.test(c))return{text:c,value:c};return f.invalid(c,g,"uri")},"int":function(c,g){return f.number.parse(c,g,false)},"float":function(c,g){return f.number.parse(c,g,true)},number:function(c,g,h){return f.number.parse(c,g,h)},datetime:function(c,g){return f.datetime.parse(c,g)},mqlkey:function(c,g){var h=f.mqlkey.regex;if(!h)h=f.mqlkey.regex=/^[A-Za-z0-9][A-Za-z0-9_-]*$/;if(h.test(c))return{text:c,value:c};return f.invalid(c,g,"mqlkey")}});b.extend(f.number,{parse:function(c,g,h){var i=g&&g.locales||
["en"],a,j;a=0;for(j=i.length;a<j;a++){var d=i[a];g=e.number.parse(c,{locale:d});if(!isNaN(g)){c={};if(h){c.value=g;c.text=e.number.format(g,{locale:d})}else{c.value=e.number.round(g,0);c.text=e.number.format(c.value,{locale:d})}return c}}throw f.invalid("number",c);}});b.extend(f.datetime,{formats:["yyyy",["dateFormatItem-y"],"yyyy-MM",["dateFormatItem-yM","dateFormatItem-yMMM"],"yyyy-MM-dd",["dateFormat-short","dateFormat-medium","dateFormat-long"]],parse:function(c,g){if(!e.date.stamp._isoRegExp)e.date.stamp._isoRegExp=
/^(?:(-?\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(.\d+)?)?((?:[+-](\d{2}):(\d{2}))|Z)?)?$/;var h=e.date.stamp.fromISOString(c);if(h)return{text:c,value:c,date:h};var i=g&&g.locales||["en"],a,j,d,k,l,m;a=0;for(j=i.length;a<j;a++){var o=i[a],q=e.date.locale._getGregorianBundle(o);d=0;for(k=f.datetime.formats.length;d<k;d+=2){var r=f.datetime.formats[d],p=f.datetime.formats[d+1];l=0;for(m=p.length;l<m;l++){var n=q[p[l]];if(n){n=n.replace(/L/g,"M");try{h=e.date.locale.parse(c,{datePattern:n,
selector:"date",locale:o});return{text:c,value:e.date.locale.format(h,{datePattern:r,selector:"date"}),date:h}}catch(s){}}}}}throw f.invalid("datetime",c);}})})(jQuery,dojo);
(function(b){b.fn.data_input=function(e){return this.each(function(){var f=b(this),c=f.data("$.data_input");c&&c._destroy();c=new b.data_input(this,e);f.data("$.data_input",c)})};b.data_input=function(e,f){this.options=b.extend(true,{},b.data_input.defaults,f);this.container=b(e);this.input=b(":input",this.container);this.init();var c=this;this.input.bind("remove",function(){c._destroy()})};b.data_input.prototype={init:function(){var e=this,f=this.container,c=this.input;if(f.is(".topic"))c.validate_topic(b.extend(true,
{},this.options.suggest,{type:f.attr("data-ect")})).bind("valid.data_input",function(g,h){e.fb_select(h)}).bind("invalid.data_input",function(){e.fb_textchange()});else if(f.is(".text"))c.validate_input({validator:b.validate_input.text});else if(f.is(".datetime"))c.validate_input({validator:b.validate_input.datetime,lang:this.options.lang});else if(f.is(".enumerated"))c.validate_enumerated().bind("valid.data_input",function(g,h){e.fb_select(h)}).bind("invalid.data_input",function(){e.fb_textchange()});
else if(f.is(".int"))c.validate_input({validator:b.validate_input["int"],lang:this.options.lang});else if(f.is(".float"))c.validate_input({validator:b.validate_input["float"],lang:this.options.lang});else if(f.is(".uri"))c.validate_input({validator:b.validate_input.uri});else if(f.is(".boolean"))c.validate_boolean();else if(f.is(".enumeration"))c.validate_input({validator:b.validate_input.mqlkey});else if(f.is(".rawstring"))c.validate_input({validator:b.validate_input.text});else throw new Error("Invalid data-input: "+
f.attr("class"));this.input.bind("focusin.data_input",function(){e.container.addClass("focus")}).bind("focusout.data_input",function(){e.container.removeClass("focus")}).bind("valid.data_input",function(g,h){var i=e.input.attr("name");e.container.data("name_value",[i,h.id||h.value]);e.container.removeClass("error").addClass("valid")}).bind("invalid.data_input",function(){e.container.removeData("name_value");e.container.removeClass("valid").addClass("error")}).bind("keypress.data_input",function(g){g.keyCode===
13&&!g.isDefaultPrevented()&&e.container.trigger("submit")}).bind("keyup.data_input",function(g){g.keyCode===27&&e.container.trigger("cancel")})},_destroy:function(){this.input.unbind(".data_input")},validate:function(){var e=this.input;b.each(["$.validate_topic","$.validate_input","$.validate_enumerated","$.validate_boolean"],function(f,c){var g=e.data(c);if(g){g.validate(true);return false}})},reset:function(){this.container.removeData("name_value");if(this.input.is(":text"))this.input.val("");
else if(this.input.is("select"))this.input[0].selectedIndex=0;else this.input.is(":radio")&&this.input.each(function(){this.checked=false});this.container.siblings().find("[data-lang]").val("")},fb_textchange:function(){this.container.siblings().find("[data-lang]").val("")},fb_select:function(e){var f=[],c=this.container.siblings(".lang-input").find(":text[data-lang]");c.each(function(){var h=b(this).attr("data-lang");h&&f.push(h)});if(f.length){e={id:e.id,name:[{value:null,lang:null,optional:true,
"lang|=":f}]};var g=this;this.fb_select.jqXHR&&this.fb_select.jqXHR.abort();this.fb_select.jqXHR=b.ajax({url:this.options.suggest.mqlread_url,data:{query:JSON.stringify({query:e})},dataType:"jsonp",beforeSend:function(h,i){g.ajax_beforeSend(h,i)},success:function(h){if(h.code=="/api/status/ok"&&h.result){var i=g.container.data("name_value");if(i&&i[1]===h.result.id)if((i=h.result.name)&&i.length){var a={};b.each(i,function(j,d){a[d.lang]=d.value});c.each(function(){var j=b(this),d=j.attr("data-lang"),
k=h.result.id+".name."+d;j.val(a[d]||"").attr("name",k)})}}},complete:function(h,i){g.ajax_complete(h,i)}})}},ajax_beforeSend:function(e){if(!this.xhr_queue)this.xhr_queue=[];this.xhr_queue.push(e);this.container.trigger("loading")},ajax_complete:function(e){if(!this.xhr_queue)this.xhr_queue=[];for(var f=0,c=this.xhr_queue.length;f<c;f++)if(e===this.xhr_queue[f]){this.xhr_queue.splice(f,1);break}this.xhr_queue.length===0&&this.container.trigger("loading_complete")}};b.extend(b.data_input,{defaults:{suggest:{service_url:"http://www.freebase.com",
service_path:"/private/suggest",flyout_service_url:"http://www.freebase.com",flyout_service_path:"/private/flyout",mqlread_url:"http://api.freebase.com/api/service/mqlread",category:"object",type:"/common/topic"}}});b.fn.validate_topic=function(e){return this.each(function(){var f=b(this);if(f.is(":text")){var c=f.data("$.validate_topic");c&&c._destroy();c=new b.validate_topic(this,e);f.data("$.validate_topic",c)}})};b.validate_topic=function(e,f){this.options=b.extend(true,{},f);this.input=b(e);
this.init()};b.validate_topic.prototype={init:function(){var e=this;this.input.suggest(this.options).bind("fb-textchange.validate_topic",function(){e.invalid()}).bind("fb-select.validate_topic",function(f,c){e.input.val(c.id);e.valid(c)})},invalid:function(){this.input.trigger("invalid")},valid:function(e){this.input.trigger("valid",e)},_destroy:function(){this.input.unbind(".validate_topic")},validate:function(){}};b.fn.validate_enumerated=function(e){return this.each(function(){var f=b(this);if(f.is("select")){var c=
f.data("$.validate_enumerated");c&&c._destroy();c=new b.validate_enumerated(this,e);f.data("$.validate_enumerated",c)}})};b.validate_enumerated=function(e,f){this.options=b.extend(true,{},f);this.input=b(e);this.init()};b.validate_enumerated.prototype={init:function(){var e=this;this.input.bind("change.validate_enumerated",function(){this.selectedIndex>0?e.valid({text:b(":selected",this).text(),id:this.value}):e.invalid()})},invalid:function(){this.input.trigger("invalid")},valid:function(e){this.input.trigger("valid",
e);this.input.trigger("fb-select",e)},_destroy:function(){this.input.unbind(".validate_enumerated")},validate:function(){}};b.fn.validate_boolean=function(e){return this.each(function(){var f=b(this);if(f.is(":radio")){var c=f.data("$.validate_boolean");c&&c._destroy();c=new b.validate_boolean(this,e);f.data("$.validate_boolean",c)}})};b.validate_boolean=function(e,f){this.options=b.extend(true,{},f);this.input=b(e);this.init()};b.validate_boolean.prototype={init:function(){var e=this;this.input.bind("change.validate_boolean",
function(){e.valid({text:b(this).text(),value:this.value})})},_destroy:function(){this.input.unbind(".validate_boolean")},valid:function(e){this.input.trigger("valid",e)},validate:function(){}}})(jQuery);
(function(b,e){var f=e.options.base_url,c=e.options.id,g=e.options.lang,h=e.options.suggest,i=e.edit={prop_add_begin:function(a){var j={s:c,p:a.attr("data-id"),lang:g};b.ajax({url:f+"/prop_add_begin.ajax",data:j,dataType:"json",success:function(d){d=b(d.result.html).hide();var k={mode:"add",event_prefix:"propbox.edit.prop_add.",ajax:{data:j,url:f+"/prop_add_submit.ajax"},init:i.init_prop_add_form,validate:i.validate_prop_add_form,submit:i.submit_prop_add_form,form:d,prop_section:a};i.init(k);k.form.bind("propbox.edit.prop_add.success",
function(){i.reset_data_input(k);b(":input:visible:first",k.form).focus();b(".button-cancel",k.form).text("Done")})},error:function(d){i.ajax_error(d,form)}})},init_prop_add_form:function(a){i.init_data_input(a);b(":input:visible:first",a.form).focus()},validate_prop_add_form:function(a){return i.validate_data_input(a)},submit_prop_add_form:function(a){var j=b.extend({},a.ajax.data);b(".data-input",a.form).each(function(){var d=b(this).data("name_value");if(d)j[d[0]]=d[1]});b(".lang-input :text[data-lang]",
a.form).each(function(){var d=b(this);j[d.attr("name")]=d.val()});b.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:j,success:function(d,k,l){if(d.code!=="/api/status/ok")return i.ajax_error(l,a);d=b(d.result.html);if(d.is("tr")){b(".data-table > tbody",a.prop_section).append(d);b(".data-table > thead",a.prop_section).show()}else b(".data-list",a.prop_section).append(d);i18n.ize(d);a.form.trigger(a.event_prefix+"success")},error:function(d){i.ajax_error(d,a)}})},value_edit_begin:function(a,
j){var d;if(j.is("tr"))d=j.attr("data-id");else{d=b(".property-value:first",j);d=d.attr("data-id")||d.attr("data-value")||d.attr("datetime")}var k={s:c,p:a.attr("data-id"),o:d,lang:g};b.ajax({url:f+"/value_edit_begin.ajax",data:k,dataType:"json",success:function(l){l=b(l.result.html).hide();var m={mode:"edit",event_prefix:"propbox.edit.value_edit.",ajax:{data:k,url:f+"/value_edit_submit.ajax"},init:i.init_value_edit_form,validate:i.validate_value_edit_form,submit:i.submit_value_edit_form,form:l,prop_section:a,
prop_row:j};i.init(m);m.form.bind("propbox.edit.value_edit.success",function(){console.log("propbox.edit.value_edit.success");m.form.remove()}).bind("propbox.edit.value_edit.cancel",function(){console.log("propbox.edit.value_edit.cancel");m.prop_row.show()})},error:function(l){i.ajax_error(l,form)}})},init_value_edit_form:function(a){i.init_data_input(a);b(":input:visible:first",a.form).focus()},validate_value_edit_form:function(a){return i.validate_data_input(a)},submit_value_edit_form:function(a){var j=
b.extend({},a.ajax.data);b(".data-input",a.form).each(function(){var d=b(this).data("name_value");if(d)j[d[0]]=d[1]});b(".lang-input :text[data-lang]",a.form).each(function(){var d=b(this);j[d.attr("name")]=d.val()});b.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:j,success:function(d,k,l){if(d.code!=="/api/status/ok")return i.ajax_error(l,a);d=b(d.result.html);d.is("tr")&&b(".data-table > thead",a.prop_section).show();a.prop_row.after(d);i18n.ize(d);a.prop_row.remove();a.form.trigger(a.event_prefix+
"success")},error:function(d){i.ajax_error(d,a)}})},init_data_input:function(a){b(".data-input",a.form).each(function(){b(this).data_input({lang:g,suggest:h}).bind("submit",function(){a.form.trigger(a.event_prefix+"submit")}).bind("cancel",function(){a.form.trigger(a.event_prefix+"cancel")}).bind("loading",function(){b(this).addClass("loading")}).bind("loading_complete",function(){b(this).removeClass("loading")})})},validate_data_input:function(a){var j=true;b(".data-input",a.form).each(function(d){var k=
b(this);if(k.is(".loading")){console.log("data_input.is(.loading)");return j=false}k.data("$.data_input").validate(true);if(d===0&&!k.is(".valid"))j=i.data_input_required(a,k);else if(k.is(".error"))j=i.data_input_invalid(a,k)});return j},reset_data_input:function(a){b(".data-input",a.form).each(function(){b(this).data("$.data_input").reset()})},init:function(a){if(a.mode==="add"){var j=b(">.data-section",a.prop_section);b("> .data-table > tbody > .empty-row, > .data-list > .empty-row",j).hide();
a.prop_section.append(a.form)}else if(a.mode==="edit"){a.prop_row.hide();a.prop_row.after(a.form)}var d=a.event_prefix||"propbox.edit.";a.form.bind(d+"submit",function(){i.submit(a)}).bind(d+"cancel",function(){i.cancel(a)}).bind(d+"error",function(k,l){i.error(a,l);a.form.removeClass("loading");a.prop_section.removeClass("editing")}).bind(d+"success",function(){a.form.removeClass("loading");a.prop_section.removeClass("editing")});b(".button-submit",a.form).click(function(){a.form.trigger(d+"submit")});
b(".button-cancel",a.form).click(function(){a.form.trigger(d+"cancel")});a.form.show();e.kbs.scroll_to(a.prop_section);a.init&&a.init(a)},cancel:function(a){a.form.hide().remove();a.prop_section.removeClass("editing");a=b(">.data-section",a.prop_section);b("> .data-table > tbody > tr, > .data-list > li",a).filter(":not(.empty-row)").length||b("> .data-table > tbody > .empty-row, > .data-list > .empty-row",a).show()},submit:function(a){if(!a.form.is(".loading")){document.activeElement&&b(document.activeElement).blur();
i.clear_form_message(a);if(a.validate)if(!a.validate(a))return;a.form.addClass("loading");a.submit&&a.submit(a)}},data_input_required:function(a,j){var d=j.prev(".form-label").text();i.form_error(a,"Required: "+d)},data_input_invalid:function(a,j){var d=j.prev(".form-label").text();i.form_error(a,"Invalid: "+d)},form_error:function(a,j){return i.form_message(a,j,"error")},form_message:function(a,j,d){var k=b('<a class="close-msg" href="#">x</a>').click(function(){b(this).parents("tr:first").remove();
return false});j=b("<span>").text(j);k=b("<td>").append(k).append(j);k=b('<tr class="row-msg">').append(k);d&&k.addClass("row-msg-"+d);(a.prop_row||b(".edit-row",a.form)).before(k);return k},clear_form_message:function(a){a.prop_row?a.prop_row.prev(".row-msg").remove():b(".row-msg",a.form).remove()},ajax_error:function(a,j){var d;try{d=JSON.parse(a.responseText);if(d.messages&&d.messages.length)d=JSON.stringify(d.messages[0])}catch(k){}if(!d)d=a.responseText;i.form_error(j,d);j.form.removeClass("loading")}}})(jQuery,
window.propbox);
