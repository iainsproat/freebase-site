
/*
 * Copyright 2012, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
function method(b,d){return function(){b[d].apply(b,arguments)}}var StopIteration={toString:function(){return"StopIteration"}};function forEach(b,d){if(b.next)try{for(;;)d(b.next())}catch(g){if(g!=StopIteration)throw g;}else for(var i=0;i<b.length;i++)d(b[i])}function map(b,d){var g=[];forEach(b,function(b){g.push(d(b))});return g}function matcher(b){return function(d){return b.test(d)}}function hasClass(b,d){var g=b.className;return g&&RegExp("(^| )"+d+"($| )").test(g)}
function insertAfter(b,d){d.parentNode.insertBefore(b,d.nextSibling);return b}function removeElement(b){b.parentNode&&b.parentNode.removeChild(b)}function clearElement(b){for(;b.firstChild;)b.removeChild(b.firstChild)}function isAncestor(b,d){for(;d=d.parentNode;)if(b==d)return!0;return!1}var nbsp="\u00a0",matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("};
function normalizeEvent(b){b.stopPropagation||(b.stopPropagation=function(){this.cancelBubble=!0},b.preventDefault=function(){this.returnValue=!1});b.stop||(b.stop=function(){this.stopPropagation();this.preventDefault()});"keypress"==b.type&&(b.code=null==b.charCode?b.keyCode:b.charCode,b.character=String.fromCharCode(b.code));return b}
function addEventHandler(b,d,g,i){function h(b){g(normalizeEvent(b||window.event))}if("function"==typeof b.addEventListener){if(b.addEventListener(d,h,!1),i)return function(){b.removeEventListener(d,h,!1)}}else if(b.attachEvent("on"+d,h),i)return function(){b.detachEvent("on"+d,h)}}function nodeText(b){return b.textContent||b.innerText||b.nodeValue||""}function nodeTop(b){for(var d=0;b.offsetParent;)d+=b.offsetTop,b=b.offsetParent;return d}function isBR(b){b=b.nodeName;return"BR"==b||"br"==b}
function isSpan(b){b=b.nodeName;return"SPAN"==b||"span"==b}
var stringStream=function(b){function d(){for(;i==g.length;){h+=g;g="";i=0;try{g=b.next()}catch(d){if(d!=StopIteration)throw d;return!1}}return!0}var g="",i=0,h="";return{peek:function(){return!d()?null:g.charAt(i)},next:function(){if(!d()){if(0<h.length)throw"End of stringstream reached without emptying buffer ('"+h+"').";throw StopIteration;}return g.charAt(i++)},get:function(){var b=h;h="";0<i&&(b+=g.slice(0,i),g=g.slice(i),i=0);return b},push:function(b){g=g.slice(0,i)+b+g.slice(i)},lookAhead:function(d,
f,a,c){function l(a){return c?a.toLowerCase():a}var d=l(d),m=!1,e=h,r=i;for(a&&this.nextWhileMatches(/[\s\u00a0]/);;){var a=i+d.length,j=g.length-i;if(a<=g.length){m=d==l(g.slice(i,a));i=a;break}else if(d.slice(0,j)==l(g.slice(i))){h+=g;g="";try{g=b.next()}catch(C){break}i=0;d=d.slice(j)}else break}if(!m||!f)g=h.slice(e.length)+g,i=r,h=e;return m},more:function(){return null!==this.peek()},applies:function(b){var f=this.peek();return null!==f&&b(f)},nextWhile:function(b){for(var f;null!==(f=this.peek())&&
b(f);)this.next()},matches:function(b){var f=this.peek();return null!==f&&b.test(f)},nextWhileMatches:function(b){for(var f;null!==(f=this.peek())&&b.test(f);)this.next()},equals:function(b){return b===this.peek()},endOfLine:function(){var b=this.peek();return null==b||"\n"==b}}},select={};
(function(){function b(a,c){for(;a&&a.parentNode!=c;)a=a.parentNode;return a}function d(a,c){for(;!a.previousSibling&&a.parentNode!=c;)a=a.parentNode;return b(a.previousSibling,c)}function g(a){var c=a.nextSibling;if(c){for(;c.firstChild;)c=c.firstChild;return 3==c.nodeType||isBR(c)?c:g(c)}for(a=a.parentNode;a&&!a.nextSibling;)a=a.parentNode;return a&&g(a)}select.ie_selection=document.selection&&document.selection.createRangeCollection;select.scrollToNode=function(a,c){if(a){for(var e=a,b=document.body,
j=document.documentElement,C=!e.nextSibling||!e.nextSibling.nextSibling||!e.nextSibling.nextSibling.nextSibling,f=0;e&&!e.offsetTop;)f++,e=e.previousSibling;0==f&&(C=!1);if(!webkit||!e||!(5==e.offsetTop&&5==e.offsetLeft)){for(var f=f*(e?e.offsetHeight:0),d=0,g=a?a.offsetWidth:0;e&&e.offsetParent;)f+=e.offsetTop,isBR(e)||(d+=e.offsetLeft),e=e.offsetParent;var e=b.scrollLeft||j.scrollLeft||0,b=b.scrollTop||j.scrollTop||0,h=!1,i=window.innerWidth||j.clientWidth||0;if(c||g<i){if(c){var k=select.offsetInNode(a),
t=nodeText(a).length;t&&(d+=g*(k/t))}g=d-e;if(0>g||g>i)e=d,h=!0}d=f-b;if(0>d||C||d>(window.innerHeight||j.clientHeight||0)-50)b=C?1E6:f,h=!0;h&&window.scrollTo(e,b)}}};select.scrollToCursor=function(a){select.scrollToNode(select.selectionTopNode(a,!0)||a.firstChild,!0)};var i=null;select.snapshotChanged=function(){i&&(i.changed=!0)};select.snapshotReplaceNode=function(a,c,e,b){function j(j){a==j.node?(i.changed=!0,e&&j.offset>e?j.offset-=e:(j.node=c,j.offset+=b||0)):select.ie_selection&&(0==j.offset&&
j.node==g(a))&&(i.changed=!0)}i&&(j(i.start),j(i.end))};select.snapshotMove=function(a,c,e,b,j){function f(d){if(a==d.node&&(!j||0==d.offset))i.changed=!0,d.node=c,d.offset=b?Math.max(0,d.offset+e):e}i&&(f(i.start),f(i.end))};if(select.ie_selection){var h=function(a){function c(a){for(var l=null;!l&&a;)l=a.nextSibling,a=a.parentNode;return e(l)}function e(a){for(;a&&a.firstChild;)a=a.firstChild;return{node:a,offset:0}}var b=document.selection.createRange();b.collapse(a);a=b.parentElement();if(!isAncestor(document.body,
a))return null;if(!a.firstChild)return e(a);var j=b.duplicate();j.moveToElementText(a);j.collapse(!0);for(var f=a.firstChild;f;f=f.nextSibling){if(3==f.nodeType){var d=f.nodeValue.length;j.move("character",d)}else j.moveToElementText(f),j.collapse(!1);var g=b.compareEndPoints("StartToStart",j);if(0==g)return c(f);if(1!=g){if(3!=f.nodeType)return e(f);j.setEndPoint("StartToEnd",b);return{node:f,offset:d-j.text.length}}}return c(a)};select.markSelection=function(){i=null;if(document.selection){var a=
h(!0),c=h(!1);a&&c&&(i={start:a,end:c,changed:!1})}};select.selectMarked=function(){function a(c){var l=document.body.createTextRange(),e=c.node;if(e)if(3==e.nodeType){l.moveToElementText(e.parentNode);for(c=c.offset;e.previousSibling;)e=e.previousSibling,c+=(e.innerText||"").length;l.move("character",c)}else l.moveToElementText(e),l.collapse(!0);else l.moveToElementText(document.body),l.collapse(!1);return l}if(i&&i.changed){var c=a(i.start),e=a(i.end);c.setEndPoint("StartToEnd",e);c.select()}};
select.offsetInNode=function(a){var c=document.selection;if(!c)return 0;var c=c.createRange(),e=c.duplicate();try{e.moveToElementText(a)}catch(b){return 0}c.setEndPoint("StartToStart",e);return c.text.length};select.selectionTopNode=function(a,c){var e=document.selection;if(!e)return!1;var f=e.createRange(),j=f.duplicate();f.collapse(c);var d=f.parentElement();if(d&&isAncestor(a,d)&&(j.moveToElementText(d),1==f.compareEndPoints("StartToStart",j)))return b(d,a);c=0;for(d=a.childNodes.length-1;c<d;){var g=
Math.ceil((d+c)/2),h=a.childNodes[g];if(!h)return!1;var i;a:{i=j;if(3==h.nodeType){for(var k=0,p=h.previousSibling;p&&3==p.nodeType;)k+=p.nodeValue.length,p=p.previousSibling;if(p){try{i.moveToElementText(p)}catch(s){i=!1;break a}i.collapse(!1)}else i.moveToElementText(h.parentNode);k&&i.move("character",k)}else try{i.moveToElementText(h)}catch(t){i=!1;break a}i=!0}if(!i)return!1;1==f.compareEndPoints("StartToStart",j)?c=g:d=g-1}if(0==c){e=e.createRange();f=e.duplicate();try{f.moveToElementText(a)}catch(x){return null}if(0==
e.compareEndPoints("StartToStart",f))return null}return a.childNodes[c]||null};select.focusAfterNode=function(a,c){var e=document.body.createTextRange();e.moveToElementText(a||c);e.collapse(!a);e.select()};select.somethingSelected=function(){var a=document.selection;return a&&""!=a.createRange().text};var k=function(a){var c=document.selection;c&&(c=c.createRange(),c.pasteHTML(a),c.collapse(!1),c.select())};select.insertNewlineAtCursor=function(){k("<br>")};select.insertTabAtCursor=function(){k("\u00a0\u00a0\u00a0\u00a0")};
select.cursorPos=function(a,c){var e=document.selection;if(!e)return null;for(var b=select.selectionTopNode(a,c);b&&!isBR(b);)b=b.previousSibling;var e=e.createRange(),j=e.duplicate();e.collapse(c);if(b)j.moveToElementText(b),j.collapse(!1);else{try{j.moveToElementText(a)}catch(f){return null}j.collapse(!0)}e.setEndPoint("StartToStart",j);return{node:b,offset:e.text.length}};select.setCursorPos=function(a,c,e){function b(c){var e=document.body.createTextRange();c.node?(e.moveToElementText(c.node),
e.collapse(!1)):(e.moveToElementText(a),e.collapse(!0));e.move("character",c.offset);return e}var j=b(c);e&&e!=c&&j.setEndPoint("EndToEnd",b(e));j.select()};select.getBookmark=function(a){var c=select.cursorPos(a,!0),a=select.cursorPos(a,!1);if(c&&a)return{from:c,to:a}};select.setBookmark=function(a,c){c&&select.setCursorPos(a,c.from,c.to)}}else{var f=function(a,c){for(;3!=a.nodeType&&!isBR(a);){for(var e=a.childNodes[c]||a.nextSibling,c=0;!e&&a.parentNode;)a=a.parentNode,e=a.nextSibling;a=e;if(!e)break}return{node:a,
offset:c}};select.markSelection=function(){var a=window.getSelection();if(!a||0==a.rangeCount)return i=null;a=a.getRangeAt(0);i={start:f(a.startContainer,a.startOffset),end:f(a.endContainer,a.endOffset),changed:!1}};select.selectMarked=function(){function c(a,e){if(a.node)if(0==a.offset)d["set"+e+"Before"](a.node);else d["set"+e](a.node,a.offset);else d.setStartAfter(document.body.lastChild||document.body)}var b=i,e;if(!(e=!b)){if(!(e=b.changed))if(e=webkit)b.start.node==b.end.node&&b.start.offset==
b.end.offset?(e=window.getSelection(),!e||0==e.rangeCount?e=!0:(e=e.getRangeAt(0),e=f(e.startContainer,e.startOffset),e=b.start.node!=e.node||b.start.offset!=e.offset)):e=void 0;e=!e}if(!e){var d=document.createRange();c(b.end,"End");c(b.start,"Start");a(d)}};var a=function(a){var c=window.getSelection();c&&(c.removeAllRanges(),c.addRange(a))},c=function(){var a=window.getSelection();return!a||0==a.rangeCount?!1:a.getRangeAt(0)};select.selectionTopNode=function(a,m){var e=c();if(!e)return!1;var f=
m?e.startContainer:e.endContainer,j=m?e.startOffset:e.endOffset;window.opera&&(!m&&e.endContainer==a&&e.endOffset==e.startOffset+1&&a.childNodes[e.startOffset]&&isBR(a.childNodes[e.startOffset]))&&j--;return 3==f.nodeType?0<j?b(f,a):d(f,a):"HTML"==f.nodeName.toUpperCase()?1==j?null:a.lastChild:f==a?0==j?null:f.childNodes[j-1]:j==f.childNodes.length?b(f,a):0==j?d(f,a):b(f.childNodes[j-1],a)};select.focusAfterNode=function(c,b){var e=document.createRange();e.setStartBefore(b.firstChild||b);c&&!c.firstChild?
e.setEndAfter(c):c?e.setEnd(c,c.childNodes.length):e.setEndBefore(b.firstChild||b);e.collapse(!1);a(e)};select.somethingSelected=function(){var a=c();return a&&!a.collapsed};select.offsetInNode=function(a){var b=c();if(!b)return 0;b=b.cloneRange();b.setStartBefore(a);return b.toString().length};select.insertNodeAtCursor=function(b){var m=c();if(m){m.deleteContents();m.insertNode(b);webkitLastLineHack(document.body);if(window.opera&&isBR(b)&&isSpan(b.parentNode)){var m=b.nextSibling,e=b.parentNode,
f=e.parentNode;f.insertBefore(b,e.nextSibling);for(e="";m&&3==m.nodeType;m=m.nextSibling)e+=m.nodeValue,removeElement(m);f.insertBefore(makePartSpan(e,document),b.nextSibling)}m=document.createRange();m.selectNode(b);m.collapse(!1);a(m)}};select.insertNewlineAtCursor=function(){select.insertNodeAtCursor(document.createElement("BR"))};select.insertTabAtCursor=function(){select.insertNodeAtCursor(document.createTextNode("\u00a0\u00a0\u00a0\u00a0"))};select.cursorPos=function(a,b){var e=c();if(e){for(var f=
select.selectionTopNode(a,b);f&&!isBR(f);)f=f.previousSibling;e=e.cloneRange();e.collapse(b);f?e.setStartAfter(f):e.setStartBefore(a);return{node:f,offset:e.toString().length}}};select.setCursorPos=function(c,b,e){function f(a,e,b){function m(a){3==a.nodeType?d.push(a):forEach(a.childNodes,m)}if(0==e&&a&&!a.nextSibling)return j["set"+b+"After"](a),!0;if(a=a?a.nextSibling:c.firstChild){if(0==e)return j["set"+b+"Before"](a),!0;for(var d=[];;){for(;a&&!d.length;)m(a),a=a.nextSibling;var g=d.shift();
if(!g)return!1;var h=g.nodeValue.length;if(h>=e)return j["set"+b](g,e),!0;e-=h}}}var j=document.createRange(),e=e||b;f(e.node,e.offset,"End")&&f(b.node,b.offset,"Start")&&a(j)}}})();function UndoHistory(b,d,g,i){this.container=b;this.maxDepth=d;this.commitDelay=g;this.editor=i;this.parent=i.parent;this.last=this.first=b={text:"",from:null,to:null};this.firstTouched=!1;this.history=[];this.redoHistory=[];this.touched=[]}
UndoHistory.prototype={scheduleCommit:function(){var b=this;this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(function(){b.tryCommit()},this.commitDelay)},touch:function(b){this.setTouched(b);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var b=this.history.pop();this.redoHistory.push(this.updateTo(b,"applyChain"));this.notifyEnvironment();return this.chainNode(b)}},redo:function(){this.commit();if(this.redoHistory.length){var b=this.redoHistory.pop();
this.addUndoLevel(this.updateTo(b,"applyChain"));this.notifyEnvironment();return this.chainNode(b)}},clear:function(){this.history=[];this.redoHistory=[]},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length}},push:function(b,d,g){for(var i=[],h=0;h<g.length;h++){var k=h==g.length-1?d:this.container.ownerDocument.createElement("BR");i.push({from:b,to:k,text:cleanText(g[h])});b=k}this.pushChains([i],null==b&&null==d);this.notifyEnvironment()},pushChains:function(b,d){this.commit(d);
this.addUndoLevel(this.updateTo(b,"applyChain"));this.redoHistory=[]},chainNode:function(b){for(var d=0;d<b.length;d++){var g=b[d][0];if(g=g&&(g.from||g.to))return g}},reset:function(){this.history=[];this.redoHistory=[]},textAfter:function(b){return this.after(b).text},nodeAfter:function(b){return this.after(b).to},nodeBefore:function(b){return this.before(b).from},tryCommit:function(){window.parent&&window.UndoHistory&&(this.editor.highlightDirty()?this.commit(!0):this.scheduleCommit())},commit:function(b){this.parent.clearTimeout(this.commitTimeout);
b||this.editor.highlightDirty(!0);b=this.touchedChains();b.length&&(this.addUndoLevel(this.updateTo(b,"linkChain")),this.redoHistory=[],this.notifyEnvironment())},updateTo:function(b,d){for(var g=[],i=[],h=0;h<b.length;h++)g.push(this.shadowChain(b[h])),i.push(this[d](b[h]));"applyChain"==d&&this.notifyDirty(i);return g},notifyDirty:function(b){forEach(b,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},notifyEnvironment:function(){if(this.onChange)this.onChange();window.frameElement&&
window.frameElement.CodeMirror.updateNumbers&&window.frameElement.CodeMirror.updateNumbers()},linkChain:function(b){for(var d=0;d<b.length;d++){var g=b[d];g.from?g.from.historyAfter=g:this.first=g;g.to?g.to.historyBefore=g:this.last=g}},after:function(b){return b?b.historyAfter:this.first},before:function(b){return b?b.historyBefore:this.last},setTouched:function(b){b?b.historyTouched||(this.touched.push(b),b.historyTouched=!0):this.firstTouched=!0},addUndoLevel:function(b){this.history.push(b);this.history.length>
this.maxDepth&&this.history.shift()},touchedChains:function(){function b(b){for(var a=[],c=b?b.nextSibling:g.container.firstChild;c&&(!isBR(c)||c.hackBR);c=c.nextSibling)!c.hackBR&&c.currentText&&a.push(c.currentText);return{from:b,to:c,text:cleanText(a.join(""))}}function d(b,a){for(var c=a+"Sibling",l=b[c];l&&!isBR(l);)l=l[c];return l}var g=this,i=null,h=[];g.firstTouched&&g.touched.push(null);forEach(g.touched,function(f){if(!f||!(f.parentNode!=g.container||f.hackBR)){f?f.historyTouched=!1:g.firstTouched=
!1;var a=b(f),c=g.after(f);if(!c||c.text!=a.text||c.to!=a.to)h.push(a),f?f.historyTemp=a:i=a}});var k=[];g.touched=[];forEach(h,function(f){if(f.from?f.from.historyTemp:i){for(var a=[],c=f.from,l=!0;;){var m=c?c.historyTemp:i;if(!m)if(l)break;else m=b(c);a.unshift(m);c?c.historyTemp=null:i=null;if(!c)break;l=g.after(c);c=d(c,"previous")}c=f.to;for(l=g.before(f.from);c;){m=c?c.historyTemp:i;if(!m)if(l)break;else m=b(c);a.push(m);c?c.historyTemp=null:i=null;l=g.before(c);c=d(c,"next")}k.push(a)}});
return k},shadowChain:function(b){for(var d=[],g=this.after(b[0].from),b=b[b.length-1].to;!(d.push(g),g=g.to,!g||g==b);)g=g.historyAfter||this.before(b);return d},applyChain:function(b){for(var d=select.cursorPos(this.container,!1),g=b[0].from,i=b[b.length-1].to,h=g?g.nextSibling:this.container.firstChild;h!=i;){var k=h.nextSibling;removeElement(h);h=k}for(h=0;h<b.length;h++){k=b[h];0<h&&this.container.insertBefore(k.from,i);var f=makePartSpan(fixSpaces(k.text));this.container.insertBefore(f,i);if(d&&
d.node==k.from){var f=0,a=this.after(k.from);if(a&&h==b.length-1){for(var c=0;c<d.offset&&k.text.charAt(c)==a.text.charAt(c);c++);d.offset>c&&(f=k.text.length-a.text.length)}select.setCursorPos(this.container,{node:k.from,offset:Math.max(0,d.offset+f)})}else d&&(h==b.length-1&&d.node&&d.node.parentNode!=this.container)&&select.setCursorPos(this.container,{node:k.from,offset:k.text.length})}this.linkChain(b);return g}};
var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent),webkit=/AppleWebKit/.test(navigator.userAgent),safari=/Apple Computer, Inc/.test(navigator.vendor),gecko=navigator.userAgent.match(/gecko\/(\d{8})/i);gecko&&(gecko=Number(gecko[1]));var mac=/Mac/.test(navigator.platform),brokenOpera=window.opera&&/Version\/10.[56]/.test(navigator.userAgent),slowWebkit=/AppleWebKit\/533/.test(navigator.userAgent);
function makeWhiteSpace(b){for(var d=[],g=!0;0<b;b--)d.push(g||1==b?nbsp:" "),g^=1;return d.join("")}function fixSpaces(b){" "==b.charAt(0)&&(b=nbsp+b.slice(1));return b.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(b){return makeWhiteSpace(b.length)})}function cleanText(b){return b.replace(/\u00a0/g," ").replace(/\u200b/g,"")}
function makePartSpan(b){var d=b;3==b.nodeType?d=b.nodeValue:b=document.createTextNode(d);var g=document.createElement("SPAN");g.isPart=!0;g.appendChild(b);g.currentText=d;return g}
var webkitLastLineHack=webkit?function(b){var d=b.lastChild;if(!d||!d.hackBR)d=document.createElement("BR"),d.hackBR=!0,b.appendChild(d)}:function(){},Editor=function(){function b(a){var c=makeWhiteSpace(indentUnit);return map(a.replace(/\t/g,c).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function d(a){var c=[],b=null,m=!0;return{next:function(){if(!a)throw StopIteration;var e=a;a=e.nextSibling;var d;e.isPart&&1==e.childNodes.length&&3==e.firstChild.nodeType?(e.currentText=
e.firstChild.nodeValue,d=!/[\n\t\r]/.test(e.currentText)):d=!1;if(d)return c.push(e),m=!1,e.currentText;if(isBR(e))return m&&window.opera&&e.parentNode.insertBefore(makePartSpan(""),e),c.push(e),m=!0,"\n";var j=!e.nextSibling,g=e.parentNode,h=e.nextSibling;b=function(a){g.insertBefore(a,h)};removeElement(e);var i=function(a,c){if(a.nodeType==3){if((a.nodeValue=fixSpaces(a.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "))).length)o=false;k.push(a)}else if(isBR(a)&&a.childNodes.length==0){o=true;
k.push(a)}else{for(var e=a.firstChild;e;e=e.nextSibling)i(e);if(!o&&f.hasOwnProperty(a.nodeName.toUpperCase())){o=true;(!j||!c)&&k.push(document.createElement("BR"))}}},k=[],o=!0;i(e,!0);e=k;for(d=0;d<e.length;d++){var p=e,s=d,t=e[d],x="\n";3==t.nodeType?(select.snapshotChanged(),t=makePartSpan(t),x=t.currentText,m=!1):(m&&window.opera&&b(makePartSpan("")),m=!0);t.dirty=!0;c.push(t);b(t);p[s]=x}return e.join("")},nodes:c}}function g(a){for(;a&&!isBR(a);)a=a.previousSibling;return a}function i(a,c){a?
isBR(a)&&(a=a.nextSibling):a=c.firstChild;for(;a&&!isBR(a);)a=a.nextSibling;return a}function h(a,c,b,f){function e(c){c=cleanText(a.history.textAfter(c));return f?c.toLowerCase():c}this.editor=a;this.history=a.history;this.history.commit();this.valid=!!c;this.atOccurrence=!1;void 0==f&&(f=c==c.toLowerCase());var d={node:null,offset:0};b&&"object"==typeof b&&"number"==typeof b.character?(a.checkLine(b.line),b={node:b.line,offset:b.character},this.pos={from:b,to:b}):this.pos=b?{from:select.cursorPos(a.container,
!0)||d,to:select.cursorPos(a.container,!1)||d}:{from:d,to:d};f&&(c=c.toLowerCase());var j=c.split("\n");this.matches=1==j.length?function(a,b,f){var l=e(b),m=c.length,j;if(a?f>=m&&(j=l.lastIndexOf(c,f-m))!=-1:(j=l.indexOf(c,f))!=-1)return{from:{node:b,offset:j},to:{node:b,offset:j+m}}}:function(a,c,b){var f=a?j.length-1:0,l=j[f],m=e(c),d=a?m.indexOf(l)+l.length:m.lastIndexOf(l);if(!(a?d>=b||d!=l.length:d<=b||d!=m.length-l.length))for(b=c;;){if(a&&!b)break;b=a?this.history.nodeBefore(b):this.history.nodeAfter(b);
if(!a&&!b)break;m=e(b);l=j[a?--f:++f];if(f>0&&f<j.length-1)if(m!=l)break;else continue;f=a?m.lastIndexOf(l):m.indexOf(l)+l.length;if(a?f!=m.length-l.length:f!=l.length)break;return{from:{node:a?b:c,offset:a?f:d},to:{node:a?c:b,offset:a?d:f}}}}}function k(a){this.options=a;window.indentUnit=a.indentUnit;this.parent=parent;var c=this.container=document.body;this.history=new UndoHistory(c,a.undoDepth,a.undoDelay,this);var b=this;if(!k.Parser)throw"No parser loaded.";a.parserConfig&&k.Parser.configure&&
k.Parser.configure(a.parserConfig);a.readOnly||select.setCursorPos(c,{node:null,offset:0});this.dirty=[];this.importCode(a.content||"");this.history.onChange=a.onChange;if(a.readOnly)a.textWrapping||(c.style.whiteSpace="nowrap");else{!1!==a.continuousScanning&&(this.scanner=this.documentScanner(a.passTime),this.delayScanning());var f=function(){document.body.contentEditable!=void 0&&internetExplorer?document.body.contentEditable="true":document.designMode="on";if(internetExplorer&&a.height!="dynamic")document.body.style.minHeight=
frameElement.clientHeight-2*document.body.offsetTop-5+"px";document.documentElement.style.borderWidth="0";if(!a.textWrapping)c.style.whiteSpace="nowrap"};try{f()}catch(e){var d=addEventHandler(document,"focus",function(){d();f()},!0)}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));var j=function(){b.cursorActivity(false)};addEventHandler(document.body,"mouseup",j);addEventHandler(document.body,
"cut",j);gecko&&addEventHandler(window,"pagehide",function(){b.unloaded=true});addEventHandler(document.body,"paste",function(a){j();var c=null;try{var e=a.clipboardData||window.clipboardData;e&&(c=e.getData("Text"))}catch(f){}if(c!==null){a.stop();b.replaceSelection(c);select.scrollToCursor(b.container)}});this.options.autoMatchParens&&addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}}var f={P:!0,DIV:!0,LI:!0};h.prototype={findNext:function(){return this.find(!1)},findPrevious:function(){return this.find(!0)},
find:function(a){function c(){var a={node:e,offset:d};b.pos={from:a,to:a};return b.atOccurrence=!1}if(!this.valid)return!1;var b=this,f=a?this.pos.from:this.pos.to,e=f.node,d=f.offset;e&&!e.parentNode&&(e=null,d=0);for(;;){if(this.pos=this.matches(a,e,d))return this.atOccurrence=!0;if(a){if(!e)return c();e=this.history.nodeBefore(e);d=this.history.textAfter(e).length}else{f=this.history.nodeAfter(e);if(!f)return d=this.history.textAfter(e).length,c();e=f;d=0}}},select:function(){this.atOccurrence&&
(select.setCursorPos(this.editor.container,this.pos.from,this.pos.to),select.scrollToCursor(this.editor.container))},replace:function(a){this.atOccurrence&&(a=this.editor.replaceRange(this.pos.from,this.pos.to,a),this.pos.to=a,this.atOccurrence=!1)},position:function(){if(this.atOccurrence)return{line:this.pos.from.node,character:this.pos.from.offset}}};k.prototype={importCode:function(a){this.history.push(null,null,b(a));this.history.reset()},getCode:function(){if(!this.container.firstChild)return"";
var a=[];select.markSelection();forEach(d(this.container.firstChild),method(a,"push"));webkitLastLineHack(this.container);select.selectMarked();webkit&&this.container.lastChild.hackBR&&a.pop();return cleanText(a.join(""))},checkLine:function(a){if(!1===a||!(null==a||a.parentNode==this.container))throw parent.CodeMirror.InvalidLineHandle;},cursorPosition:function(a){null==a&&(a=!0);return(a=select.cursorPos(this.container,a))?{line:a.node,character:a.offset}:{line:null,character:0}},firstLine:function(){return null},
lastLine:function(){return this.container.lastChild?g(this.container.lastChild):null},nextLine:function(a){this.checkLine(a);return i(a,this.container)||!1},prevLine:function(a){this.checkLine(a);return null==a?!1:g(a.previousSibling)},visibleLineCount:function(){for(var a=this.container.firstChild;a&&isBR(a);)a=a.nextSibling;return!a?!1:Math.floor((window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight)/a.offsetHeight)},selectLines:function(a,c,b,f){this.checkLine(a);
a={node:a,offset:c};c=null;void 0!==f&&(this.checkLine(b),c={node:b,offset:f});select.setCursorPos(this.container,a,c);select.scrollToCursor(this.container)},lineContent:function(a){for(var c=[],a=a?a.nextSibling:this.container.firstChild;a&&!isBR(a);a=a.nextSibling)c.push(nodeText(a));return cleanText(c.join(""))},setLineContent:function(a,c){this.history.commit();this.replaceRange({node:a,offset:0},{node:a,offset:this.history.textAfter(a).length},c);this.addDirtyNode(a);this.scheduleHighlight()},
removeLine:function(a){for(var c=a?a.nextSibling:this.container.firstChild;c;){var b=c.nextSibling;removeElement(c);if(isBR(c))break;c=b}this.addDirtyNode(a);this.scheduleHighlight()},insertIntoLine:function(a,c,f){var d=null;if("end"==c)d=i(a,this.container);else for(var e=a?a.nextSibling:this.container.firstChild;e;e=e.nextSibling){if(0==c){d=e;break}var g=nodeText(e);if(g.length>c){d=e.nextSibling;f=g.slice(0,c)+f+g.slice(c);removeElement(e);break}c-=g.length}c=b(f);for(f=0;f<c.length;f++)0<f&&
this.container.insertBefore(document.createElement("BR"),d),this.container.insertBefore(makePartSpan(c[f]),d);this.addDirtyNode(a);this.scheduleHighlight()},selectedText:function(){var a=this.history;a.commit();var c=select.cursorPos(this.container,!0),b=select.cursorPos(this.container,!1);if(!c||!b)return"";if(c.node==b.node)return a.textAfter(c.node).slice(c.offset,b.offset);for(var f=[a.textAfter(c.node).slice(c.offset)],c=a.nodeAfter(c.node);c!=b.node;c=a.nodeAfter(c))f.push(a.textAfter(c));f.push(a.textAfter(b.node).slice(0,
b.offset));return cleanText(f.join("\n"))},replaceSelection:function(a){this.history.commit();var c=select.cursorPos(this.container,!0),b=select.cursorPos(this.container,!1);c&&b&&(b=this.replaceRange(c,b,a),select.setCursorPos(this.container,b),webkitLastLineHack(this.container))},cursorCoords:function(a){function c(a,c){var b=-(document.body.scrollTop||document.documentElement.scrollTop||0),e=-(document.body.scrollLeft||document.documentElement.scrollLeft||0)+c;forEach([a,window.frameElement],function(a){for(;a;)e+=
a.offsetLeft,b+=a.offsetTop,a=a.offsetParent});return{x:e,y:b,yBot:b+a.offsetHeight}}function b(a,c){var e=document.createElement("SPAN");e.appendChild(document.createTextNode(a));try{return c(e)}finally{e.parentNode&&e.parentNode.removeChild(e)}}var f=select.cursorPos(this.container,a);if(!f)return null;for(var a=f.offset,e=f.node,d=this;a;){e=e?e.nextSibling:this.container.firstChild;f=nodeText(e);if(a<f.length)return b(f.substr(0,a),function(a){a.style.position="absolute";a.style.visibility="hidden";
a.className=e.className;d.container.appendChild(a);return c(e,a.offsetWidth)});a-=f.length}return e&&isSpan(e)?c(e,e.offsetWidth):e&&e.nextSibling&&isSpan(e.nextSibling)?c(e.nextSibling,0):b("\u200b",function(a){e?e.parentNode.insertBefore(a,e.nextSibling):d.container.insertBefore(a,d.container.firstChild);return c(a,0)})},reroutePasteEvent:function(){if(!this.capturingPaste&&!(window.opera||gecko&&20101026<=gecko)){this.capturingPaste=!0;var a=window.frameElement.CodeMirror.textareaHack;parent.focus();
a.value="";a.focus();var c=this;this.parent.setTimeout(function(){c.capturingPaste=!1;window.focus();c.selectionSnapshot&&window.select.setBookmark(c.container,c.selectionSnapshot);var b=a.value;b&&(c.replaceSelection(b),select.scrollToCursor(c.container))},10)}},replaceRange:function(a,c,f){f=b(f);f[0]=this.history.textAfter(a.node).slice(0,a.offset)+f[0];var d=f[f.length-1];f[f.length-1]=d+this.history.textAfter(c.node).slice(c.offset);c=this.history.nodeAfter(c.node);this.history.push(a.node,c,
f);return{node:this.history.nodeBefore(c),offset:d.length}},getSearchCursor:function(a,c,b){return new h(this,a,c,b)},reindent:function(){this.container.firstChild&&this.indentRegion(null,this.container.lastChild)},reindentSelection:function(a){if(select.somethingSelected()){var c=select.selectionTopNode(this.container,!0),b=select.selectionTopNode(this.container,!1);!1===c||!1===b||this.indentRegion(c,b,a)}else this.indentAtCursor(a)},grabKeys:function(a,c){this.frozen=a;this.keyFilter=c},ungrabKeys:function(){this.frozen=
"leave"},setParser:function(a,c){k.Parser=window[a];(c=c||this.options.parserConfig)&&k.Parser.configure&&k.Parser.configure(c);this.container.firstChild&&(forEach(this.container.childNodes,function(a){3!=a.nodeType&&(a.dirty=!0)}),this.addDirtyNode(this.firstChild),this.scheduleHighlight())},keyDown:function(a){"leave"==this.frozen&&(this.keyFilter=this.frozen=null);if(this.frozen&&(!this.keyFilter||this.keyFilter(a.keyCode,a)))a.stop(),this.frozen(a);else{var c=a.keyCode;this.delayScanning();this.options.autoMatchParens&&
this.scheduleParenHighlight();if(13==c)a.ctrlKey&&!a.altKey?this.reparseBuffer():(select.insertNewlineAtCursor(),c=this.options.enterMode,"flat"!=c&&this.indentAtCursor("keep"==c?"keep":void 0),select.scrollToCursor(this.container)),a.stop();else if(9==c&&"default"!=this.options.tabMode&&!a.ctrlKey)this.handleTab(!a.shiftKey),a.stop();else if(32==c&&a.shiftKey&&"default"==this.options.tabMode)this.handleTab(!0),a.stop();else if(36==c&&!a.shiftKey&&!a.ctrlKey)this.home()&&a.stop();else if(35==c&&!a.shiftKey&&
!a.ctrlKey)this.end()&&a.stop();else if(33==c&&!a.shiftKey&&!a.ctrlKey&&!gecko)this.pageUp()&&a.stop();else if(34==c&&!a.shiftKey&&!a.ctrlKey&&!gecko)this.pageDown()&&a.stop();else if((219==c||221==c)&&a.ctrlKey&&!a.altKey)this.highlightParens(a.shiftKey,!0),a.stop();else if(a.metaKey&&!a.shiftKey&&(37==c||39==c)){var b=select.selectionTopNode(this.container);!1!==b&&this.container.firstChild&&(37==c?select.focusAfterNode(g(b),this.container):(c=i(b,this.container),select.focusAfterNode(c?c.previousSibling:
this.container.lastChild,this.container)),a.stop())}else if((a.ctrlKey||a.metaKey)&&!a.altKey)a.shiftKey&&90==c||89==c?(select.scrollToNode(this.history.redo()),a.stop()):90==c||safari&&8==c?(select.scrollToNode(this.history.undo()),a.stop()):83==c&&this.options.saveFunction?(this.options.saveFunction(),a.stop()):86==c&&!mac&&this.reroutePasteEvent()}},keyPress:function(a){var c=this.options.electricChars&&k.Parser.electricChars,b=this;if(this.frozen&&(!this.keyFilter||this.keyFilter(a.keyCode||a.code,
a))||13==a.code||9==a.code&&"default"!=this.options.tabMode||32==a.code&&a.shiftKey&&"default"==this.options.tabMode)a.stop();else if(mac&&(a.ctrlKey||a.metaKey)&&"v"==a.character)this.reroutePasteEvent();else if(c&&-1!=c.indexOf(a.character))this.parent.setTimeout(function(){b.indentAtCursor(null)},0);else if(brokenOpera)if(8==a.code){var f=select.selectionTopNode(this.container),b=this,e=f?f.nextSibling:this.container.firstChild;!1!==f&&(e&&isBR(e))&&this.parent.setTimeout(function(){select.selectionTopNode(b.container)==
e&&select.focusAfterNode(e.previousSibling,b.container)},20)}else 46==a.code&&(f=select.selectionTopNode(this.container),b=this,f&&isBR(f)&&this.parent.setTimeout(function(){select.selectionTopNode(b.container)!=f&&select.focusAfterNode(f,b.container)},20));else if(slowWebkit&&(e=(f=select.selectionTopNode(this.container))?f.nextSibling:this.container.firstChild,f&&e&&isBR(e)&&!isBR(f))){var d=document.createTextNode("\u200b");this.container.insertBefore(d,e);this.parent.setTimeout(function(){"\u200b"==
d.nodeValue?removeElement(d):d.nodeValue=d.nodeValue.replace("\u200b","")},20)}webkit&&!this.options.textWrapping&&setTimeout(function(){var a=select.selectionTopNode(b.container,!0);a&&(3==a.nodeType&&a.previousSibling&&isBR(a.previousSibling)&&a.nextSibling&&isBR(a.nextSibling))&&a.parentNode.replaceChild(document.createElement("BR"),a.previousSibling)},50)},keyUp:function(a){this.cursorActivity(16<=a.keyCode&&18>=a.keyCode||33<=a.keyCode&&40>=a.keyCode)},indentLineAfter:function(a,c){function b(a){a=
a?a.nextSibling:f.container.firstChild;return!a||!hasClass(a,"whitespace")?null:a}var f=this,e=b(a),d=0,j=e?e.currentText.length:0,h=e?e.nextSibling:a?a.nextSibling:this.container.firstChild;if("keep"==c){if(a){var i=b(g(a.previousSibling));i&&(d=i.currentText.length)}}else i=a&&h&&h.currentText?h.currentText:"",null!=c&&"shift"==this.options.tabMode?d=c?j+indentUnit:Math.max(0,j-indentUnit):a?d=a.indentation(i,j,c):k.Parser.firstIndentation&&(d=k.Parser.firstIndentation(i,j,c));j=d-j;0>j?0==d?(h&&
select.snapshotMove(e.firstChild,h.firstChild||h,0),removeElement(e),e=null):(select.snapshotMove(e.firstChild,e.firstChild,j,!0),e.currentText=makeWhiteSpace(d),e.firstChild.nodeValue=e.currentText):0<j?e?(e.currentText=makeWhiteSpace(d),e.firstChild.nodeValue=e.currentText,select.snapshotMove(e.firstChild,e.firstChild,j,!0)):(e=makePartSpan(makeWhiteSpace(d)),e.className="whitespace",a?insertAfter(e,a):this.container.insertBefore(e,this.container.firstChild),select.snapshotMove(h&&(h.firstChild||
h),e.firstChild,d,!1,!0)):e&&select.snapshotMove(e.firstChild,e.firstChild,d,!1);0!=j&&this.addDirtyNode(a)},highlightAtCursor:function(){var a=select.selectionTopNode(this.container,!0),c=select.selectionTopNode(this.container,!1);if(!1===a||!1===c)return!1;select.markSelection();if(!1===this.highlight(a,i(c,this.container),!0,20))return!1;select.selectMarked();return!0},handleTab:function(a){"spaces"==this.options.tabMode?select.insertTabAtCursor():this.reindentSelection(a)},home:function(){var a=
select.selectionTopNode(this.container,!0),c=a;if(!1===a||a&&!a.isPart&&!isBR(a)||!this.container.firstChild)return!1;for(;a&&!isBR(a);)a=a.previousSibling;var b=a?a.nextSibling:this.container.firstChild;b&&b!=c&&b.isPart&&hasClass(b,"whitespace")?select.focusAfterNode(b,this.container):select.focusAfterNode(a,this.container);select.scrollToCursor(this.container);return!0},end:function(){var a=select.selectionTopNode(this.container,!0);if(!1===a)return!1;a=i(a,this.container);if(!a)return!1;select.focusAfterNode(a.previousSibling,
this.container);select.scrollToCursor(this.container);return!0},pageUp:function(){var a=this.cursorPosition().line,c=this.visibleLineCount();if(!1===a||!1===c)return!1;for(var c=c-2,b=0;b<c&&!(a=this.prevLine(a),!1===a);b++);if(0==b)return!1;select.setCursorPos(this.container,{node:a,offset:0});select.scrollToCursor(this.container);return!0},pageDown:function(){var a=this.cursorPosition().line,c=this.visibleLineCount();if(!1===a||!1===c)return!1;for(var c=c-2,b=0;b<c;b++){var f=this.nextLine(a);if(!1===
f)break;a=f}if(0==b)return!1;select.setCursorPos(this.container,{node:a,offset:0});select.scrollToCursor(this.container);return!0},scheduleParenHighlight:function(){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);var a=this;this.parenEvent=this.parent.setTimeout(function(){a.highlightParens()},300)},highlightParens:function(a,b){var f,d;function e(a,b){a&&(h.options.markParen?h.options.markParen(a,b):(a.style.fontWeight="bold",a.style.color=b?"#8F8":"#F88"))}function g(a){a&&(h.options.unmarkParen?
h.options.unmarkParen(a):(a.style.fontWeight="",a.style.color=""))}function j(a){if(a.currentText)return(a=a.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/))&&a[1]}var h=this;!b&&h.highlighted&&(g(h.highlighted[0]),g(h.highlighted[1]));if(window.parent&&window.select){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);this.parenEvent=null;var k,n=select.selectionTopNode(this.container,!0);if(n&&this.highlightAtCursor()&&(n=select.selectionTopNode(this.container,!0))&&((k=j(n))||
(n=n.nextSibling)&&(k=j(n)))){var q=n.className;for(k=/[\(\[\{]/.test(k);;){a:{d=[];for(var o=void 0,p=!0,s=n;s;s=k?s.nextSibling:s.previousSibling)if(s.className==q&&isSpan(s)&&(o=j(s))){if(/[\(\[\{]/.test(o)==k?d.push(o):d.length?d.pop()!=matching[o]&&(p=!1):p=!1,!d.length)break}else if(s.dirty||!isSpan(s)&&!isBR(s)){f=s;d="dirty";break a}d=(f=s)&&p}if("dirty"==d)this.highlight(f,i(f)),f.dirty=!1;else{e(n,d);e(f,d);b?h.parent.setTimeout(function(){g(n);g(f)},500):h.highlighted=[n,f];a&&f&&select.focusAfterNode(f.previousSibling,
this.container);break}}}}},indentAtCursor:function(a){if(this.container.firstChild&&this.highlightAtCursor()){var b=select.selectionTopNode(this.container,!1);!1!==b&&(select.markSelection(),this.indentLineAfter(g(b),a),select.selectMarked())}},indentRegion:function(a,b,f){var d=a=g(a),e=a&&g(a.previousSibling);isBR(b)||(b=i(b,this.container));this.addDirtyNode(a);do{var h=i(d,this.container);d&&this.highlight(e,h,!0);this.indentLineAfter(d,f);e=d;d=h}while(d!=b);select.setCursorPos(this.container,
{node:a,offset:0},{node:b,offset:0})},cursorActivity:function(a){this.unloaded&&(window.document.designMode="off",window.document.designMode="on",this.unloaded=!1);if(internetExplorer){this.container.createTextRange().execCommand("unlink");clearTimeout(this.saveSelectionSnapshot);var b=this;this.saveSelectionSnapshot=setTimeout(function(){var a=select.getBookmark(b.container);if(a)b.selectionSnapshot=a},200)}var f=this.options.cursorActivity;if(!a||f){var d=select.selectionTopNode(this.container,
!1);!1!==d&&this.container.firstChild&&(d=d||this.container.firstChild,f&&f(d),a||(this.scheduleHighlight(),this.addDirtyNode(d)))}},reparseBuffer:function(){forEach(this.container.childNodes,function(a){a.dirty=!0});this.container.firstChild&&this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(a){if(a=a||this.container.firstChild){for(var b=0;b<this.dirty.length;b++)if(this.dirty[b]==a)return;3!=a.nodeType&&(a.dirty=!0);this.dirty.push(a)}},allClean:function(){return!this.dirty.length},
scheduleHighlight:function(){var a=this;this.parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=this.parent.setTimeout(function(){a.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){for(;0<this.dirty.length;){var a=this.dirty.pop();try{for(;a&&a.parentNode!=this.container;)a=a.parentNode;if(a&&(a.dirty||3==a.nodeType))return a}catch(b){}}return null},highlightDirty:function(a){if(!window.parent||!window.select)return!1;this.options.readOnly||select.markSelection();for(var b,
f=a?null:(new Date).getTime()+this.options.passTime;((new Date).getTime()<f||a)&&(b=this.getDirtyNode());){var d=this.highlight(b,f);d&&(d.node&&d.dirty)&&this.addDirtyNode(d.node.nextSibling)}this.options.readOnly||select.selectMarked();b&&this.scheduleHighlight();return 0==this.dirty.length},documentScanner:function(a){var b=this,f=null;return function(){if(window.parent&&window.select){f&&f.parentNode!=b.container&&(f=null);select.markSelection();var d=b.highlight(f,(new Date).getTime()+a,!0);
select.selectMarked();d=d?d.node&&d.node.nextSibling:null;f=f==d?null:d;b.delayScanning()}}},delayScanning:function(){this.scanner&&(this.parent.clearTimeout(this.documentScan),this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning))},highlight:function(a,b,f,h){function e(a){if(a){var b=a.oldNextSibling;(p||void 0===b||a.nextSibling!=b)&&j.history.touch(a);a.oldNextSibling=a.nextSibling}else b=j.container.oldFirstChild,(p||void 0===b||j.container.firstChild!=b)&&j.history.touch(null),
j.container.oldFirstChild=j.container.firstChild}var g=this.container,j=this,i=this.options.activeTokens,z="number"==typeof b?b:null;if(!g.firstChild)return!1;for(;a&&(!a.parserFromHere||a.dirty);){if(null!=h&&isBR(a)&&0>--h)return!1;a=a.previousSibling}if(a&&!a.nextSibling)return!1;var n=d(a?a.nextSibling:g.firstChild),h=stringStream(n),q=a?a.parserFromHere(h):k.Parser.make(h),o={current:null,get:function(){this.current||(this.current=n.nodes.shift());return this.current},next:function(){this.current=
null},remove:function(){g.removeChild(this.get());this.current=null},getNonEmpty:function(){for(var a=this.get();a&&isSpan(a)&&""==a.currentText;)if(window.opera&&(null==a.previousSibling||isBR(a.previousSibling))&&(null==a.nextSibling||isBR(a.nextSibling)))this.next(),a=this.get();else{var b=a;this.remove();a=this.get();select.snapshotMove(b.firstChild,a&&(a.firstChild||a),0)}return a}},p=!1,s=!0,t=0;forEach(q,function(d){var h=o.getNonEmpty();if("\n"==d.value){if(!isBR(h))throw"Parser out of sync. Expected BR.";
if(h.dirty||!h.indentation)p=!0;e(a);a=h;h.parserFromHere=q.copy();h.indentation=d.indentation;h.dirty=!1;if(null==z&&h==b)throw StopIteration;if(null!=z&&(new Date).getTime()>=z||!p&&!s&&1<t&&!f)throw StopIteration;s=p;p=!1;t=0;o.next()}else{if(!isSpan(h))throw"Parser out of sync. Expected SPAN.";h.dirty&&(p=!0);t++;if(!h.reduced&&h.currentText==d.value&&h.className==d.style)h.dirty=!1,o.next();else{p=!0;var m=makePartSpan(d.value);m.className=d.style;g.insertBefore(m,h);i&&i(m,d,j);for(var d=d.value.length,
k=0;0<d;){var h=o.get(),n=h.currentText.length;select.snapshotReplaceNode(h.firstChild,m.firstChild,d,k);n>d?(h.currentText=h.currentText.substring(d),h.reduced=!0,d=0):(d-=n,k+=n,o.remove())}}}});e(a);webkitLastLineHack(this.container);return{node:o.getNonEmpty(),dirty:p}}};return k}();addEventHandler(window,"load",function(){var b=window.frameElement.CodeMirror;b.editor=new Editor(b.options);this.parent.setTimeout(method(b,"init"),0)});
function tokenizer(b,d){function g(b){return"\n"!=b&&/^[\s\u00a0]*$/.test(b)}var i={state:d,take:function(d){"string"==typeof d&&(d={style:d,type:d});d.content=(d.content||"")+b.get();/\n$/.test(d.content)||b.nextWhile(g);d.value=d.content+b.get();return d},next:function(){if(!b.more())throw StopIteration;var d;if(b.equals("\n"))return b.next(),this.take("whitespace");if(b.applies(g))d="whitespace";else for(;!d;)d=this.state(b,function(b){i.state=b});return this.take(d)}};return i}
var XMLParser=Editor.Parser=function(){var b={autoSelfClosers:{br:!0,img:!0,hr:!0,link:!0,input:!0,meta:!0,col:!0,frame:!0,base:!0,area:!0},doNotIndent:{pre:!0,"!cdata":!0}},d={autoSelfClosers:{},doNotIndent:{"!cdata":!0}},g=b,i=!1,h,k=function(b,d){var h=b.next();if("<"==h){if(b.equals("!"))return b.next(),b.equals("[")?b.lookAhead("[CDATA[",!0)?(d(a("xml-cdata","]]\>")),null):"xml-text":b.lookAhead("--",!0)?(d(a("xml-comment","--\>")),null):b.lookAhead("DOCTYPE",!0)?(b.nextWhileMatches(/[\w\._\-]/),
d(a("xml-doctype",">")),"xml-doctype"):"xml-text";if(b.equals("?"))return b.next(),b.nextWhileMatches(/[\w\._\-]/),d(a("xml-processing","?>")),"xml-processing";b.equals("/")&&b.next();d(f);return"xml-punctuation"}if("&"==h){for(;!b.endOfLine()&&";"!=b.next(););return"xml-entity"}b.nextWhileMatches(/[^&<\n]/);return"xml-text"},f=function(a,b){var d=a.next();if(">"==d)return b(k),"xml-punctuation";if(/[?\/]/.test(d)&&a.equals(">"))return a.next(),b(k),"xml-punctuation";if("="==d)return"xml-punctuation";
if(/[\'\"]/.test(d))return b(function(a,b){for(;!a.endOfLine();)if(a.next()==d){b(f);break}return"xml-attribute"}),null;a.nextWhileMatches(/[^\s\u00a0=<>\"\'\/?]/);return"xml-name"},a=function(a,b){return function(d,e){for(;!d.endOfLine();){if(d.lookAhead(b,!0)){e(k);break}d.next()}return a}};h=function(a,b){return tokenizer(a,b||k)};return{make:function(a){function b(a){for(var c=a.length-1;0<=c;c--)A.push(a[c])}function d(){b(arguments);E=!0}function e(){b(arguments);E=!1}function f(){u.style+=
" xml-error"}function j(a,b){var c=g.doNotIndent.hasOwnProperty(a)||v&&v.noIndent;v={prev:v,name:a,indent:D,startOfLine:b,noIndent:c}}function k(){return e(z,k)}function z(a,b){"<"==b?d(n,p,o(1==B)):"</"==b?d(q,function(a,b){">"==b?d():(f(),d(arguments.callee))}):("xml-cdata"==a?((!v||"!cdata"!=v.name)&&j("!cdata"),/\]\]>$/.test(b)&&(v=v.prev)):J.hasOwnProperty(a)||f(),d())}function n(a,b){"xml-name"==a?(G=b.toLowerCase(),u.style="xml-tagname",d()):(G=null,e())}function q(a,b){"xml-name"==a&&(u.style=
"xml-tagname",v&&b.toLowerCase()==v.name?v=v.prev:f());d()}function o(a){return function(b,c){"/>"==c||">"==c&&g.autoSelfClosers.hasOwnProperty(G)?d():">"==c?(j(G,a),d()):(f(),d(arguments.callee))}}function p(a){"xml-name"==a?(u.style="xml-attname",d(s,p)):e()}function s(a,b){"="==b?d(t):">"==b||"/>"==b?e(o):e()}function t(a){"xml-attribute"==a?d(t):e()}var x=h(a),u,A=[k],B=0,D=0,G=null,v=null,E,J={"xml-text":!0,"xml-entity":!0,"xml-comment":!0,"xml-processing":!0,"xml-doctype":!0};return{indentation:function(){return D},
next:function(){u=x.next();"whitespace"==u.style&&0==B?D=u.value.length:B++;if("\n"==u.content){D=B=0;var a=v;u.indentation=function(b,c){var e=a;if(e&&e.noIndent)return c;if(i&&/<!\[CDATA\[/.test(b))return 0;e&&/^<\//.test(b)&&(e=e.prev);for(;e&&!e.startOfLine;)e=e.prev;return e?e.indent+indentUnit:0}}if("whitespace"==u.style||"xml-comment"==u.type)return u;for(;;)if(E=!1,A.pop()(u.style,u.content),E)return u},copy:function(){var a=A.concat([]),b=x.state,c=v,e=this;return function(d){A=a.concat([]);
B=D=0;v=c;x=h(d,b);return e}}}},electricChars:"/",configure:function(a){null!=a.useHTMLKludges&&(g=a.useHTMLKludges?b:d);a.alignCDATA&&(i=a.alignCDATA)}}}(),CSSParser=Editor.Parser=function(){var b,d=function(b,k){var f=b.next();if("@"==f)return b.nextWhileMatches(/\w/),"css-at";if("/"==f&&b.equals("*"))return k(g),null;if("<"==f&&b.equals("!"))return k(i),null;if("="==f)return"css-compare";if(b.equals("=")&&("~"==f||"|"==f))return b.next(),"css-compare";if('"'==f||"'"==f)return k(function(a,b){for(var g=
!1;!a.endOfLine();){var h=a.next();if(h==f&&!g)break;g=!g&&"\\"==h}g||b(d);return"css-string"}),null;if("#"==f)return b.nextWhileMatches(/\w/),"css-hash";if("!"==f)return b.nextWhileMatches(/[ \t]/),b.nextWhileMatches(/\w/),"css-important";if(/\d/.test(f))return b.nextWhileMatches(/[\w.%]/),"css-unit";if(/[,.+>*\/]/.test(f))return"css-select-op";if(/[;{}:\[\]]/.test(f))return"css-punctuation";b.nextWhileMatches(/[\w\\\-_]/);return"css-identifier"},g=function(b,g){for(var f=!1;!b.endOfLine();){var a=
b.next();if(f&&"/"==a){g(d);break}f="*"==a}return"css-comment"},i=function(b,g){for(var f=0;!b.endOfLine();){var a=b.next();if(2<=f&&">"==a){g(d);break}f="-"==a?f+1:0}return"css-comment"};b=function(b,g){return tokenizer(b,g||d)};return{make:function(d,g){var g=g||0,f=b(d),a=!1,c=!1,i=!1,m={next:function(){var b=f.next(),d=b.style,j=b.content;"css-hash"==d&&(d=b.style=c?"css-colorcode":"css-identifier");"css-identifier"==d&&(c?b.style="css-value":!a&&!i&&(b.style="css-selector"));if("\n"==j){var h=
a,m=c,n=g;b.indentation=function(a){return!h||/^\}/.test(a)?n:m?n+indentUnit*2:n+indentUnit}}"{"==j&&"@media"==i?i=!1:"{"==j?a=!0:"}"==j?a=c=i=!1:";"==j?c=i=!1:a&&"css-comment"!=d&&"whitespace"!=d?c=!0:!a&&"css-at"==d&&(i=j);return b},copy:function(){var e=a,d=c,g=f.state;return function(h){f=b(h,g);a=e;c=d;return m}}};return m},electricChars:"}"}}(),tokenizeJavaScript=function(){function b(a,b){for(var c=!1;!a.endOfLine();){var d=a.next();if(d==b&&!c)return!1;c=!c&&"\\"==d}return c}function d(a,
b){return function(c,e){var f=a,h=g(a,b,c,function(a){f=a}),i="operator"==h.type||"keyword c"==h.type||h.type.match(/^[\[{}\(,;:]$/);(i!=b||f!=a)&&e(d(f,i));return h}}function g(a,c,d,f){function g(a){for(var b="/*",a="*"==a;!d.endOfLine();){var c=d.next();if("/"==c&&a){b=null;break}a="*"==c}f(b);return{type:"comment",style:"js-comment"}}function h(){d.nextWhileMatches(m);return{type:"operator",style:"js-operator"}}function k(a){var c=b(d,a);f(c?a:null);return{type:"string",style:"js-string"}}if('"'==
a||"'"==a)return k(a);var l=d.next();if("/*"==a)return g(l);if('"'==l||"'"==l)return k(l);if(/[\[\]{}\(\),;\:\.]/.test(l))return{type:l,style:"js-punctuation"};if("0"==l&&(d.equals("x")||d.equals("X")))return d.next(),d.nextWhileMatches(e),{type:"number",style:"js-atom"};if(/[0-9]/.test(l)){d.nextWhileMatches(/[0-9]/);d.equals(".")&&(d.next(),d.nextWhileMatches(/[0-9]/));if(d.equals("e")||d.equals("E"))d.next(),d.equals("-")&&d.next(),d.nextWhileMatches(/[0-9]/);return{type:"number",style:"js-atom"}}if("/"==
l)return d.equals("*")?(d.next(),g(l)):d.equals("/")?(b(d,null),{type:"comment",style:"js-comment"}):c?(b(d,"/"),d.nextWhileMatches(/[gi]/),{type:"regexp",style:"js-string"}):h();if(m.test(l))return h();d.nextWhileMatches(r);a=d.get();return(c=i.hasOwnProperty(a)&&i.propertyIsEnumerable(a)&&i[a])?{type:c.type,style:c.style,content:a}:{type:"variable",style:"js-variable",content:a}}var i,h=function(a,b){return{type:a,style:"js-"+b}},k=h("keyword a","keyword"),f=h("keyword b","keyword"),a=h("keyword c",
"keyword"),c=h("operator","keyword"),l=h("atom","atom");i={"if":k,"while":k,"with":k,"else":f,"do":f,"try":f,"finally":f,"return":a,"break":a,"continue":a,"new":a,"delete":a,"throw":a,"in":c,"typeof":c,"instanceof":c,"var":h("var","keyword"),"function":h("function","keyword"),"catch":h("catch","keyword"),"for":h("for","keyword"),"switch":h("switch","keyword"),"case":h("case","keyword"),"default":h("default","keyword"),"true":l,"false":l,"null":l,undefined:l,NaN:l,Infinity:l};var m=/[+\-*&%=<>!?|]/,
e=/[0-9A-Fa-f]/,r=/[\w\$_]/;return function(a,b){return tokenizer(a,b||d(!1,!0))}}(),JSParser=Editor.Parser=function(){function b(b,d,g,f,a,c){this.indented=b;this.column=d;this.type=g;null!=f&&(this.align=f);this.prev=a;this.info=c}var d={atom:!0,number:!0,variable:!0,string:!0,regexp:!0},g=!1;return{make:function(i,h){function k(a){for(var b=a.length-1;0<=b;b--)F.push(a[b])}function f(){k(arguments);L=!0}function a(){k(arguments);L=!1}function c(){y={prev:y,vars:{"this":!0,arguments:!0}}}function l(){y=
y.prev}function m(a){y&&(H="js-variabledef",y.vars[a]=!0)}function e(a,c){var d=function(){w=new b(K,I,a,null,w,c)};d.lex=!0;return d}function r(){")"==w.type&&(K=w.indented);w=w.prev}function j(b){return function(c){c==b?f():";"==b?a():f(arguments.callee)}}function C(){return a(n,C)}function z(){return a(q,z)}function n(b){"var"==b?f(e("vardef"),A,j(";"),r):"keyword a"==b?f(e("form"),q,n,r):"keyword b"==b?f(e("form"),n,r):"{"==b?f(e("}"),u,r):";"==b?f():"function"==b?f(J):"for"==b?f(e("form"),j("("),
e(")"),D,j(")"),r,n,r):"variable"==b?f(e("stat"),p):"switch"==b?f(e("form"),q,e("}","switch"),j("{"),u,r,r):"case"==b?f(q,j(":")):"default"==b?f(j(":")):"catch"==b?f(e("form"),c,j("("),N,j(")"),n,r,l):a(e("stat"),q,j(";"),r)}function q(a){d.hasOwnProperty(a)?f(o):"function"==a?f(J):"keyword c"==a?f(q):"("==a?f(e(")"),q,j(")"),r,o):"operator"==a?f(q):"["==a?f(e("]"),x(q,"]"),r,o):"{"==a?f(e("}"),x(t,"}"),r,o):f()}function o(b,c){"operator"==b&&/\+\+|--/.test(c)?f(o):"operator"==b?f(q):";"==b?a():"("==
b?f(e(")"),x(q,")"),r,o):"."==b?f(s,o):"["==b&&f(e("]"),q,j("]"),r,o)}function p(b){":"==b?f(r,n):a(o,j(";"),r)}function s(a){"variable"==a&&(H="js-property",f())}function t(a){"variable"==a&&(H="js-property");d.hasOwnProperty(a)&&f(j(":"),q)}function x(b,c){function d(a){","==a?f(b,d):a==c?f():f(j(c))}return function(e){e==c?f():a(b,d)}}function u(b){"}"==b?f():a(n,u)}function A(a,b){"variable"==a?(m(b),f(B)):f()}function B(a,b){"="==b?f(q,B):","==a&&f(A)}function D(b){"var"==b?f(A,v):";"==b?a(v):
"variable"==b?f(G):a(v)}function G(a,b){"in"==b?f(q):f(o,v)}function v(a,b){";"==a?f(E):"in"==b?f(q):f(q,j(";"),E)}function E(b){")"==b?a():f(q)}function J(a,b){"variable"==a?(m(b),f(J)):"("==a&&f(c,x(N,")"),n,l)}function N(a,b){"variable"==a&&(m(b),f())}var M=tokenizeJavaScript(i),F=[g?z:C],y=null,w=new b((h||0)-indentUnit,0,"block",!1),I=0,K=0,L,H,O={next:function(){for(;F[F.length-1].lex;)F.pop()();var a=M.next();"whitespace"==a.type&&0==I&&(K=a.value.length);I+=a.value.length;if("\n"==a.content){K=
I=0;"align"in w||(w.align=!1);var b=w;a.indentation=function(a){var c=a&&a.charAt(0),d=b.type,e=c==d;return d=="vardef"?b.indented+4:d=="form"&&c=="{"?b.indented:d=="stat"||d=="form"?b.indented+indentUnit:b.info=="switch"&&!e?b.indented+(/^(?:case|default)\b/.test(a)?indentUnit:2*indentUnit):b.align?b.column-(e?1:0):b.indented+(e?0:indentUnit)}}if("whitespace"==a.type||"comment"==a.type)return a;"align"in w||(w.align=!0);for(;;)if(L=H=!1,F.pop()(a.type,a.content),L){if(H)a.style=H;else{var c;if(c=
"variable"==a.type)a:{for(c=y;c;){if(c.vars[a.content]){c=!0;break a}c=c.prev}c=!1}c&&(a.style="js-localvariable")}return a}},copy:function(){var a=y,b=w,c=F.concat([]),d=M.state;return function(e){y=a;w=b;F=c.concat([]);I=K=0;M=tokenizeJavaScript(e,d);return O}}};r.lex=!0;return O},electricChars:"{}:",configure:function(b){null!=b.json&&(g=b.json)}}}(),HTMLMixedParser=Editor.Parser=function(){var b={script:"JSParser",style:"CSSParser"};return{make:function(d){function g(){var h=f.next();if("<"==
h.content)c=!0;else if("xml-tagname"==h.style&&!0===c)c=h.content.toLowerCase();else if(">"==h.content){if(b[c]){var e=l,i=window[b[c]],j="</"+c,k=f.indentation();a=i.make(d,k+indentUnit);e.next=function(){if(d.lookAhead(j,!1,!1,!0))return a=null,l.next=g,g();var b=a.next(),c=b.value.lastIndexOf("<"),e=Math.min(b.value.length-c,j.length);-1!=c&&(b.value.slice(c,c+e).toLowerCase()==j.slice(0,e)&&d.lookAhead(j.slice(e),!1,!1,!0))&&(d.push(b.value.slice(c)),b.value=b.value.slice(0,c));if(b.indentation){var f=
b.indentation;b.indentation=function(a){return a=="</"?k:f(a)}}return b}}c=!1}return h}var i=["XMLParser"],h;for(h in b)i.push(b[h]);for(var k in i)if(!window[i[k]])throw Error(i[k]+" parser must be loaded for HTML mixed mode to work.");XMLParser.configure({useHTMLKludges:!0});var f=XMLParser.make(d),a=null,c=!1,l={next:g,copy:function(){var b=f.copy(),e=a&&a.copy(),g=l.next,h=c;return function(i){d=i;f=b(i);a=e&&e(i);l.next=g;c=h;return l}}};return l},electricChars:"{}/:",configure:function(d){d.triggers&&
(b=d.triggers)}}}(),DummyParser=Editor.Parser=function(){function b(b){for(;!b.endOfLine();)b.next();return"text"}return{make:function(d){var d=tokenizer(d,b),g=0,i={next:function(){var b=d.next();if("whitespace"==b.type)if("\n"==b.value){var i=g;b.indentation=function(){return i}}else g=b.value.length;return b},copy:function(){var h=g;return function(k){g=h;d=tokenizer(k,b);return i}}};return i}}}();
