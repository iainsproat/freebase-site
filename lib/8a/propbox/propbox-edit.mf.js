
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
(function(c){c.fn.validate_input=function(b){return this.each(function(){var d=c(this);if(d.is(":text")){var g=d.data("$.validate_input");g&&g._destroy();g=new e(this,b);d.data("$.validate_input",g)}})};var e=c.validate_input=function(b,d){this.options=c.extend(true,{},e.defaults,d);if(typeof this.options.validator!=="function")throw"A validator is required";this.input=c(b);this.original_value=this.input.val();this.init();var g=this;this.input.bind("remove",function(){g._destroy()});return this};
e.prototype={init:function(){var b=this;this.input.bind("keyup.validate_input",function(d){b.textchange(d)}).bind(c.browser.msie?"paste.validate_input":"input.validate_input",function(d){b.textchange(d)})},_destroy:function(){this.input.unbind(".validate_input")},original:function(){this.input.trigger("original")},valid:function(b){this.input.trigger("valid",b)},invalid:function(b,d){this.input.trigger("invalid",d)},textchange:function(){clearTimeout(this.textchange_timeout);var b=this;this.textchange_timeout=
setTimeout(function(){b.validate()},200)},validate:function(b){b&&clearTimeout(this.textchange_timeout);b=this.input.val();if(this.original_value===b)return this.original(b);b=c.trim(b);var d=this.options;try{return this.valid(d.validator(b,d))}catch(g){return this.invalid(b,""+g)}}};c.extend(e,{defaults:{validator:function(b){return{text:b,value:b}}},log:function(){},invalid:function(b,d,g,j){throw new Error("Invalid "+g+(j?": "+j:""));},text:function(b,d){if(b.lengh>4096)return this.invalid(b,d,
type,"Text too long");return{text:b,value:b}},topic:function(){return e.defaults.validator},enumerated:function(){return e.defaults.validator},"boolean":function(){return e.defaults.validator},uri:function(b,d){var g=e.uri.regex;if(!g)g=e.uri.regex=/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
if(g.test(b))return{text:b,value:b};return e.invalid(b,d,"uri")},"int":function(b,d){var g=e.parse_number(b,d);try{var j=parseInt(g,10);if(isNaN(j))throw"isNaN";return{text:(new Number(j)).toLocaleString(),value:j}}catch(h){}return e.invalid(b,d,"int")},"float":function(b,d){var g=e.parse_number(b,d);try{var j=parseFloat(g);if(isNaN(j))throw"isNaN";return{text:(new Number(j)).toLocaleString(),value:j}}catch(h){}return e.invalid(b,d,"float")},parse_number:function(b,d){var g=e.parse_number.regex;if(!g)g=
e.parse_number.regex=/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/;if(g.test(b))return b.replace(/[^\-\d\.]/g,"");return e.invalid(b,d,"number")},datetime:function(b){var d=e.datetime.fromISOString(b);if(d)return{text:b,value:b,date:d};throw e.invalid("datetime",b);},mqlkey:function(b,d){var g=e.mqlkey.regex;if(!g)g=e.mqlkey.regex=/^[A-Za-z0-9][A-Za-z0-9_-]*$/;if(g.test(b))return{text:b,value:b};return e.invalid(b,d,"mqlkey")}});c.extend(e.datetime,{fromISOString:function(b,d){if(!c.validate_input.datetime._isoRegExp)c.validate_input.datetime._isoRegExp=
/^(?:(-?\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(.\d+)?)?((?:[+-](\d{2}):(\d{2}))|Z)?)?$/;var g=c.validate_input.datetime._isoRegExp.exec(b),j=null;if(g){g.shift();g[0]=g[0].replace(/^(-)*0+/g,"$1");g[1]&&g[1]--;if(g[6])g[6]*=1E3;if(d){d=new Date(d);c.each(c.map(["FullYear","Month","Date","Hours","Minutes","Seconds","Milliseconds"],function(i){return d["get"+i]()}),function(i,f){g[f]=g[f]||i})}j=new Date(g[0]||1970,g[1]||0,g[2]||1,g[3]||0,g[4]||0,g[5]||0,g[6]||0);if(g[0]<100)j.setFullYear(g[0]||
1970);var h=0,a=g[7]&&g[7].charAt(0);if(a!="Z"){h=(g[8]||0)*60+(Number(g[9])||0);if(a!="-")h*=-1}if(a)h-=j.getTimezoneOffset();h&&j.setTime(j.getTime()+h*6E4)}return j},toISOString:function(b,d){var g=function(f){return f<10?"0"+f:f};d=d||{};var j=[],h=d.zulu?"getUTC":"get",a="";if(d.selector!="time"){a=b[h+"FullYear"]();a=["0000".substr((a+"").length)+a,g(b[h+"Month"]()+1),g(b[h+"Date"]())].join("-")}j.push(a);if(d.selector!="date"){a=[g(b[h+"Hours"]()),g(b[h+"Minutes"]()),g(b[h+"Seconds"]())].join(":");
h=b[h+"Milliseconds"]();if(d.milliseconds)a+="."+(h<100?"0":"")+g(h);if(d.zulu)a+="Z";else if(d.selector!="time"){h=b.getTimezoneOffset();var i=Math.abs(h);a+=(h>0?"-":"+")+g(Math.floor(i/60))+":"+g(i%60)}j.push(a)}return j.join("T")}})})(jQuery);
(function(c){c.fn.data_input=function(e){return this.each(function(){var b=c(this),d=b.data("$.data_input");d&&d._destroy();d=new c.data_input(this,e);b.data("$.data_input",d)})};c.data_input=function(e,b){this.options=c.extend(true,{},c.data_input.defaults,b);this.container=c(e);this.input=c(":input",this.container);this.init();var d=this;this.input.bind("remove",function(){d._destroy()})};c.data_input.prototype={init:function(){var e=this,b=this.container,d=this.input;if(b.is(".topic"))d.validate_topic(c.extend(true,
{},this.options.suggest,{type:b.attr("data-ect")})).bind("valid.data_input",function(g,j){e.fb_select(j)}).bind("invalid.data_input",function(){e.fb_textchange()});else if(b.is(".text"))d.validate_input({validator:c.validate_input.text});else if(b.is(".datetime"))d.validate_input({validator:c.validate_input.datetime});else if(b.is(".enumerated"))d.validate_enumerated().bind("valid.data_input",function(g,j){e.fb_select(j)}).bind("invalid.data_input",function(){e.fb_textchange()});else if(b.is(".int"))d.validate_input({validator:c.validate_input["int"]});
else if(b.is(".float"))d.validate_input({validator:c.validate_input["float"]});else if(b.is(".uri"))d.validate_input({validator:c.validate_input.uri});else if(b.is(".boolean"))d.validate_boolean();else if(b.is(".enumeration"))d.validate_input({validator:c.validate_input.mqlkey});else if(b.is(".rawstring"))d.validate_input({validator:c.validate_input.text});else throw new Error("Invalid data-input: "+b.attr("class"));this.input.bind("focusin.data_input",function(){e.container.addClass("focus")}).bind("focusout.data_input",
function(){e.container.removeClass("focus")}).bind("valid.data_input",function(g,j){var h=e.input.attr("name");e.container.data("name_value",[h,j.id||j.value]);e.container.removeClass("error").addClass("valid")}).bind("invalid.data_input",function(){e.container.removeData("name_value");e.container.removeClass("valid").addClass("error")}).bind("keypress.data_input",function(g){g.keyCode===13&&!g.isDefaultPrevented()&&e.container.trigger("submit")}).bind("keyup.data_input",function(g){g.keyCode===27&&
e.container.trigger("cancel")})},_destroy:function(){this.input.unbind(".data_input")},validate:function(){var e=this.input;c.each(["$.validate_topic","$.validate_input","$.validate_enumerated","$.validate_boolean"],function(b,d){var g=e.data(d);if(g){g.validate(true);return false}})},reset:function(){this.container.removeData("name_value");if(this.input.is(":text"))this.input.val("");else if(this.input.is("select"))this.input[0].selectedIndex=0;else this.input.is(":radio")&&this.input.each(function(){this.checked=
false});this.container.siblings().find("[data-lang]").val("")},fb_textchange:function(){this.container.siblings().find("[data-lang]").val("")},fb_select:function(e){var b=[],d=this.container.siblings(".lang-input").find(":text[data-lang]");d.each(function(){var j=c(this).attr("data-lang");j&&b.push(j)});if(b.length){e={id:e.id,name:[{value:null,lang:null,optional:true,"lang|=":b}]};var g=this;this.fb_select.jqXHR&&this.fb_select.jqXHR.abort();this.fb_select.jqXHR=c.ajax({url:this.options.suggest.mqlread_url,
data:{query:JSON.stringify({query:e})},dataType:"jsonp",beforeSend:function(j,h){g.ajax_beforeSend(j,h)},success:function(j){if(j.code=="/api/status/ok"&&j.result){var h=g.container.data("name_value");if(h&&h[1]===j.result.id)if((h=j.result.name)&&h.length){var a={};c.each(h,function(i,f){a[f.lang]=f.value});d.each(function(){var i=c(this),f=i.attr("data-lang"),k=j.result.id+".name."+f;i.val(a[f]||"").attr("name",k)})}}},complete:function(j,h){g.ajax_complete(j,h)}})}},ajax_beforeSend:function(e){if(!this.xhr_queue)this.xhr_queue=
[];this.xhr_queue.push(e);this.container.trigger("loading")},ajax_complete:function(e){if(!this.xhr_queue)this.xhr_queue=[];for(var b=0,d=this.xhr_queue.length;b<d;b++)if(e===this.xhr_queue[b]){this.xhr_queue.splice(b,1);break}this.xhr_queue.length===0&&this.container.trigger("loading_complete")}};c.extend(c.data_input,{defaults:{suggest:{service_url:"http://www.freebase.com",service_path:"/private/suggest",flyout_service_url:"http://www.freebase.com",flyout_service_path:"/private/flyout",mqlread_url:"http://api.freebase.com/api/service/mqlread",
category:"object",type:"/common/topic"}}});c.fn.validate_topic=function(e){return this.each(function(){var b=c(this);if(b.is(":text")){var d=b.data("$.validate_topic");d&&d._destroy();d=new c.validate_topic(this,e);b.data("$.validate_topic",d)}})};c.validate_topic=function(e,b){this.options=c.extend(true,{},b);this.input=c(e);this.init()};c.validate_topic.prototype={init:function(){var e=this;this.input.suggest(this.options).bind("fb-textchange.validate_topic",function(){e.invalid()}).bind("fb-select.validate_topic",
function(b,d){e.input.val(d.id);e.valid(d)})},invalid:function(){this.input.trigger("invalid")},valid:function(e){this.input.trigger("valid",e)},_destroy:function(){this.input.unbind(".validate_topic")},validate:function(){}};c.fn.validate_enumerated=function(e){return this.each(function(){var b=c(this);if(b.is("select")){var d=b.data("$.validate_enumerated");d&&d._destroy();d=new c.validate_enumerated(this,e);b.data("$.validate_enumerated",d)}})};c.validate_enumerated=function(e,b){this.options=
c.extend(true,{},b);this.input=c(e);this.init()};c.validate_enumerated.prototype={init:function(){var e=this;this.input.bind("change.validate_enumerated",function(){this.selectedIndex>0?e.valid({text:c(":selected",this).text(),id:this.value}):e.invalid()})},invalid:function(){this.input.trigger("invalid")},valid:function(e){this.input.trigger("valid",e);this.input.trigger("fb-select",e)},_destroy:function(){this.input.unbind(".validate_enumerated")},validate:function(){}};c.fn.validate_boolean=function(e){return this.each(function(){var b=
c(this);if(b.is(":radio")){var d=b.data("$.validate_boolean");d&&d._destroy();d=new c.validate_boolean(this,e);b.data("$.validate_boolean",d)}})};c.validate_boolean=function(e,b){this.options=c.extend(true,{},b);this.input=c(e);this.init()};c.validate_boolean.prototype={init:function(){var e=this;this.input.bind("change.validate_boolean",function(){e.valid({text:c(this).text(),value:this.value})})},_destroy:function(){this.input.unbind(".validate_boolean")},valid:function(e){this.input.trigger("valid",
e)},validate:function(){}}})(jQuery);
(function(c,e){var b=e.options.base_url,d=e.options.id,g=e.options.lang,j=e.options.suggest,h=e.edit={prop_add_begin:function(a){var i={s:d,p:a.attr("data-id"),lang:g};c.ajax({url:b+"/prop_add_begin.ajax",data:i,dataType:"json",success:function(f){f=c(f.result.html).hide();var k={mode:"add",event_prefix:"propbox.edit.prop_add.",ajax:{data:i,url:b+"/prop_add_submit.ajax"},init:h.init_prop_add_form,validate:h.validate_prop_add_form,submit:h.submit_prop_add_form,form:f,prop_section:a};h.init(k);k.form.bind("propbox.edit.prop_add.success",
function(){h.reset_data_input(k);c(":input:visible:first",k.form).focus();c(".button-cancel",k.form).text("Done")})},error:function(f){h.ajax_error(f,form)}})},init_prop_add_form:function(a){h.init_data_input(a);c(":input:visible:first",a.form).focus()},validate_prop_add_form:function(a){return h.validate_data_input(a)},submit_prop_add_form:function(a){var i=c.extend({},a.ajax.data);c(".data-input",a.form).each(function(){var f=c(this).data("name_value");if(f)i[f[0]]=f[1]});c(".lang-input :text[data-lang]",
a.form).each(function(){var f=c(this);i[f.attr("name")]=f.val()});c.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:i,success:function(f,k,l){if(f.code!=="/api/status/ok")return h.ajax_error(l,a);f=c(f.result.html);if(f.is("tr")){c(".data-table > tbody",a.prop_section).append(f);c(".data-table > thead",a.prop_section).show()}else c(".data-list",a.prop_section).append(f);a.form.trigger(a.event_prefix+"success")},error:function(f){h.ajax_error(f,a)}})},value_edit_begin:function(a,i){var f;if(i.is("tr"))f=
i.attr("data-id");else{f=c(".property-value:first",i);f=f.attr("data-id")||f.attr("data-value")}var k={s:d,p:a.attr("data-id"),o:f,lang:g};c.ajax({url:b+"/value_edit_begin.ajax",data:k,dataType:"json",success:function(l){l=c(l.result.html).hide();var m={mode:"edit",event_prefix:"propbox.edit.value_edit.",ajax:{data:k,url:b+"/value_edit_submit.ajax"},init:h.init_value_edit_form,validate:h.validate_value_edit_form,submit:h.submit_value_edit_form,form:l,prop_section:a,prop_row:i};h.init(m);m.form.bind("propbox.edit.value_edit.success",
function(){console.log("propbox.edit.value_edit.success");m.form.remove()}).bind("propbox.edit.value_edit.cancel",function(){console.log("propbox.edit.value_edit.cancel");m.prop_row.show()})},error:function(l){h.ajax_error(l,form)}})},init_value_edit_form:function(a){h.init_data_input(a);c(":input:visible:first",a.form).focus()},validate_value_edit_form:function(a){return h.validate_data_input(a)},submit_value_edit_form:function(a){var i=c.extend({},a.ajax.data);c(".data-input",a.form).each(function(){var f=
c(this).data("name_value");if(f)i[f[0]]=f[1]});c(".lang-input :text[data-lang]",a.form).each(function(){var f=c(this);i[f.attr("name")]=f.val()});c.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:i,success:function(f,k,l){if(f.code!=="/api/status/ok")return h.ajax_error(l,a);f=c(f.result.html);f.is("tr")&&c(".data-table > thead",a.prop_section).show();a.prop_row.after(f);a.prop_row.remove();a.form.trigger(a.event_prefix+"success")},error:function(f){h.ajax_error(f,a)}})},init_data_input:function(a){c(".data-input",
a.form).each(function(){c(this).data_input({suggest:j}).bind("submit",function(){a.form.trigger(a.event_prefix+"submit")}).bind("cancel",function(){a.form.trigger(a.event_prefix+"cancel")}).bind("loading",function(){c(this).addClass("loading")}).bind("loading_complete",function(){c(this).removeClass("loading")})})},validate_data_input:function(a){var i=true;c(".data-input",a.form).each(function(f){var k=c(this);if(k.is(".loading")){console.log("data_input.is(.loading)");return i=false}k.data("$.data_input").validate(true);
if(f===0&&!k.is(".valid"))i=h.data_input_required(a,k);else if(k.is(".error"))i=h.data_input_invalid(a,k)});return i},reset_data_input:function(a){c(".data-input",a.form).each(function(){c(this).data("$.data_input").reset()})},init:function(a){if(a.mode==="add"){var i=c(">.data-section",a.prop_section);c(".data-table tr.empty-row, .data-list li.empty-row",i).hide();a.prop_section.append(a.form)}else if(a.mode==="edit"){a.prop_row.hide();a.prop_row.after(a.form)}var f=a.event_prefix||"propbox.edit.";
a.form.bind(f+"submit",function(){h.submit(a)}).bind(f+"cancel",function(){h.cancel(a)}).bind(f+"error",function(k,l){h.error(a,l);a.form.removeClass("loading");a.prop_section.removeClass("editing")}).bind(f+"success",function(){a.form.removeClass("loading");a.prop_section.removeClass("editing")});c(".button-submit",a.form).click(function(){a.form.trigger(f+"submit")});c(".button-cancel",a.form).click(function(){a.form.trigger(f+"cancel")});a.form.show();e.kbs.scroll_to(a.prop_section);a.init&&a.init(a)},
cancel:function(a){a.form.hide().remove();a.prop_section.removeClass("editing");a=c(">.data-section",a.prop_section);c(".data-table tr, .data-list li",a).filter(":not(.empty-row)").length||c(".data-table tr.empty-row, .data-list li.empty-row",a).show()},submit:function(a){if(!a.form.is(".loading")){document.activeElement&&c(document.activeElement).blur();h.clear_form_message(a);if(a.validate)if(!a.validate(a))return;a.form.addClass("loading");a.submit&&a.submit(a)}},data_input_required:function(a,
i){var f=i.prev(".form-label").text();h.form_error(a,"Required: "+f)},data_input_invalid:function(a,i){var f=i.prev(".form-label").text();h.form_error(a,"Invalid: "+f)},form_error:function(a,i){return h.form_message(a,i,"error")},form_message:function(a,i,f){var k=c('<a class="close-msg" href="#">x</a>').click(function(){c(this).parents("tr:first").remove();return false});i=c("<span>").text(i);k=c("<td>").append(k).append(i);k=c('<tr class="row-msg">').append(k);f&&k.addClass("row-msg-"+f);(a.prop_row||
c(".edit-row",a.form)).before(k);return k},clear_form_message:function(a){a.prop_row?a.prop_row.prev(".row-msg").remove():c(".row-msg",a.form).remove()},ajax_error:function(a,i){var f;try{f=JSON.parse(a.responseText);if(f.messages&&f.messages.length)f=JSON.stringify(f.messages[0])}catch(k){}if(!f)f=a.responseText;h.form_error(i,f);i.form.removeClass("loading")}}})(jQuery,window.propbox);
