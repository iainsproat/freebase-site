
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
(function(e,c){c.require("dojo.date.stamp");c.require("dojo.date.locale");c.require("dojo.number");e.fn.validate_input=function(b){return this.each(function(){var a=e(this);if(a.is(":text")){var d=a.data("$.validate_input");d&&d._destroy();d=new f(this,b);a.data("$.validate_input",d)}})};var f=e.validate_input=function(b,a){var d=this.options=e.extend(true,{},f.defaults,a);if(typeof d.validator!=="function")throw"A validator is required";if(!d.lang)d.lang="/lang/en";d.lang=d.lang==="/lang/en"?["lang/en"]:
[d.lang,"/lang/en"];d.locales=[];e.each(d.lang,function(h,i){d.locales[h]=c.i18n.normalizeLocale(i.split("/").pop())});this.input=e(b);this.init();var g=this;this.input.bind("remove",function(){g._destroy()});return this};f.prototype={init:function(){var b=this;this.input.bind("keyup.validate_input",function(a){b.textchange(a)}).bind(e.browser.msie?"paste.validate_input":"input.validate_input",function(a){b.textchange(a)}).bind("keypress.validate_input",function(a){a.keyCode===13&&b.validate(true)}).bind("blur.validate_input",
function(){b.validate(true)})},_destroy:function(){this.input.unbind(".validate_input")},valid:function(b){this.input.trigger("valid",b)},invalid:function(b,a){this.input.trigger("invalid",a)},empty:function(){this.input.trigger("empty")},textchange:function(){clearTimeout(this.textchange_timeout);var b=this;this.textchange_timeout=setTimeout(function(){b.validate()},200)},validate:function(b){b&&clearTimeout(this.textchange_timeout);b=this.options;var a=e.trim(this.input.val());if(a==="")return this.empty();
try{return this.valid(b.validator(a,b))}catch(d){return this.invalid(a,""+d)}}};e.extend(f,{defaults:{validator:function(b){return{text:b,value:b}}},log:function(){},invalid:function(b,a,d,g){throw new Error("Invalid "+d+(g?": "+g:""));},text:function(b,a){if(b.lengh>4096)return this.invalid(b,a,type,"Text too long");return{text:b,value:b}},topic:function(){return f.defaults.validator},enumerated:function(){return f.defaults.validator},"boolean":function(){return f.defaults.validator},uri:function(b,
a){var d=f.uri.regex;if(!d)d=f.uri.regex=/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
if(d.test(b))return{text:b,value:b};return f.invalid(b,a,"uri")},"int":function(b,a){return f.number.parse(b,a,false)},"float":function(b,a){return f.number.parse(b,a,true)},number:function(b,a,d){return f.number.parse(b,a,d)},datetime:function(b,a){return f.datetime.parse(b,a)},mqlkey:function(b,a){var d=f.mqlkey.regex;if(!d)d=f.mqlkey.regex=/^[A-Za-z0-9][A-Za-z0-9_-]*$/;if(d.test(b))return{text:b,value:b};return f.invalid(b,a,"mqlkey")}});e.extend(f.number,{parse:function(b,a,d){var g=a&&a.locales||
["en"],h,i;h=0;for(i=g.length;h<i;h++){var l=g[h];a=c.number.parse(b,{locale:l});if(!isNaN(a)){b={};if(d){b.value=a;b.text=c.number.format(a,{locale:l})}else{b.value=c.number.round(a,0);b.text=c.number.format(b.value,{locale:l})}return b}}throw f.invalid("number",b);}});e.extend(f.datetime,{formats:["yyyy",["dateFormatItem-y"],"yyyy-MM",["dateFormatItem-yM","dateFormatItem-yMMM"],"yyyy-MM-dd",["dateFormat-short","dateFormat-medium","dateFormat-long"]],parse:function(b,a){if(!c.date.stamp._isoRegExp)c.date.stamp._isoRegExp=
/^(?:(-?\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(.\d+)?)?((?:[+-](\d{2}):(\d{2}))|Z)?)?$/;var d=c.date.stamp.fromISOString(b);if(d)return{text:b,value:b,date:d};var g=a&&a.locales||["en"],h,i,l,j,k,m;h=0;for(i=g.length;h<i;h++){var n=g[h],o=c.date.locale._getGregorianBundle(n);l=0;for(j=f.datetime.formats.length;l<j;l+=2){var p=f.datetime.formats[l],r=f.datetime.formats[l+1];k=0;for(m=r.length;k<m;k++){var q=o[r[k]];if(q){q=i18n.normalize_pattern(q);try{d=c.date.locale.parse(b,
{datePattern:q,selector:"date",locale:n});return{text:b,value:c.date.locale.format(d,{datePattern:p,selector:"date"}),date:d}}catch(s){}}}}}throw f.invalid("datetime",b);}})})(jQuery,dojo);
(function(e){e.fn.data_input=function(c){return this.each(function(){var f=e(this),b=f.data("$.data_input");b&&b._destroy();b=new e.data_input(this,c);f.data("$.data_input",b)})};e.data_input=function(c,f){this.options=e.extend(true,{},e.data_input.defaults,f);this.container=e(c);this.metadata=this.container.metadata();this.input=e(":input",this.container);this.init();var b=this;this.input.bind("remove",function(){b._destroy()})};e.data_input.prototype={init:function(){var c=this,f=this.container,
b=this.input,a=this.options;b.bind("focusin.data_input",function(){c.container.addClass("focus")}).bind("focusout.data_input",function(){c.container.removeClass("focus")}).bind("valid.data_input",function(d,g){var h={name:c.input.attr("name")};if(g.id)h.id=g.id;else{h.value=g.value;if(c.metadata.type==="/type/text")h.lang=c.metadata.lang||a.lang}c.container.data("data",h);c.container.removeClass("error").addClass("valid");c.container.trigger("valid")}).bind("invalid.data_input",function(){c.container.removeData("data");
c.container.removeClass("valid").addClass("error");c.container.trigger("invalid")}).bind("empty.data_input",function(){var d={name:c.input.attr("name")};if(c.metadata&&c.metadata.lang)d.lang=c.metadata.lang;c.container.data("data",d);c.container.removeClass("valid").removeClass("error");c.container.trigger("empty")}).bind("keypress.data_input",function(d){d.keyCode===13&&!d.isDefaultPrevented()&&c.container.trigger("submit")}).bind("keyup.data_input",function(d){d.keyCode===27&&c.container.trigger("cancel")});
if(f.is(".topic")){f=e.extend(true,{},a.suggest,e.data_input.suggest_options(c.metadata.type));b.validate_topic(f).bind("valid.data_input",function(d,g){c.fb_select(g)}).bind("invalid.data_input",function(){c.fb_textchange()});if(this.metadata&&this.metadata.id){b.data("data.suggest",this.metadata);this.validate()}}else if(f.is(".text"))b.validate_input({validator:e.validate_input.text});else if(f.is(".datetime"))b.validate_input({validator:e.validate_input.datetime,lang:a.lang});else if(f.is(".enumerated")){b.validate_enumerated().bind("valid.data_input",
function(d,g){c.fb_select(g)}).bind("invalid.data_input",function(){c.fb_textchange()});this.metadata&&this.metadata.id&&this.validate()}else if(f.is(".int"))b.validate_input({validator:e.validate_input["int"],lang:a.lang});else if(f.is(".float"))b.validate_input({validator:e.validate_input["float"],lang:a.lang});else if(f.is(".uri"))b.validate_input({validator:e.validate_input.uri});else if(f.is(".boolean"))b.validate_boolean();else if(f.is(".enumeration"))b.validate_input({validator:e.validate_input.mqlkey});
else if(f.is(".rawstring"))b.validate_input({validator:e.validate_input.text});else throw new Error("Invalid data-input: "+f.attr("class"));},_destroy:function(){this.input.unbind(".data_input")},validate:function(){var c=this.input;e.each(["$.validate_topic","$.validate_input","$.validate_enumerated","$.validate_boolean"],function(f,b){var a=c.data(b);if(a){a.validate(true);return false}})},reset:function(){this.container.removeData("data");if(this.input.is(":text"))this.input.val("");else if(this.input.is("select"))this.input[0].selectedIndex=
0;else this.input.is(":radio")&&this.input.each(function(){this.checked=false})},fb_textchange:function(){},fb_select:function(){},ajax_beforeSend:function(c){if(!this.xhr_queue)this.xhr_queue=[];this.xhr_queue.push(c);this.container.trigger("loading")},ajax_complete:function(c){if(!this.xhr_queue)this.xhr_queue=[];for(var f=0,b=this.xhr_queue.length;f<b;f++)if(c===this.xhr_queue[f]){this.xhr_queue.splice(f,1);break}this.xhr_queue.length===0&&this.container.trigger("loading_complete")}};e.extend(e.data_input,
{defaults:{suggest:{service_url:"http://www.freebase.com",service_path:"/private/suggest",flyout_service_url:"http://www.freebase.com",flyout_service_path:"/private/flyout",mqlread_url:"http://api.freebase.com/api/service/mqlread",category:"object",type:"/common/topic"}},is_metaweb_system_type:function(c){return c.indexOf("/type/")===0||c.indexOf("/common/")===0&&c!=="/common/topic"||c.indexOf("/freebase/")===0&&c.indexOf("_profile")===c.length-8},suggest_options:function(c){var f={category:"instance",
type:c,type_strict:e.data_input.is_metaweb_system_type(c)?"any":"should"},b=["any","type:"+c,"without:fus","without:inst"];e.each(["user","domain","type"],function(a,d){if(c==="/freebase/"+d+"_profile"){b.push("type:/type/"+d);return false}});c==="/book/book_subject"&&b.push("type:/base/skosbase/skos_concept");f.filter="("+b.join(" ")+")";return f}});e.fn.validate_topic=function(c){return this.each(function(){var f=e(this);if(f.is(":text")){var b=f.data("$.validate_topic");b&&b._destroy();b=new e.validate_topic(this,
c);f.data("$.validate_topic",b)}})};e.validate_topic=function(c,f){this.options=e.extend(true,{},f);this.input=e(c);this.init()};e.validate_topic.prototype={init:function(){var c=this;this.input.suggest(this.options).bind("fb-textchange.validate_topic",function(){c.input.val()===""?c.empty():c.invalid()}).bind("fb-select.validate_topic",function(f,b){c.input.val(b.name!=null?b.name:b.id);c.valid(b)})},invalid:function(){this.input.trigger("invalid")},valid:function(c){this.input.trigger("valid",c)},
empty:function(){this.input.trigger("empty")},_destroy:function(){this.input.unbind(".validate_topic")},validate:function(){if(this.input.val()==="")this.empty();else{var c=this.input.data("data.suggest");c?this.valid(c):this.invalid()}}};e.fn.validate_enumerated=function(c){return this.each(function(){var f=e(this);if(f.is("select")){var b=f.data("$.validate_enumerated");b&&b._destroy();b=new e.validate_enumerated(this,c);f.data("$.validate_enumerated",b)}})};e.validate_enumerated=function(c,f){this.options=
e.extend(true,{},f);this.input=e(c);this.init()};e.validate_enumerated.prototype={init:function(){var c=this;this.input.bind("change.validate_enumerated, keypress.validate_enumerated",function(){this.selectedIndex===0?c.empty():c.valid({text:e(":selected",this).text(),id:this.value})})},invalid:function(){this.input.trigger("invalid")},valid:function(c){this.input.trigger("valid",c);this.input.trigger("fb-select",c)},empty:function(){this.input.trigger("empty")},_destroy:function(){this.input.unbind(".validate_enumerated")},
validate:function(){var c=this.input[0];c.selectedIndex>0?this.valid({text:e(":selected",this.input).text(),id:c.value}):this.empty()}};e.fn.validate_boolean=function(c){var f,b;this.each(function(){var d=e(this);if(d.is(":radio"))if(d.val().toLowerCase()==="true")f=d;else if(d.val().toLowerCase()==="false")b=d});if(f&&b){var a=f.data("$.validate_boolean");a&&a._destroy();a=new e.validate_boolean(f,b,c);f.data("$.validate_boolean",a)}return this};e.validate_boolean=function(c,f,b){this.options=e.extend(true,
{},b);this.tradio=c;this.fradio=f;this.input=this.tradio;this.init()};e.validate_boolean.prototype={init:function(){var c=this;this.tradio.bind("change.validate_boolean",function(){c.validate()})},_destroy:function(){this.input.unbind(".validate_boolean")},valid:function(c){this.input.trigger("valid",c)},empty:function(){this.input.trigger("empty")},validate:function(){if(this.tradio.is(":checked"))this.valid({text:this.tradio.text(),value:true});else this.fradio.is(":checked")?this.valid({text:this.fradio.text(),
value:false}):this.empty()}}})(jQuery);
(function(e){var c=window.editparams={Empty:function(f,b,a){this.structure=f;this.data=b;this.msg=a;this.toString=function(){return"Empty: "+this.msg}},Invalid:function(f,b,a){this.structure=f;this.data=b;this.msg=a;this.toString=function(){return"Invalid: "+this.msg}},parse:function(f,b){function a(l,j,k,m,n){try{c.validate(j,k);n.push(k)}catch(o){if(o instanceof c.Empty)n.push(k);else throw o;}}var d=(f.values||[]).slice(),g=f.properties||[],h=f.expected_type.mediator;if(h){if(!g.length)throw new c.Invalid(f,
null,"mediator musth have 1 or more properties");if(d.length&&d.length!==1)throw new c.Invalid(f,null,"Can't edit more than one value (row) for a mediator");}var i=[];e(".data-input",b).each(function(){var l=e(this),j=l.data("$.data_input");if(!j)throw new c.Invalid(f,null,"$.data-input not initialized for",this);j.validate(true);if(l.is(".error"))throw new c.Invalid(f,null,"$.data-input is invalid",this);j=l.data("data");if(!j)throw new c.Invalid(f,null,"$.data-input has no data",this);if(h){if(!i.length){i.push({});
e.each(g,function(n,o){i[0][o.id]=e.extend({},o,{values:[]})})}var k=i[0][j.name];if(k){var m=[];if(d.length)m=(m=d[0][k.id])&&m.values||[];a(l,k,j,m,k.values)}else console.warn("editparams","unknown mediator property data",j)}else a(l,f,j,d,i)});return h?c.parse_mediator(f,d,i):c.parse_simple(f,d,i)},parse_mediator:function(f,b,a){if(a.length!==1)throw new c.Invalid(f,a,"Must specify one (new or updated) value for a mediator");a=a[0];var d;if(b.length)d=b[0];b={};if(d)b.id=d.id;else{b.id=null;b.create=
"unconditional";b.connect=f.unique?"replace":"insert";var g=[];f.expected_type.id!=="/type/object"&&g.push({id:f.expected_type.id,connect:"insert"});var h=f.expected_type.included_types;h&&h.forEach(function(m){m!=="/type/object"&&g.push({id:m,connect:"insert"})});if(g.length)b.type=g}h=false;f=f.properties;for(var i=0,l=f.length;i<l;i++){var j=f[i],k=c.parse_simple(j,d&&d[j.id]&&d[j.id].values||[],a[j.id]&&a[j.id].values||[]);if(k.length){b[j.id]=k;h=true}}return h?[b]:[]},parse_simple:function(f,
b,a){return c.diff(f,b,a)},diff:function(f,b,a){var d=f.expected_type,g=f.expected_type.id,h=f.unique,i=g==="/type/text";if(h)if(!i)if(b.length&&b.length!==1)throw new c.Invalid(f,b,"Can't edit more than one value (row) for a unique property.");else if(a.length&&a.length!==1)throw new c.Invalid(f,a,"Can't edit more than one value (row) for a unique property.");var l=[];if(c.LITERAL_TYPE_IDS[g]){l.push("value");i&&l.push("lang")}else l.push("id");g=[];var j=[],k,m;k=0;for(m=b.length;k<m;k++){var n=
b[k];c.validate(f,n);c.inArray.apply(null,[n,a].concat(l))===-1&&g.push(c.clause(n,"delete"))}k=0;for(m=a.length;k<m;k++){n=a[k];try{c.validate(f,n)}catch(o){continue}if(c.inArray.apply(null,[n,b].concat(l))===-1){if(h)if(i){var p=c.inArray(n,g,"lang");p!==-1&&g.splice(p,1)}else return[c.clause(n,"replace",d)];j.push(c.clause(n,h?"replace":"insert",d))}}return g.concat(j)},validate:function(f,b){var a=f.expected_type.id;if(c.LITERAL_TYPE_IDS[a])if(c.isEmpty(b.value))throw new c.Empty(f,b);else{if(a===
"/type/text"&&c.isEmpty(b.lang))throw new c.Invalid(f,b,"Expected data.lang for /type/text");if(a==="/type/int"||a==="/type/float"){if(e.type(b.value)!=="number")throw new c.Invalid(f,b,"Expected number data.value for "+a);}else if(a==="/type/boolean"){if(e.type(b.value)!=="boolean")throw new c.Invalid(f,b,"Expected boolean data.value for /type/boolean");}else if(e.type(b.value)!=="string")throw new c.Invalid(f,b,"Expected string data.value for "+a);}else if(c.isEmpty(b.id))throw new c.Empty(f,b);
return b},clause:function(f,b,a){var d={connect:b};if(f.id){d.id=f.id;if(b!=="delete"&&a&&!a.enumeration){var g=[];a.id!=="/type/object"&&g.push({id:a.id,connect:"insert"});(f=a.included_types)&&f.forEach(function(h){h!=="/type/object"&&g.push({id:h,connect:"insert"})});if(g.length)d.type=g}}else{d.value=f.value;if(f.lang)d.lang=f.lang}return d},inArray:function(f,b){var a=Array.prototype.slice.call(arguments,2);if(!a.length)return e.inArray(f,b);for(var d=0,g=b.length;d<g;d++){for(var h=b[d],i=true,
l=0,j=a.length;l<j;l++){var k=a[l];if(h[k]!=f[k]){i=false;break}}if(i)return d}return-1},isEmpty:function(f){return f==null||f===""},LITERAL_TYPE_IDS:{"/type/int":1,"/type/float":1,"/type/boolean":1,"/type/rawstring":1,"/type/uri":1,"/type/text":1,"/type/datetime":1,"/type/id":1,"/type/key":1,"/type/value":1,"/type/enumeration":1}}})(jQuery);
(function(e,c,f){var b=c.edit={prop_add_begin:function(a,d){var g={s:c.options.id,p:a.attr("data-id"),lang:c.options.lang};e.ajax({url:c.options.base_ajax_url+"/prop_add_begin.ajax",data:g,dataType:"json",success:function(h,i,l){if(h.code!=="/api/status/ok")return b.ajax_error(l,null,a);h=e(h.result.html).hide();var j={mode:"add",event_prefix:"propbox.edit.prop_add.",ajax:{data:g,url:c.options.base_ajax_url+"/prop_edit_submit.ajax"},init:b.init_prop_add_form,submit:b.submit_prop_add_form,prop_section:a,
msg_row:e(".row-msg",h),edit_row:e(".edit-row",h),submit_row:e(".edit-row-submit",h),structure:h.metadata()};b.init(j);j.edit_row.bind("propbox.edit.prop_add.success",function(){if(d)j.edit_row.trigger(j.event_prefix+"cancel");else{b.reset_data_inputs(j);e(":input:visible:first",j.edit_row).focus();e(".button-submit",j.submit_row).attr("disabled","disabled").addClass("disabled");e(".button-cancel",j.submit_row).text("Done")}})},error:function(h){b.ajax_error(h,null,a)}})},init_prop_add_form:function(a){b.init_data_inputs(a);
e(":input:visible:first",a.edit_row).focus()},submit_prop_add_form:function(a){var d=e.extend({},a.ajax.data);try{var g=f.parse(a.structure,a.edit_row);d.o=JSON.stringify(g)}catch(h){d=e(".data-input.error",a.edit_row);if(d.length){a.edit_row.trigger(a.event_prefix+"error","Please specify a valid value");d.eq(0).find(":input").focus().select()}else a.edit_row.trigger(a.event_prefix+"error",h.toString());return}e.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:d,success:function(i,l,j){if(i.code!==
"/api/status/ok")return b.ajax_error(j,a);i=e(i.result.html);a.msg_row.before(i);i18n.ize(i);e(".edit",i).show();c.init_menus(i,true);c.kbs.set_next(null,i,true);a.edit_row.trigger(a.event_prefix+"success")},error:function(i){b.ajax_error(i,a)}})},value_edit_begin:function(a,d){var g;if(d.is("tr"))g=d.attr("data-id");else{g=e(".property-value:first",d);g=g.attr("data-id")||g.attr("data-value")||g.attr("datetime")}var h={s:c.options.id,p:a.attr("data-id"),replace:g,lang:c.options.lang};e.ajax({url:c.options.base_ajax_url+
"/value_edit_begin.ajax",data:h,dataType:"json",success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,null,a,d);i=e(i.result.html).hide();var k={mode:"edit",event_prefix:"propbox.edit.value_edit.",ajax:{data:h,url:c.options.base_ajax_url+"/prop_edit_submit.ajax"},init:b.init_value_edit_form,submit:b.submit_value_edit_form,prop_section:a,prop_row:d,msg_row:e(".row-msg",i),edit_row:e(".edit-row",i),submit_row:e(".edit-row-submit",i),structure:i.metadata()};b.init(k);k.edit_row.bind("propbox.edit.value_edit.success",
function(){k.msg_row.remove();k.edit_row.remove();k.submit_row.remove()}).bind("propbox.edit.value_edit.cancel",function(){k.prop_row.show()}).bind("propbox.edit.value_edit.delete",function(){b.loading_begin(k);c.edit.value_delete_begin(a,d,function(){k.msg_row.remove();k.edit_row.remove();k.submit_row.remove()})})},error:function(i){b.ajax_error(i,null,a,d)}})},init_value_edit_form:function(a){b.init_data_inputs(a);e(":input:visible:first",a.edit_row).focus()},submit_value_edit_form:function(a){var d=
e.extend({},a.ajax.data);try{var g=f.parse(a.structure,a.edit_row);d.o=JSON.stringify(g)}catch(h){d=e(".data-input.error",a.edit_row);if(d.length){a.edit_row.trigger(a.event_prefix+"error","Please specify a valid value");d.eq(0).find(":input").focus().select()}else a.edit_row.trigger(a.event_prefix+"error",h.toString());return}e.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:d,success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,a);i=e(i.result.html);a.prop_row.after(i);
i18n.ize(i);e(".edit",i).show();c.init_menus(i,true);c.kbs.set_next(null,i,true);a.prop_row.remove();a.edit_row.trigger(a.event_prefix+"success")},error:function(i){b.ajax_error(i,a)}})},value_delete_begin:function(a,d,g){var h;if(d.is("tr"))h=d.attr("data-id");else{h=e(".property-value:first",d);h=h.attr("data-id")||h.attr("data-value")||h.attr("datetime")}h={s:c.options.id,p:a.attr("data-id"),o:h,lang:c.options.lang};e.ajax({url:c.options.base_ajax_url+"/value_delete_submit.ajax",type:"POST",data:h,
dataType:"json",success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,null,a,d);i=e(i.result.html);d.before(i);d.hide();a.removeClass("editing");g&&g()},error:function(i){b.ajax_error(i,null,a,d)}})},value_delete_undo:function(a){var d=e(a).parents(".row-msg:first"),g=d.next(".data-row:hidden"),h=g.parents(".property-section");if(g.is("tr"))a=g.attr("data-id");else{a=e(".property-value:first",g);a=a.attr("data-id")||a.attr("data-value")||a.attr("datetime")}a={s:c.options.id,p:h.attr("data-id"),
o:a,lang:c.options.lang};e.ajax({url:c.options.base_ajax_url+"/value_delete_undo.ajax",type:"POST",data:a,dataType:"json",success:function(i,l,j){if(i.code!=="/api/status/ok")return b.ajax_error(j,null,h,g);g.show();d.remove()},error:function(i){b.ajax_error(i,null,h,g)}});return false},loading_begin:function(a){e.each([a.edit_row,a.msg_row,a.submit_row],function(d,g){g&&g.addClass("loading")})},loading_complete:function(a){e.each([a.edit_row,a.msg_row,a.submit_row],function(d,g){g&&g.removeClass("loading")})},
init_data_inputs:function(a){e(".data-input",a.edit_row).each(function(){b.init_data_input(e(this),a)})},init_data_input:function(a,d){a.data_input({lang:c.options.lang,suggest:c.options.suggest}).bind("valid",function(){d.edit_row.trigger(d.event_prefix+"valid");var g=a.parent(".form-field"),h=g.next(".magicbox-template");if(h.length){h=e("<div>").html(h.html());h=e(".form-field",h);g.after(h);b.init_data_input(e(".data-input",h),d)}}).bind("empty",function(){d.edit_row.trigger(d.event_prefix+"valid")}).bind("invalid",
function(){d.edit_row.trigger(d.event_prefix+"invalid")}).bind("submit",function(){d.edit_row.trigger(d.event_prefix+"submit")}).bind("cancel",function(){d.edit_row.trigger(d.event_prefix+"cancel")}).bind("loading",function(){e(this).addClass("loading")}).bind("loading_complete",function(){e(this).removeClass("loading")});if(a.is(".datetime"))i18n.ize_datetime_input(e(":text",a));else if(a.is(".int")||a.is(".float"))i18n.ize_number_input(e(":text",a))},reset_data_inputs:function(a){e(".data-input",
a.edit_row).each(function(){e(this).data("$.data_input").reset()})},init:function(a){if(a.mode==="add"){var d=e(">.data-section",a.prop_section);e("> .data-table > tbody > .empty-row, > .data-list > .empty-row",d).hide();e("> .data-table > tbody, > .data-list",d).append(a.msg_row).append(a.edit_row).append(a.submit_row)}else if(a.mode==="edit"){a.prop_row.hide();a.prop_row.after(a.msg_row);a.msg_row.after(a.edit_row);a.edit_row.after(a.submit_row)}e(".data-table > thead",a.prop_section).show();var g=
a.event_prefix||"propbox.edit.";a.edit_row.bind(g+"valid",function(){e(".button-submit",a.submit_row).removeAttr("disabled").removeClass("disabled")}).bind(g+"invalid",function(){e(".button-submit",a.submit_row).attr("disabled","disabled").addClass("disabled")}).bind(g+"submit",function(){b.submit(a)}).bind(g+"cancel",function(){b.cancel(a)}).bind(g+"error",function(h,i){b.error(a,i);b.loading_complete(a);a.prop_section.removeClass("editing")}).bind(g+"success",function(){b.loading_complete(a);a.prop_section.removeClass("editing")});
e(".button-submit",a.submit_row).click(function(){a.edit_row.trigger(g+"submit")});e(".button-cancel",a.submit_row).click(function(){a.edit_row.trigger(g+"cancel")});e(".button-delete",a.submit_row).click(function(){a.edit_row.trigger(g+"delete")});a.edit_row.show();a.submit_row.show();c.kbs.scroll_to(a.prop_section);a.init&&a.init(a)},cancel:function(a){a.msg_row.remove();a.edit_row.remove();a.submit_row.remove();a.prop_section.removeClass("editing");a=e(">.data-section",a.prop_section);e("> .data-table > tbody > tr, > .data-list > li",
a).filter(":not(.empty-row)").length||e("> .data-table > tbody > .empty-row, > .data-list > .empty-row",a).show()},submit:function(a){if(!a.edit_row.is(".loading"))if(!e(".button-submit",a.submit_row).is(":disabled")){document.activeElement&&e(document.activeElement).blur();b.clear_form_message(a);b.loading_begin(a);a.submit&&a.submit(a)}},error:function(a,d){e(".button-submit",a.submit_row).attr("disabled","disabled").addClass("disabled");return b.form_message(a,d,"error")},form_message:function(a,
d,g){a.msg_row.find(".close-msg").css("visibility","visible").next().find(".msg-default").hide().next().text(d);a.msg_row.attr("class","row-msg");g&&a.msg_row.addClass("row-msg-"+g)},clear_form_message:function(a){a.msg_row.find(".close-msg").css("visibility","hidden").next().find(".msg-default").show().next().html("&nbsp;")},ajax_error:function(a,d,g,h){a=a.responseText;if(d)d.edit_row.trigger(d.event_prefix+"error",a);else{d=e(".data-table",g);a=d.length?b.row_msg(a,"error","tr",e(">thead>tr:first>th",
d).length):b.row_msg(a,"error","li");if(h){h.before(a);h.is(".edit-row")?h.removeClass("loading"):g.removeClass("editing")}else{d.length?e(">tbody",d).append(a):e(".data-list",g).append(a);g.removeClass("editing")}}},row_msg:function(a,d,g,h){var i=e('<a class="close-msg" href="#">x</a>').click(function(){e(this).parents(".row-msg:first").remove();return false}),l=e("<span>").text(a);a=e("<"+g+' class="row-msg">');if(g==="tr"){g=e("<td>").append(i).append(l);h&&g.attr("colspan",h);a.append(g)}else a.append(i).append(l);
d&&a.addClass("row-msg-"+d);return a}}})(jQuery,window.propbox,window.editparams);
