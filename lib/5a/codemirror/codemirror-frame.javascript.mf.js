
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
function method(f,n){return function(){f[n].apply(f,arguments)}}var StopIteration={toString:function(){return"StopIteration"}};function forEach(f,n){if(f.next)try{for(;;)n(f.next())}catch(k){if(k!=StopIteration)throw k;}else for(var l=0;l<f.length;l++)n(f[l])}function map(f,n){var k=[];forEach(f,function(l){k.push(n(l))});return k}function matcher(f){return function(n){return f.test(n)}}function hasClass(f,n){var k=f.className;return k&&(new RegExp("(^| )"+n+"($| )")).test(k)}
function insertAfter(f,n){n.parentNode.insertBefore(f,n.nextSibling);return f}function removeElement(f){f.parentNode&&f.parentNode.removeChild(f)}function clearElement(f){for(;f.firstChild;)f.removeChild(f.firstChild)}function isAncestor(f,n){for(;n=n.parentNode;)if(f==n)return true;return false}var nbsp="\u00a0",matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("};
function normalizeEvent(f){if(!f.stopPropagation){f.stopPropagation=function(){this.cancelBubble=true};f.preventDefault=function(){this.returnValue=false}}if(!f.stop)f.stop=function(){this.stopPropagation();this.preventDefault()};if(f.type=="keypress"){f.code=f.charCode==null?f.keyCode:f.charCode;f.character=String.fromCharCode(f.code)}return f}
function addEventHandler(f,n,k,l){function p(r){k(normalizeEvent(r||window.event))}if(typeof f.addEventListener=="function"){f.addEventListener(n,p,false);if(l)return function(){f.removeEventListener(n,p,false)}}else{f.attachEvent("on"+n,p);if(l)return function(){f.detachEvent("on"+n,p)}}}function nodeText(f){return f.textContent||f.innerText||f.nodeValue||""}function nodeTop(f){for(var n=0;f.offsetParent;){n+=f.offsetTop;f=f.offsetParent}return n}
function isBR(f){f=f.nodeName;return f=="BR"||f=="br"}function isSpan(f){f=f.nodeName;return f=="SPAN"||f=="span"}
var stringStream=function(f){function n(){for(;l==k.length;){p+=k;k="";l=0;try{k=f.next()}catch(r){if(r!=StopIteration)throw r;else return false}}return true}var k="",l=0,p="";return{peek:function(){if(!n())return null;return k.charAt(l)},next:function(){if(!n())if(p.length>0)throw"End of stringstream reached without emptying buffer ('"+p+"').";else throw StopIteration;return k.charAt(l++)},get:function(){var r=p;p="";if(l>0){r+=k.slice(0,l);k=k.slice(l);l=0}return r},push:function(r){k=k.slice(0,
l)+r+k.slice(l)},lookAhead:function(r,w,i,b){function a(j){return b?j.toLowerCase():j}r=a(r);var c=false,d=p,e=l;for(i&&this.nextWhileMatches(/[\s\u00a0]/);;){i=l+r.length;var g=k.length-l;if(i<=k.length){c=r==a(k.slice(l,i));l=i;break}else if(r.slice(0,g)==a(k.slice(l))){p+=k;k="";try{k=f.next()}catch(h){break}l=0;r=r.slice(g)}else break}if(!(c&&w)){k=p.slice(d.length)+k;l=e;p=d}return c},more:function(){return this.peek()!==null},applies:function(r){var w=this.peek();return w!==null&&r(w)},nextWhile:function(r){for(var w;(w=
this.peek())!==null&&r(w);)this.next()},matches:function(r){var w=this.peek();return w!==null&&r.test(w)},nextWhileMatches:function(r){for(var w;(w=this.peek())!==null&&r.test(w);)this.next()},equals:function(r){return r===this.peek()},endOfLine:function(){var r=this.peek();return r==null||r=="\n"}}},select={};
(function(){function f(a,c){for(;a&&a.parentNode!=c;)a=a.parentNode;return a}function n(a,c){for(;!a.previousSibling&&a.parentNode!=c;)a=a.parentNode;return f(a.previousSibling,c)}function k(a){var c=a.nextSibling;if(c){for(;c.firstChild;)c=c.firstChild;return c.nodeType==3||isBR(c)?c:k(c)}else{for(a=a.parentNode;a&&!a.nextSibling;)a=a.parentNode;return a&&k(a)}}select.ie_selection=document.selection&&document.selection.createRangeCollection;select.scrollToNode=function(a,c){if(a){for(var d=a,e=document.body,
g=document.documentElement,h=!d.nextSibling||!d.nextSibling.nextSibling||!d.nextSibling.nextSibling.nextSibling,j=0;d&&!d.offsetTop;){j++;d=d.previousSibling}if(j==0)h=false;if(!(webkit&&d&&d.offsetTop==5&&d.offsetLeft==5)){j=j*(d?d.offsetHeight:0);var m=0,q=a?a.offsetWidth:0;for(d=d;d&&d.offsetParent;){j+=d.offsetTop;isBR(d)||(m+=d.offsetLeft);d=d.offsetParent}d=e.scrollLeft||g.scrollLeft||0;e=e.scrollTop||g.scrollTop||0;var s=false,t=window.innerWidth||g.clientWidth||0;if(c||q<t){if(c){var v=select.offsetInNode(a),
z=nodeText(a).length;if(z)m+=q*(v/z)}q=m-d;if(q<0||q>t){d=m;s=true}}m=j-e;if(m<0||h||m>(window.innerHeight||g.clientHeight||0)-50){e=h?1E6:j;s=true}s&&window.scrollTo(d,e)}}};select.scrollToCursor=function(a){select.scrollToNode(select.selectionTopNode(a,true)||a.firstChild,true)};var l=null;select.snapshotChanged=function(){if(l)l.changed=true};select.snapshotReplaceNode=function(a,c,d,e){function g(h){if(a==h.node){l.changed=true;if(d&&h.offset>d)h.offset-=d;else{h.node=c;h.offset+=e||0}}else if(select.ie_selection&&
h.offset==0&&h.node==k(a))l.changed=true}if(l){g(l.start);g(l.end)}};select.snapshotMove=function(a,c,d,e,g){function h(j){if(a==j.node&&(!g||j.offset==0)){l.changed=true;j.node=c;j.offset=e?Math.max(0,j.offset+d):d}}if(l){h(l.start);h(l.end)}};if(select.ie_selection){var p=function(a){function c(q){for(var s=null;!s&&q;){s=q.nextSibling;q=q.parentNode}return d(s)}function d(q){for(;q&&q.firstChild;)q=q.firstChild;return{node:q,offset:0}}var e=document.selection.createRange();e.collapse(a);a=e.parentElement();
if(!isAncestor(document.body,a))return null;if(!a.firstChild)return d(a);var g=e.duplicate();g.moveToElementText(a);g.collapse(true);for(var h=a.firstChild;h;h=h.nextSibling){if(h.nodeType==3){var j=h.nodeValue.length;g.move("character",j)}else{g.moveToElementText(h);g.collapse(false)}var m=e.compareEndPoints("StartToStart",g);if(m==0)return c(h);if(m!=1){if(h.nodeType!=3)return d(h);g.setEndPoint("StartToEnd",e);return{node:h,offset:j-g.text.length}}}return c(a)};select.markSelection=function(){l=
null;if(document.selection){var a=p(true),c=p(false);if(a&&c)l={start:a,end:c,changed:false}}};select.selectMarked=function(){function a(e){var g=document.body.createTextRange(),h=e.node;if(h)if(h.nodeType==3){g.moveToElementText(h.parentNode);for(e=e.offset;h.previousSibling;){h=h.previousSibling;e+=(h.innerText||"").length}g.move("character",e)}else{g.moveToElementText(h);g.collapse(true)}else{g.moveToElementText(document.body);g.collapse(false)}return g}if(l&&l.changed){var c=a(l.start),d=a(l.end);
c.setEndPoint("StartToEnd",d);c.select()}};select.offsetInNode=function(a){var c=document.selection;if(!c)return 0;c=c.createRange();var d=c.duplicate();try{d.moveToElementText(a)}catch(e){return 0}c.setEndPoint("StartToStart",d);return c.text.length};select.selectionTopNode=function(a,c){function d(t,v){if(v.nodeType==3){for(var z=0,A=v.previousSibling;A&&A.nodeType==3;){z+=A.nodeValue.length;A=A.previousSibling}if(A){try{t.moveToElementText(A)}catch(u){return false}t.collapse(false)}else t.moveToElementText(v.parentNode);
z&&t.move("character",z)}else try{t.moveToElementText(v)}catch(y){return false}return true}var e=document.selection;if(!e)return false;var g=e.createRange(),h=g.duplicate();g.collapse(c);var j=g.parentElement();if(j&&isAncestor(a,j)){h.moveToElementText(j);if(g.compareEndPoints("StartToStart",h)==1)return f(j,a)}c=0;for(j=a.childNodes.length-1;c<j;){var m=Math.ceil((j+c)/2),q=a.childNodes[m];if(!q)return false;if(!d(h,q))return false;if(g.compareEndPoints("StartToStart",h)==1)c=m;else j=m-1}if(c==
0){e=e.createRange();g=e.duplicate();try{g.moveToElementText(a)}catch(s){return null}if(e.compareEndPoints("StartToStart",g)==0)return null}return a.childNodes[c]||null};select.focusAfterNode=function(a,c){var d=document.body.createTextRange();d.moveToElementText(a||c);d.collapse(!a);d.select()};select.somethingSelected=function(){var a=document.selection;return a&&a.createRange().text!=""};var r=function(a){var c=document.selection;if(c){c=c.createRange();c.pasteHTML(a);c.collapse(false);c.select()}};
select.insertNewlineAtCursor=function(){r("<br>")};select.insertTabAtCursor=function(){r("\u00a0\u00a0\u00a0\u00a0")};select.cursorPos=function(a,c){var d=document.selection;if(!d)return null;for(var e=select.selectionTopNode(a,c);e&&!isBR(e);)e=e.previousSibling;d=d.createRange();var g=d.duplicate();d.collapse(c);if(e){g.moveToElementText(e);g.collapse(false)}else{try{g.moveToElementText(a)}catch(h){return null}g.collapse(true)}d.setEndPoint("StartToStart",g);return{node:e,offset:d.text.length}};
select.setCursorPos=function(a,c,d){function e(h){var j=document.body.createTextRange();if(h.node){j.moveToElementText(h.node);j.collapse(false)}else{j.moveToElementText(a);j.collapse(true)}j.move("character",h.offset);return j}var g=e(c);d&&d!=c&&g.setEndPoint("EndToEnd",e(d));g.select()};select.getBookmark=function(a){var c=select.cursorPos(a,true);a=select.cursorPos(a,false);if(c&&a)return{from:c,to:a}};select.setBookmark=function(a,c){c&&select.setCursorPos(a,c.from,c.to)}}else{var w=function(a,
c){for(;a.nodeType!=3&&!isBR(a);){var d=a.childNodes[c]||a.nextSibling;for(c=0;!d&&a.parentNode;){a=a.parentNode;d=a.nextSibling}a=d;if(!d)break}return{node:a,offset:c}};select.markSelection=function(){var a=window.getSelection();if(!a||a.rangeCount==0)return l=null;a=a.getRangeAt(0);l={start:w(a.startContainer,a.startOffset),end:w(a.endContainer,a.endOffset),changed:false}};select.selectMarked=function(){function a(){if(d.start.node==d.end.node&&d.start.offset==d.end.offset){var g=window.getSelection();
if(!g||g.rangeCount==0)return true;g=g.getRangeAt(0);g=w(g.startContainer,g.startOffset);return d.start.node!=g.node||d.start.offset!=g.offset}}function c(g,h){if(g.node)g.offset==0?e["set"+h+"Before"](g.node):e["set"+h](g.node,g.offset);else e.setStartAfter(document.body.lastChild||document.body)}var d=l;if(d&&(d.changed||webkit&&a())){var e=document.createRange();c(d.end,"End");c(d.start,"Start");i(e)}};var i=function(a){var c=window.getSelection();if(c){c.removeAllRanges();c.addRange(a)}},b=function(){var a=
window.getSelection();return!a||a.rangeCount==0?false:a.getRangeAt(0)};select.selectionTopNode=function(a,c){var d=b();if(!d)return false;var e=c?d.startContainer:d.endContainer,g=c?d.startOffset:d.endOffset;window.opera&&!c&&d.endContainer==a&&d.endOffset==d.startOffset+1&&a.childNodes[d.startOffset]&&isBR(a.childNodes[d.startOffset])&&g--;return e.nodeType==3?g>0?f(e,a):n(e,a):e.nodeName.toUpperCase()=="HTML"?g==1?null:a.lastChild:e==a?g==0?null:e.childNodes[g-1]:g==e.childNodes.length?f(e,a):g==
0?n(e,a):f(e.childNodes[g-1],a)};select.focusAfterNode=function(a,c){var d=document.createRange();d.setStartBefore(c.firstChild||c);if(a&&!a.firstChild)d.setEndAfter(a);else a?d.setEnd(a,a.childNodes.length):d.setEndBefore(c.firstChild||c);d.collapse(false);i(d)};select.somethingSelected=function(){var a=b();return a&&!a.collapsed};select.offsetInNode=function(a){var c=b();if(!c)return 0;c=c.cloneRange();c.setStartBefore(a);return c.toString().length};select.insertNodeAtCursor=function(a){var c=b();
if(c){c.deleteContents();c.insertNode(a);webkitLastLineHack(document.body);if(window.opera&&isBR(a)&&isSpan(a.parentNode)){c=a.nextSibling;var d=a.parentNode,e=d.parentNode;e.insertBefore(a,d.nextSibling);for(d="";c&&c.nodeType==3;c=c.nextSibling){d+=c.nodeValue;removeElement(c)}e.insertBefore(makePartSpan(d,document),a.nextSibling)}c=document.createRange();c.selectNode(a);c.collapse(false);i(c)}};select.insertNewlineAtCursor=function(){select.insertNodeAtCursor(document.createElement("BR"))};select.insertTabAtCursor=
function(){select.insertNodeAtCursor(document.createTextNode("\u00a0\u00a0\u00a0\u00a0"))};select.cursorPos=function(a,c){var d=b();if(d){for(var e=select.selectionTopNode(a,c);e&&!isBR(e);)e=e.previousSibling;d=d.cloneRange();d.collapse(c);e?d.setStartAfter(e):d.setStartBefore(a);d=d.toString();return{node:e,offset:d.length}}};select.setCursorPos=function(a,c,d){function e(h,j,m){function q(z){z.nodeType==3?s.push(z):forEach(z.childNodes,q)}if(j==0&&h&&!h.nextSibling){g["set"+m+"After"](h);return true}if(h=
h?h.nextSibling:a.firstChild){if(j==0){g["set"+m+"Before"](h);return true}for(var s=[];;){for(;h&&!s.length;){q(h);h=h.nextSibling}var t=s.shift();if(!t)return false;var v=t.nodeValue.length;if(v>=j){g["set"+m](t,j);return true}j-=v}}}var g=document.createRange();d=d||c;e(d.node,d.offset,"End")&&e(c.node,c.offset,"Start")&&i(g)}}})();
function UndoHistory(f,n,k,l){this.container=f;this.maxDepth=n;this.commitDelay=k;this.editor=l;this.parent=l.parent;this.last=this.first=f={text:"",from:null,to:null};this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[]}
UndoHistory.prototype={scheduleCommit:function(){var f=this;this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(function(){f.tryCommit()},this.commitDelay)},touch:function(f){this.setTouched(f);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var f=this.history.pop();this.redoHistory.push(this.updateTo(f,"applyChain"));this.notifyEnvironment();return this.chainNode(f)}},redo:function(){this.commit();if(this.redoHistory.length){var f=this.redoHistory.pop();
this.addUndoLevel(this.updateTo(f,"applyChain"));this.notifyEnvironment();return this.chainNode(f)}},clear:function(){this.history=[];this.redoHistory=[]},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length}},push:function(f,n,k){for(var l=[],p=0;p<k.length;p++){var r=p==k.length-1?n:this.container.ownerDocument.createElement("BR");l.push({from:f,to:r,text:cleanText(k[p])});f=r}this.pushChains([l],f==null&&n==null);this.notifyEnvironment()},pushChains:function(f,n){this.commit(n);
this.addUndoLevel(this.updateTo(f,"applyChain"));this.redoHistory=[]},chainNode:function(f){for(var n=0;n<f.length;n++){var k=f[n][0];if(k=k&&(k.from||k.to))return k}},reset:function(){this.history=[];this.redoHistory=[]},textAfter:function(f){return this.after(f).text},nodeAfter:function(f){return this.after(f).to},nodeBefore:function(f){return this.before(f).from},tryCommit:function(){if(window.parent&&window.UndoHistory)this.editor.highlightDirty()?this.commit(true):this.scheduleCommit()},commit:function(f){this.parent.clearTimeout(this.commitTimeout);
f||this.editor.highlightDirty(true);f=this.touchedChains();if(f.length){this.addUndoLevel(this.updateTo(f,"linkChain"));this.redoHistory=[];this.notifyEnvironment()}},updateTo:function(f,n){for(var k=[],l=[],p=0;p<f.length;p++){k.push(this.shadowChain(f[p]));l.push(this[n](f[p]))}n=="applyChain"&&this.notifyDirty(l);return k},notifyDirty:function(f){forEach(f,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},notifyEnvironment:function(){this.onChange&&this.onChange();window.frameElement&&
window.frameElement.CodeMirror.updateNumbers&&window.frameElement.CodeMirror.updateNumbers()},linkChain:function(f){for(var n=0;n<f.length;n++){var k=f[n];if(k.from)k.from.historyAfter=k;else this.first=k;if(k.to)k.to.historyBefore=k;else this.last=k}},after:function(f){return f?f.historyAfter:this.first},before:function(f){return f?f.historyBefore:this.last},setTouched:function(f){if(f){if(!f.historyTouched){this.touched.push(f);f.historyTouched=true}}else this.firstTouched=true},addUndoLevel:function(f){this.history.push(f);
this.history.length>this.maxDepth&&this.history.shift()},touchedChains:function(){function f(i,b){if(i)i.historyTemp=b;else p=b}function n(i){for(var b=[],a=i?i.nextSibling:l.container.firstChild;a&&(!isBR(a)||a.hackBR);a=a.nextSibling)!a.hackBR&&a.currentText&&b.push(a.currentText);return{from:i,to:a,text:cleanText(b.join(""))}}function k(i,b){for(var a=b+"Sibling",c=i[a];c&&!isBR(c);)c=c[a];return c}var l=this,p=null,r=[];l.firstTouched&&l.touched.push(null);forEach(l.touched,function(i){if(!(i&&
(i.parentNode!=l.container||i.hackBR))){if(i)i.historyTouched=false;else l.firstTouched=false;var b=n(i),a=l.after(i);if(!a||a.text!=b.text||a.to!=b.to){r.push(b);f(i,b)}}});var w=[];l.touched=[];forEach(r,function(i){if(i.from?i.from.historyTemp:p){for(var b=[],a=i.from,c=true;;){var d=a?a.historyTemp:p;if(!d)if(c)break;else d=n(a);b.unshift(d);f(a,null);if(!a)break;c=l.after(a);a=k(a,"previous")}a=i.to;for(c=l.before(i.from);;){if(!a)break;d=a?a.historyTemp:p;if(!d)if(c)break;else d=n(a);b.push(d);
f(a,null);c=l.before(a);a=k(a,"next")}w.push(b)}});return w},shadowChain:function(f){var n=[],k=this.after(f[0].from);for(f=f[f.length-1].to;;){n.push(k);k=k.to;if(!k||k==f)break;else k=k.historyAfter||this.before(f)}return n},applyChain:function(f){var n=select.cursorPos(this.container,false),k=this,l=f[0].from,p=f[f.length-1].to;(function(c,d){for(var e=c?c.nextSibling:k.container.firstChild;e!=d;){var g=e.nextSibling;removeElement(e);e=g}})(l,p);for(var r=0;r<f.length;r++){var w=f[r];r>0&&k.container.insertBefore(w.from,
p);var i=makePartSpan(fixSpaces(w.text));k.container.insertBefore(i,p);if(n&&n.node==w.from){i=0;var b=this.after(w.from);if(b&&r==f.length-1){for(var a=0;a<n.offset&&w.text.charAt(a)==b.text.charAt(a);a++);if(n.offset>a)i=w.text.length-b.text.length}select.setCursorPos(this.container,{node:w.from,offset:Math.max(0,n.offset+i)})}else n&&r==f.length-1&&n.node&&n.node.parentNode!=this.container&&select.setCursorPos(this.container,{node:w.from,offset:w.text.length})}this.linkChain(f);return l}};
var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent),webkit=/AppleWebKit/.test(navigator.userAgent),safari=/Apple Computer, Inc/.test(navigator.vendor),gecko=navigator.userAgent.match(/gecko\/(\d{8})/i);if(gecko)gecko=Number(gecko[1]);var mac=/Mac/.test(navigator.platform),brokenOpera=window.opera&&/Version\/10.[56]/.test(navigator.userAgent),slowWebkit=/AppleWebKit\/533/.test(navigator.userAgent);
function makeWhiteSpace(f){for(var n=[],k=true;f>0;f--){n.push(k||f==1?nbsp:" ");k^=true}return n.join("")}function fixSpaces(f){if(f.charAt(0)==" ")f=nbsp+f.slice(1);return f.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(n){return makeWhiteSpace(n.length)})}function cleanText(f){return f.replace(/\u00a0/g," ").replace(/\u200b/g,"")}
function makePartSpan(f){var n=f;if(f.nodeType==3)n=f.nodeValue;else f=document.createTextNode(n);var k=document.createElement("SPAN");k.isPart=true;k.appendChild(f);k.currentText=n;return k}
var webkitLastLineHack=webkit?function(f){var n=f.lastChild;if(!n||!n.hackBR){n=document.createElement("BR");n.hackBR=true;f.appendChild(n)}}:function(){},Editor=function(){function f(b){var a=makeWhiteSpace(indentUnit);return map(b.replace(/\t/g,a).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function n(b,a){function c(g,h){if(g.nodeType==3){if((g.nodeValue=fixSpaces(g.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "))).length)e=false;d.push(g)}else if(isBR(g)&&g.childNodes.length==
0){e=true;d.push(g)}else{for(var j=g.firstChild;j;j=j.nextSibling)c(j);if(!e&&i.hasOwnProperty(g.nodeName.toUpperCase())){e=true;if(!a||!h)d.push(document.createElement("BR"))}}}var d=[],e=true;c(b,true);return d}function k(b){function a(g){var h=g.parentNode,j=g.nextSibling;return function(m){h.insertBefore(m,j)}}var c=[],d=null,e=true;return{next:function(){if(!b)throw StopIteration;var g=b;b=g.nextSibling;var h;if(g.isPart&&g.childNodes.length==1&&g.firstChild.nodeType==3){g.currentText=g.firstChild.nodeValue;
h=!/[\n\t\r]/.test(g.currentText)}else h=false;if(h){c.push(g);e=false;return g.currentText}else if(isBR(g)){e&&window.opera&&g.parentNode.insertBefore(makePartSpan(""),g);c.push(g);e=true;return"\n"}else{h=!g.nextSibling;d=a(g);removeElement(g);g=n(g,h);for(h=0;h<g.length;h++){var j=h,m=g[h],q="\n";if(m.nodeType==3){select.snapshotChanged();m=makePartSpan(m);q=m.currentText;e=false}else{e&&window.opera&&d(makePartSpan(""));e=true}m.dirty=true;c.push(m);d(m);g[j]=q}return g.join("")}},nodes:c}}function l(b){for(;b&&
!isBR(b);)b=b.previousSibling;return b}function p(b,a){if(b){if(isBR(b))b=b.nextSibling}else b=a.firstChild;for(;b&&!isBR(b);)b=b.nextSibling;return b}function r(b,a,c,d){function e(j){j=cleanText(b.history.textAfter(j));return d?j.toLowerCase():j}this.editor=b;this.history=b.history;this.history.commit();this.valid=!!a;this.atOccurrence=false;if(d==undefined)d=a==a.toLowerCase();var g={node:null,offset:0};if(c&&typeof c=="object"&&typeof c.character=="number"){b.checkLine(c.line);c={node:c.line,
offset:c.character};this.pos={from:c,to:c}}else this.pos=c?{from:select.cursorPos(b.container,true)||g,to:select.cursorPos(b.container,false)||g}:{from:g,to:g};if(d)a=a.toLowerCase();var h=a.split("\n");this.matches=h.length==1?function(j,m,q){var s=e(m),t=a.length,v;if(j?q>=t&&(v=s.lastIndexOf(a,q-t))!=-1:(v=s.indexOf(a,q))!=-1)return{from:{node:m,offset:v},to:{node:m,offset:v+t}}}:function(j,m,q){var s=j?h.length-1:0,t=h[s],v=e(m),z=j?v.indexOf(t)+t.length:v.lastIndexOf(t);if(!(j?z>=q||z!=t.length:
z<=q||z!=v.length-t.length))for(q=m;;){if(j&&!q)return;q=j?this.history.nodeBefore(q):this.history.nodeAfter(q);if(!j&&!q)return;v=e(q);t=h[j?--s:++s];if(s>0&&s<h.length-1)if(v!=t)return;else continue;s=j?v.lastIndexOf(t):v.indexOf(t)+t.length;if(j?s!=v.length-t.length:s!=t.length)return;return{from:{node:j?q:m,offset:j?s:z},to:{node:j?m:q,offset:j?z:s}}}}}function w(b){this.options=b;window.indentUnit=b.indentUnit;this.parent=parent;var a=this.container=document.body;this.history=new UndoHistory(a,
b.undoDepth,b.undoDelay,this);var c=this;if(!w.Parser)throw"No parser loaded.";b.parserConfig&&w.Parser.configure&&w.Parser.configure(b.parserConfig);b.readOnly||select.setCursorPos(a,{node:null,offset:0});this.dirty=[];this.importCode(b.content||"");this.history.onChange=b.onChange;if(b.readOnly){if(!b.textWrapping)a.style.whiteSpace="nowrap"}else{if(b.continuousScanning!==false){this.scanner=this.documentScanner(b.passTime);this.delayScanning()}var d=function(){if(document.body.contentEditable!=
undefined&&internetExplorer)document.body.contentEditable="true";else document.designMode="on";if(internetExplorer&&b.height!="dynamic")document.body.style.minHeight=frameElement.clientHeight-2*document.body.offsetTop-5+"px";document.documentElement.style.borderWidth="0";if(!b.textWrapping)a.style.whiteSpace="nowrap"};try{d()}catch(e){var g=addEventHandler(document,"focus",function(){g();d()},true)}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,
"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));var h=function(){c.cursorActivity(false)};addEventHandler(document.body,"mouseup",h);addEventHandler(document.body,"cut",h);gecko&&addEventHandler(window,"pagehide",function(){c.unloaded=true});addEventHandler(document.body,"paste",function(j){h();var m=null;try{var q=j.clipboardData||window.clipboardData;if(q)m=q.getData("Text")}catch(s){}if(m!==null){j.stop();c.replaceSelection(m);select.scrollToCursor(c.container)}});this.options.autoMatchParens&&
addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}}var i={P:true,DIV:true,LI:true};r.prototype={findNext:function(){return this.find(false)},findPrevious:function(){return this.find(true)},find:function(b){function a(){var h={node:e,offset:g};c.pos={from:h,to:h};return c.atOccurrence=false}if(!this.valid)return false;var c=this,d=b?this.pos.from:this.pos.to,e=d.node,g=d.offset;if(e&&!e.parentNode){e=null;g=0}for(;;){if(this.pos=this.matches(b,e,g))return this.atOccurrence=
true;if(b){if(!e)return a();e=this.history.nodeBefore(e);g=this.history.textAfter(e).length}else{d=this.history.nodeAfter(e);if(!d){g=this.history.textAfter(e).length;return a()}e=d;g=0}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.pos.from,this.pos.to);select.scrollToCursor(this.editor.container)}},replace:function(b){if(this.atOccurrence){this.pos.to=this.editor.replaceRange(this.pos.from,this.pos.to,b);this.atOccurrence=false}},position:function(){if(this.atOccurrence)return{line:this.pos.from.node,
character:this.pos.from.offset}}};w.prototype={importCode:function(b){this.history.push(null,null,f(b));this.history.reset()},getCode:function(){if(!this.container.firstChild)return"";var b=[];select.markSelection();forEach(k(this.container.firstChild),method(b,"push"));webkitLastLineHack(this.container);select.selectMarked();webkit&&this.container.lastChild.hackBR&&b.pop();return cleanText(b.join(""))},checkLine:function(b){if(b===false||!(b==null||b.parentNode==this.container))throw parent.CodeMirror.InvalidLineHandle;
},cursorPosition:function(b){if(b==null)b=true;return(b=select.cursorPos(this.container,b))?{line:b.node,character:b.offset}:{line:null,character:0}},firstLine:function(){return null},lastLine:function(){return this.container.lastChild?l(this.container.lastChild):null},nextLine:function(b){this.checkLine(b);return p(b,this.container)||false},prevLine:function(b){this.checkLine(b);if(b==null)return false;return l(b.previousSibling)},visibleLineCount:function(){for(var b=this.container.firstChild;b&&
isBR(b);)b=b.nextSibling;if(!b)return false;return Math.floor((window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight)/b.offsetHeight)},selectLines:function(b,a,c,d){this.checkLine(b);b={node:b,offset:a};a=null;if(d!==undefined){this.checkLine(c);a={node:c,offset:d}}select.setCursorPos(this.container,b,a);select.scrollToCursor(this.container)},lineContent:function(b){var a=[];for(b=b?b.nextSibling:this.container.firstChild;b&&!isBR(b);b=b.nextSibling)a.push(nodeText(b));
return cleanText(a.join(""))},setLineContent:function(b,a){this.history.commit();this.replaceRange({node:b,offset:0},{node:b,offset:this.history.textAfter(b).length},a);this.addDirtyNode(b);this.scheduleHighlight()},removeLine:function(b){for(var a=b?b.nextSibling:this.container.firstChild;a;){var c=a.nextSibling;removeElement(a);if(isBR(a))break;a=c}this.addDirtyNode(b);this.scheduleHighlight()},insertIntoLine:function(b,a,c){var d=null;if(a=="end")d=p(b,this.container);else for(var e=b?b.nextSibling:
this.container.firstChild;e;e=e.nextSibling){if(a==0){d=e;break}var g=nodeText(e);if(g.length>a){d=e.nextSibling;c=g.slice(0,a)+c+g.slice(a);removeElement(e);break}a-=g.length}a=f(c);for(c=0;c<a.length;c++){c>0&&this.container.insertBefore(document.createElement("BR"),d);this.container.insertBefore(makePartSpan(a[c]),d)}this.addDirtyNode(b);this.scheduleHighlight()},selectedText:function(){var b=this.history;b.commit();var a=select.cursorPos(this.container,true),c=select.cursorPos(this.container,
false);if(!a||!c)return"";if(a.node==c.node)return b.textAfter(a.node).slice(a.offset,c.offset);var d=[b.textAfter(a.node).slice(a.offset)];for(a=b.nodeAfter(a.node);a!=c.node;a=b.nodeAfter(a))d.push(b.textAfter(a));d.push(b.textAfter(c.node).slice(0,c.offset));return cleanText(d.join("\n"))},replaceSelection:function(b){this.history.commit();var a=select.cursorPos(this.container,true),c=select.cursorPos(this.container,false);if(a&&c){c=this.replaceRange(a,c,b);select.setCursorPos(this.container,
c);webkitLastLineHack(this.container)}},cursorCoords:function(b){function a(h,j){var m=-(document.body.scrollTop||document.documentElement.scrollTop||0),q=-(document.body.scrollLeft||document.documentElement.scrollLeft||0)+j;forEach([h,window.frameElement],function(s){for(;s;){q+=s.offsetLeft;m+=s.offsetTop;s=s.offsetParent}});return{x:q,y:m,yBot:m+h.offsetHeight}}function c(h,j){var m=document.createElement("SPAN");m.appendChild(document.createTextNode(h));try{return j(m)}finally{m.parentNode&&m.parentNode.removeChild(m)}}
var d=select.cursorPos(this.container,b);if(!d)return null;b=d.offset;for(var e=d.node,g=this;b;){e=e?e.nextSibling:this.container.firstChild;d=nodeText(e);if(b<d.length)return c(d.substr(0,b),function(h){h.style.position="absolute";h.style.visibility="hidden";h.className=e.className;g.container.appendChild(h);return a(e,h.offsetWidth)});b-=d.length}return e&&isSpan(e)?a(e,e.offsetWidth):e&&e.nextSibling&&isSpan(e.nextSibling)?a(e.nextSibling,0):c("\u200b",function(h){e?e.parentNode.insertBefore(h,
e.nextSibling):g.container.insertBefore(h,g.container.firstChild);return a(h,0)})},reroutePasteEvent:function(){if(!(this.capturingPaste||window.opera||gecko&&gecko>=20101026)){this.capturingPaste=true;var b=window.frameElement.CodeMirror.textareaHack;parent.focus();b.value="";b.focus();var a=this;this.parent.setTimeout(function(){a.capturingPaste=false;window.focus();a.selectionSnapshot&&window.select.setBookmark(a.container,a.selectionSnapshot);var c=b.value;if(c){a.replaceSelection(c);select.scrollToCursor(a.container)}},
10)}},replaceRange:function(b,a,c){c=f(c);c[0]=this.history.textAfter(b.node).slice(0,b.offset)+c[0];var d=c[c.length-1];c[c.length-1]=d+this.history.textAfter(a.node).slice(a.offset);a=this.history.nodeAfter(a.node);this.history.push(b.node,a,c);return{node:this.history.nodeBefore(a),offset:d.length}},getSearchCursor:function(b,a,c){return new r(this,b,a,c)},reindent:function(){this.container.firstChild&&this.indentRegion(null,this.container.lastChild)},reindentSelection:function(b){if(select.somethingSelected()){var a=
select.selectionTopNode(this.container,true),c=select.selectionTopNode(this.container,false);a===false||c===false||this.indentRegion(a,c,b)}else this.indentAtCursor(b)},grabKeys:function(b,a){this.frozen=b;this.keyFilter=a},ungrabKeys:function(){this.frozen="leave"},setParser:function(b,a){w.Parser=window[b];(a=a||this.options.parserConfig)&&w.Parser.configure&&w.Parser.configure(a);if(this.container.firstChild){forEach(this.container.childNodes,function(c){if(c.nodeType!=3)c.dirty=true});this.addDirtyNode(this.firstChild);
this.scheduleHighlight()}},keyDown:function(b){if(this.frozen=="leave")this.keyFilter=this.frozen=null;if(this.frozen&&(!this.keyFilter||this.keyFilter(b.keyCode,b))){b.stop();this.frozen(b)}else{var a=b.keyCode;this.delayScanning();this.options.autoMatchParens&&this.scheduleParenHighlight();if(a==13){if(b.ctrlKey&&!b.altKey)this.reparseBuffer();else{select.insertNewlineAtCursor();a=this.options.enterMode;if(a!="flat")this.indentAtCursor(a=="keep"?"keep":undefined);select.scrollToCursor(this.container)}b.stop()}else if(a==
9&&this.options.tabMode!="default"&&!b.ctrlKey){this.handleTab(!b.shiftKey);b.stop()}else if(a==32&&b.shiftKey&&this.options.tabMode=="default"){this.handleTab(true);b.stop()}else if(a==36&&!b.shiftKey&&!b.ctrlKey)this.home()&&b.stop();else if(a==35&&!b.shiftKey&&!b.ctrlKey)this.end()&&b.stop();else if(a==33&&!b.shiftKey&&!b.ctrlKey&&!gecko)this.pageUp()&&b.stop();else if(a==34&&!b.shiftKey&&!b.ctrlKey&&!gecko)this.pageDown()&&b.stop();else if((a==219||a==221)&&b.ctrlKey&&!b.altKey){this.highlightParens(b.shiftKey,
true);b.stop()}else if(b.metaKey&&!b.shiftKey&&(a==37||a==39)){var c=select.selectionTopNode(this.container);if(!(c===false||!this.container.firstChild)){if(a==37)select.focusAfterNode(l(c),this.container);else{a=p(c,this.container);select.focusAfterNode(a?a.previousSibling:this.container.lastChild,this.container)}b.stop()}}else if((b.ctrlKey||b.metaKey)&&!b.altKey)if(b.shiftKey&&a==90||a==89){select.scrollToNode(this.history.redo());b.stop()}else if(a==90||safari&&a==8){select.scrollToNode(this.history.undo());
b.stop()}else if(a==83&&this.options.saveFunction){this.options.saveFunction();b.stop()}else a==86&&!mac&&this.reroutePasteEvent()}},keyPress:function(b){var a=this.options.electricChars&&w.Parser.electricChars,c=this;if(this.frozen&&(!this.keyFilter||this.keyFilter(b.keyCode||b.code,b))||b.code==13||b.code==9&&this.options.tabMode!="default"||b.code==32&&b.shiftKey&&this.options.tabMode=="default")b.stop();else if(mac&&(b.ctrlKey||b.metaKey)&&b.character=="v")this.reroutePasteEvent();else if(a&&
a.indexOf(b.character)!=-1)this.parent.setTimeout(function(){c.indentAtCursor(null)},0);else if(brokenOpera)if(b.code==8){var d=select.selectionTopNode(this.container);c=this;var e=d?d.nextSibling:this.container.firstChild;d!==false&&e&&isBR(e)&&this.parent.setTimeout(function(){select.selectionTopNode(c.container)==e&&select.focusAfterNode(e.previousSibling,c.container)},20)}else{if(b.code==46){d=select.selectionTopNode(this.container);c=this;d&&isBR(d)&&this.parent.setTimeout(function(){select.selectionTopNode(c.container)!=
d&&select.focusAfterNode(d,c.container)},20)}}else if(slowWebkit){e=(d=select.selectionTopNode(this.container))?d.nextSibling:this.container.firstChild;if(d&&e&&isBR(e)&&!isBR(d)){var g=document.createTextNode("\u200b");this.container.insertBefore(g,e);this.parent.setTimeout(function(){if(g.nodeValue=="\u200b")removeElement(g);else g.nodeValue=g.nodeValue.replace("\u200b","")},20)}}webkit&&!this.options.textWrapping&&setTimeout(function(){var h=select.selectionTopNode(c.container,true);h&&h.nodeType==
3&&h.previousSibling&&isBR(h.previousSibling)&&h.nextSibling&&isBR(h.nextSibling)&&h.parentNode.replaceChild(document.createElement("BR"),h.previousSibling)},50)},keyUp:function(b){this.cursorActivity(b.keyCode>=16&&b.keyCode<=18||b.keyCode>=33&&b.keyCode<=40)},indentLineAfter:function(b,a){function c(q){q=q?q.nextSibling:d.container.firstChild;if(!q||!hasClass(q,"whitespace"))return null;return q}var d=this,e=c(b),g=0,h=e?e.currentText.length:0,j=e?e.nextSibling:b?b.nextSibling:this.container.firstChild;
if(a=="keep"){if(b){var m=c(l(b.previousSibling));if(m)g=m.currentText.length}}else{m=b&&j&&j.currentText?j.currentText:"";if(a!=null&&this.options.tabMode=="shift")g=a?h+indentUnit:Math.max(0,h-indentUnit);else if(b)g=b.indentation(m,h,a);else if(w.Parser.firstIndentation)g=w.Parser.firstIndentation(m,h,a)}h=g-h;if(h<0)if(g==0){if(j)select.snapshotMove(e.firstChild,j.firstChild||j,0);removeElement(e);e=null}else{select.snapshotMove(e.firstChild,e.firstChild,h,true);e.currentText=makeWhiteSpace(g);
e.firstChild.nodeValue=e.currentText}else if(h>0)if(e){e.currentText=makeWhiteSpace(g);e.firstChild.nodeValue=e.currentText;select.snapshotMove(e.firstChild,e.firstChild,h,true)}else{e=makePartSpan(makeWhiteSpace(g));e.className="whitespace";b?insertAfter(e,b):this.container.insertBefore(e,this.container.firstChild);select.snapshotMove(j&&(j.firstChild||j),e.firstChild,g,false,true)}else e&&select.snapshotMove(e.firstChild,e.firstChild,g,false);h!=0&&this.addDirtyNode(b)},highlightAtCursor:function(){var b=
select.selectionTopNode(this.container,true),a=select.selectionTopNode(this.container,false);if(b===false||a===false)return false;select.markSelection();if(this.highlight(b,p(a,this.container),true,20)===false)return false;select.selectMarked();return true},handleTab:function(b){this.options.tabMode=="spaces"?select.insertTabAtCursor():this.reindentSelection(b)},home:function(){var b=select.selectionTopNode(this.container,true),a=b;if(b===false||!(!b||b.isPart||isBR(b))||!this.container.firstChild)return false;
for(;b&&!isBR(b);)b=b.previousSibling;var c=b?b.nextSibling:this.container.firstChild;c&&c!=a&&c.isPart&&hasClass(c,"whitespace")?select.focusAfterNode(c,this.container):select.focusAfterNode(b,this.container);select.scrollToCursor(this.container);return true},end:function(){var b=select.selectionTopNode(this.container,true);if(b===false)return false;b=p(b,this.container);if(!b)return false;select.focusAfterNode(b.previousSibling,this.container);select.scrollToCursor(this.container);return true},
pageUp:function(){var b=this.cursorPosition().line,a=this.visibleLineCount();if(b===false||a===false)return false;a-=2;for(var c=0;c<a;c++){b=this.prevLine(b);if(b===false)break}if(c==0)return false;select.setCursorPos(this.container,{node:b,offset:0});select.scrollToCursor(this.container);return true},pageDown:function(){var b=this.cursorPosition().line,a=this.visibleLineCount();if(b===false||a===false)return false;a-=2;for(var c=0;c<a;c++){var d=this.nextLine(b);if(d===false)break;b=d}if(c==0)return false;
select.setCursorPos(this.container,{node:b,offset:0});select.scrollToCursor(this.container);return true},scheduleParenHighlight:function(){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);var b=this;this.parenEvent=this.parent.setTimeout(function(){b.highlightParens()},300)},highlightParens:function(b,a){function c(v,z){if(v)if(h.options.markParen)h.options.markParen(v,z);else{v.style.fontWeight="bold";v.style.color=z?"#8F8":"#F88"}}function d(v){if(v)if(h.options.unmarkParen)h.options.unmarkParen(v);
else{v.style.fontWeight="";v.style.color=""}}function e(v){if(v.currentText)return(v=v.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/))&&v[1]}function g(){for(var v=[],z,A=true,u=m;u;u=s?u.nextSibling:u.previousSibling)if(u.className==q&&isSpan(u)&&(z=e(u))){if(/[\(\[\{]/.test(z)==s)v.push(z);else if(v.length){if(v.pop()!=matching[z])A=false}else A=false;if(!v.length)break}else if(u.dirty||!isSpan(u)&&!isBR(u))return{node:u,status:"dirty"};return{node:u,status:u&&A}}var h=this;if(!a&&
h.highlighted){d(h.highlighted[0]);d(h.highlighted[1])}if(window.parent&&window.select){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);this.parenEvent=null;var j,m=select.selectionTopNode(this.container,true);if(m&&this.highlightAtCursor())if((m=select.selectionTopNode(this.container,true))&&((j=e(m))||(m=m.nextSibling)&&(j=e(m))))for(var q=m.className,s=/[\(\[\{]/.test(j);;){var t=g();if(t.status=="dirty"){this.highlight(t.node,p(t.node));t.node.dirty=false}else{c(m,t.status);c(t.node,
t.status);if(a)h.parent.setTimeout(function(){d(m);d(t.node)},500);else h.highlighted=[m,t.node];b&&t.node&&select.focusAfterNode(t.node.previousSibling,this.container);break}}}},indentAtCursor:function(b){if(this.container.firstChild)if(this.highlightAtCursor()){var a=select.selectionTopNode(this.container,false);if(a!==false){select.markSelection();this.indentLineAfter(l(a),b);select.selectMarked()}}},indentRegion:function(b,a,c){var d=b=l(b),e=b&&l(b.previousSibling);isBR(a)||(a=p(a,this.container));
this.addDirtyNode(b);do{var g=p(d,this.container);d&&this.highlight(e,g,true);this.indentLineAfter(d,c);e=d;d=g}while(d!=a);select.setCursorPos(this.container,{node:b,offset:0},{node:a,offset:0})},cursorActivity:function(b){if(this.unloaded){window.document.designMode="off";window.document.designMode="on";this.unloaded=false}if(internetExplorer){this.container.createTextRange().execCommand("unlink");clearTimeout(this.saveSelectionSnapshot);var a=this;this.saveSelectionSnapshot=setTimeout(function(){var e=
select.getBookmark(a.container);if(e)a.selectionSnapshot=e},200)}var c=this.options.cursorActivity;if(!b||c){var d=select.selectionTopNode(this.container,false);if(!(d===false||!this.container.firstChild)){d=d||this.container.firstChild;c&&c(d);if(!b){this.scheduleHighlight();this.addDirtyNode(d)}}}},reparseBuffer:function(){forEach(this.container.childNodes,function(b){b.dirty=true});this.container.firstChild&&this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(b){if(b=b||this.container.firstChild){for(var a=
0;a<this.dirty.length;a++)if(this.dirty[a]==b)return;if(b.nodeType!=3)b.dirty=true;this.dirty.push(b)}},allClean:function(){return!this.dirty.length},scheduleHighlight:function(){var b=this;this.parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=this.parent.setTimeout(function(){b.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){for(;this.dirty.length>0;){var b=this.dirty.pop();try{for(;b&&b.parentNode!=this.container;)b=b.parentNode;if(b&&(b.dirty||b.nodeType==3))return b}catch(a){}}return null},
highlightDirty:function(b){if(!window.parent||!window.select)return false;this.options.readOnly||select.markSelection();for(var a,c=b?null:(new Date).getTime()+this.options.passTime;((new Date).getTime()<c||b)&&(a=this.getDirtyNode());){var d=this.highlight(a,c);d&&d.node&&d.dirty&&this.addDirtyNode(d.node.nextSibling)}this.options.readOnly||select.selectMarked();a&&this.scheduleHighlight();return this.dirty.length==0},documentScanner:function(b){var a=this,c=null;return function(){if(window.parent&&
window.select){if(c&&c.parentNode!=a.container)c=null;select.markSelection();var d=a.highlight(c,(new Date).getTime()+b,true);select.selectMarked();d=d?d.node&&d.node.nextSibling:null;c=c==d?null:d;a.delayScanning()}}},delayScanning:function(){if(this.scanner){this.parent.clearTimeout(this.documentScan);this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(b,a,c,d){function e(u){if(u){var y=u.oldNextSibling;if(v||y===undefined||u.nextSibling!=
y)h.history.touch(u);u.oldNextSibling=u.nextSibling}else{y=h.container.oldFirstChild;if(v||y===undefined||h.container.firstChild!=y)h.history.touch(null);h.container.oldFirstChild=h.container.firstChild}}var g=this.container,h=this,j=this.options.activeTokens,m=typeof a=="number"?a:null;if(!g.firstChild)return false;for(;b&&(!b.parserFromHere||b.dirty);){if(d!=null&&isBR(b)&&--d<0)return false;b=b.previousSibling}if(b&&!b.nextSibling)return false;var q=k(b?b.nextSibling:g.firstChild);d=stringStream(q);
var s=b?b.parserFromHere(d):w.Parser.make(d),t={current:null,get:function(){if(!this.current)this.current=q.nodes.shift();return this.current},next:function(){this.current=null},remove:function(){g.removeChild(this.get());this.current=null},getNonEmpty:function(){for(var u=this.get();u&&isSpan(u)&&u.currentText=="";)if(window.opera&&(u.previousSibling==null||isBR(u.previousSibling))&&(u.nextSibling==null||isBR(u.nextSibling))){this.next();u=this.get()}else{var y=u;this.remove();u=this.get();select.snapshotMove(y.firstChild,
u&&(u.firstChild||u),0)}return u}},v=false,z=true,A=0;forEach(s,function(u){var y=t.getNonEmpty();if(u.value=="\n"){if(!isBR(y))throw"Parser out of sync. Expected BR.";if(y.dirty||!y.indentation)v=true;e(b);b=y;y.parserFromHere=s.copy();y.indentation=u.indentation;y.dirty=false;if(m==null&&y==a)throw StopIteration;if(m!=null&&(new Date).getTime()>=m||!v&&!z&&A>1&&!c)throw StopIteration;z=v;v=false;A=0;t.next()}else{if(!isSpan(y))throw"Parser out of sync. Expected SPAN.";if(y.dirty)v=true;A++;if(!y.reduced&&
y.currentText==u.value&&y.className==u.style){y.dirty=false;t.next()}else{v=true;var D=makePartSpan(u.value);D.className=u.style;g.insertBefore(D,y);j&&j(D,u,h);u=u.value.length;for(var I=0;u>0;){y=t.get();var J=y.currentText.length;select.snapshotReplaceNode(y.firstChild,D.firstChild,u,I);if(J>u){y=y;y.currentText=y.currentText.substring(u);y.reduced=true;u=0}else{u-=J;I+=J;t.remove()}}}}});e(b);webkitLastLineHack(this.container);return{node:t.getNonEmpty(),dirty:v}}};return w}();
addEventHandler(window,"load",function(){var f=window.frameElement.CodeMirror;f.editor=new Editor(f.options);this.parent.setTimeout(method(f,"init"),0)});
function tokenizer(f,n){function k(p){return p!="\n"&&/^[\s\u00a0]*$/.test(p)}var l={state:n,take:function(p){if(typeof p=="string")p={style:p,type:p};p.content=(p.content||"")+f.get();/\n$/.test(p.content)||f.nextWhile(k);p.value=p.content+f.get();return p},next:function(){if(!f.more())throw StopIteration;var p;if(f.equals("\n")){f.next();return this.take("whitespace")}if(f.applies(k))p="whitespace";else for(;!p;)p=this.state(f,function(r){l.state=r});return this.take(p)}};return l}
var tokenizeJavaScript=function(){function f(i,b){for(var a=false;!i.endOfLine();){var c=i.next();if(c==b&&!a)return false;a=!a&&c=="\\"}return a}function n(i,b){return function(a,c){var d=i,e=k(i,b,a,function(h){d=h}),g=e.type=="operator"||e.type=="keyword c"||e.type.match(/^[\[{}\(,;:]$/);if(g!=b||d!=i)c(n(d,g));return e}}function k(i,b,a,c){function d(){a.nextWhileMatches(w);var m=a.get(),q=l.hasOwnProperty(m)&&l.propertyIsEnumerable(m)&&l[m];return q?{type:q.type,style:q.style,content:m}:{type:"variable",
style:"js-variable",content:m}}function e(m){var q="/*";for(m=m=="*";;){if(a.endOfLine())break;var s=a.next();if(s=="/"&&m){q=null;break}m=s=="*"}c(q);return{type:"comment",style:"js-comment"}}function g(){a.nextWhileMatches(p);return{type:"operator",style:"js-operator"}}function h(m){var q=f(a,m);c(q?m:null);return{type:"string",style:"js-string"}}if(i=='"'||i=="'")return h(i);var j=a.next();if(i=="/*")return e(j);else if(j=='"'||j=="'")return h(j);else if(/[\[\]{}\(\),;\:\.]/.test(j))return{type:j,
style:"js-punctuation"};else if(j=="0"&&(a.equals("x")||a.equals("X"))){a.next();a.nextWhileMatches(r);return{type:"number",style:"js-atom"}}else if(/[0-9]/.test(j)){a.nextWhileMatches(/[0-9]/);if(a.equals(".")){a.next();a.nextWhileMatches(/[0-9]/)}if(a.equals("e")||a.equals("E")){a.next();a.equals("-")&&a.next();a.nextWhileMatches(/[0-9]/)}return{type:"number",style:"js-atom"}}else if(j=="/")if(a.equals("*")){a.next();return e(j)}else if(a.equals("/")){f(a,null);return{type:"comment",style:"js-comment"}}else{if(b){f(a,
"/");a.nextWhileMatches(/[gi]/);i={type:"regexp",style:"js-string"}}else i=g();return i}else return p.test(j)?g():d()}var l=function(){function i(g,h){return{type:g,style:"js-"+h}}var b=i("keyword a","keyword"),a=i("keyword b","keyword"),c=i("keyword c","keyword"),d=i("operator","keyword"),e=i("atom","atom");return{"if":b,"while":b,"with":b,"else":a,"do":a,"try":a,"finally":a,"return":c,"break":c,"continue":c,"new":c,"delete":c,"throw":c,"in":d,"typeof":d,"instanceof":d,"var":i("var","keyword"),"function":i("function",
"keyword"),"catch":i("catch","keyword"),"for":i("for","keyword"),"switch":i("switch","keyword"),"case":i("case","keyword"),"default":i("default","keyword"),"true":e,"false":e,"null":e,undefined:e,NaN:e,Infinity:e}}(),p=/[+\-*&%=<>!?|]/,r=/[0-9A-Fa-f]/,w=/[\w\$_]/;return function(i,b){return tokenizer(i,b||n(false,true))}}(),JSParser=Editor.Parser=function(){function f(p,r,w,i,b,a){this.indented=p;this.column=r;this.type=w;if(i!=null)this.align=i;this.prev=b;this.info=a}function n(p){return function(r){var w=
r&&r.charAt(0),i=p.type,b=w==i;return i=="vardef"?p.indented+4:i=="form"&&w=="{"?p.indented:i=="stat"||i=="form"?p.indented+indentUnit:p.info=="switch"&&!b?p.indented+(/^(?:case|default)\b/.test(r)?indentUnit:2*indentUnit):p.align?p.column-(b?1:0):p.indented+(b?0:indentUnit)}}var k={atom:true,number:true,variable:true,string:true,regexp:true},l=false;return{make:function(p,r){function w(o){for(var x=o.length-1;x>=0;x--)E.push(o[x])}function i(){w(arguments);M=true}function b(){w(arguments);M=false}
function a(){C={prev:C,vars:{"this":true,arguments:true}}}function c(){C=C.prev}function d(o){if(C){G="js-variabledef";C.vars[o]=true}}function e(o,x){var F=function(){B=new f(K,L,o,null,B,x)};F.lex=true;return F}function g(){if(B.type==")")K=B.indented;B=B.prev}function h(o){return function(x){if(x==o)i();else o==";"?b():i(arguments.callee)}}function j(){return b(q,j)}function m(){return b(s,m)}function q(o){if(o=="var")i(e("vardef"),D,h(";"),g);else if(o=="keyword a")i(e("form"),s,q,g);else if(o==
"keyword b")i(e("form"),q,g);else if(o=="{")i(e("}"),y,g);else if(o==";")i();else if(o=="function")i(O);else if(o=="for")i(e("form"),h("("),e(")"),J,h(")"),g,q,g);else if(o=="variable")i(e("stat"),v);else if(o=="switch")i(e("form"),s,e("}","switch"),h("{"),y,g,g);else if(o=="case")i(s,h(":"));else if(o=="default")i(h(":"));else o=="catch"?i(e("form"),a,h("("),Q,h(")"),q,g,c):b(e("stat"),s,h(";"),g)}function s(o){if(k.hasOwnProperty(o))i(t);else if(o=="function")i(O);else if(o=="keyword c")i(s);else if(o==
"(")i(e(")"),s,h(")"),g,t);else if(o=="operator")i(s);else if(o=="[")i(e("]"),u(s,"]"),g,t);else o=="{"?i(e("}"),u(A,"}"),g,t):i()}function t(o,x){if(o=="operator"&&/\+\+|--/.test(x))i(t);else if(o=="operator")i(s);else if(o==";")b();else if(o=="(")i(e(")"),u(s,")"),g,t);else if(o==".")i(z,t);else o=="["&&i(e("]"),s,h("]"),g,t)}function v(o){o==":"?i(g,q):b(t,h(";"),g)}function z(o){if(o=="variable"){G="js-property";i()}}function A(o){if(o=="variable")G="js-property";k.hasOwnProperty(o)&&i(h(":"),
s)}function u(o,x){function F(H){if(H==",")i(o,F);else H==x?i():i(h(x))}return function(H){H==x?i():b(o,F)}}function y(o){o=="}"?i():b(q,y)}function D(o,x){if(o=="variable"){d(x);i(I)}else i()}function I(o,x){if(x=="=")i(s,I);else o==","&&i(D)}function J(o){if(o=="var")i(D,N);else if(o==";")b(N);else o=="variable"?i(T):b(N)}function T(o,x){x=="in"?i(s):i(t,N)}function N(o,x){if(o==";")i(R);else x=="in"?i(s):i(s,h(";"),R)}function R(o){o==")"?b():i(s)}function O(o,x){if(o=="variable"){d(x);i(O)}else o==
"("&&i(a,u(Q,")"),q,c)}function Q(o,x){if(o=="variable"){d(x);i()}}var P=tokenizeJavaScript(p),E=[l?m:j],C=null,B=new f((r||0)-indentUnit,0,"block",false),L=0,K=0,M,G,S={next:function(){for(;E[E.length-1].lex;)E.pop()();var o=P.next();if(o.type=="whitespace"&&L==0)K=o.value.length;L+=o.value.length;if(o.content=="\n"){K=L=0;if(!("align"in B))B.align=false;o.indentation=n(B)}if(o.type=="whitespace"||o.type=="comment")return o;if(!("align"in B))B.align=true;for(;;){M=G=false;E.pop()(o.type,o.content);
if(M){if(G)o.style=G;else{var x;if(x=o.type=="variable")a:{for(x=C;x;){if(x.vars[o.content]){x=true;break a}x=x.prev}x=false}if(x)o.style="js-localvariable"}return o}}},copy:function(){var o=C,x=B,F=E.concat([]),H=P.state;return function(U){C=o;B=x;E=F.concat([]);L=K=0;P=tokenizeJavaScript(U,H);return S}}};g.lex=true;return S},electricChars:"{}:",configure:function(p){if(p.json!=null)l=p.json}}}();
