
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
(function(c){c.fn.validate_input=function(a){return this.each(function(){var d=c(this);if(d.is(":text")){var f=d.data("$.validate_input");f&&f._destroy();f=new e(this,a);d.data("$.validate_input",f)}})};var e=c.validate_input=function(a,d){this.options=c.extend(true,{},e.defaults,d);if(typeof this.options.validator!=="function")throw"A validator is required";this.input=c(a);this.original_value=this.input.val();this.init();var f=this;this.input.bind("remove",function(){f._destroy()});return this};
e.prototype={init:function(){var a=this;this.input.bind("keyup.validate_input",function(d){a.textchange(d)}).bind(c.browser.msie?"paste.validate_input":"input.validate_input",function(d){a.textchange(d)})},_destroy:function(){this.input.unbind(".validate_input")},original:function(){this.input.trigger("original")},valid:function(a){this.input.trigger("valid",a)},invalid:function(a,d){this.input.trigger("invalid",d)},textchange:function(){clearTimeout(this.textchange_timeout);var a=this;this.textchange_timeout=
setTimeout(function(){a.validate()},200)},validate:function(a){a&&clearTimeout(this.textchange_timeout);a=this.input.val();if(this.original_value===a)return this.original(a);a=c.trim(a);var d=this.options;try{return this.valid(d.validator(a,d))}catch(f){return this.invalid(a,""+f)}}};c.extend(e,{defaults:{validator:function(a){return{text:a,value:a}}},log:function(){},invalid:function(a,d,f,j){throw new Error("Invalid "+f+(j?": "+j:""));},text:function(a,d){if(a.lengh>4096)return this.invalid(a,d,
type,"Text too long");return{text:a,value:a}},topic:function(){return e.defaults.validator},enumerated:function(){return e.defaults.validator},"boolean":function(){return e.defaults.validator},uri:function(a,d){var f=e.uri.regex;if(!f)f=e.uri.regex=/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
if(f.test(a))return{text:a,value:a};return e.invalid(a,d,"uri")},"int":function(a,d){var f=e.parse_number(a,d);try{var j=parseInt(f,10);if(isNaN(j))throw"isNaN";return{text:(new Number(j)).toLocaleString(),value:j}}catch(h){}return e.invalid(a,d,"int")},"float":function(a,d){var f=e.parse_number(a,d);try{var j=parseFloat(f);if(isNaN(j))throw"isNaN";return{text:(new Number(j)).toLocaleString(),value:j}}catch(h){}return e.invalid(a,d,"float")},parse_number:function(a,d){var f=e.parse_number.regex;if(!f)f=
e.parse_number.regex=/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/;if(f.test(a))return a.replace(/[^\-\d\.]/g,"");return e.invalid(a,d,"number")},datetime:function(a){var d=e.datetime.fromISOString(a);if(d)return{text:a,value:a,date:d};throw e.invalid("datetime",a);},mqlkey:function(a,d){var f=e.mqlkey.regex;if(!f)f=e.mqlkey.regex=/^[A-Za-z0-9][A-Za-z0-9_-]*$/;if(f.test(a))return{text:a,value:a};return e.invalid(a,d,"mqlkey")}});c.extend(e.datetime,{fromISOString:function(a,d){if(!c.validate_input.datetime._isoRegExp)c.validate_input.datetime._isoRegExp=
/^(?:(-?\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(.\d+)?)?((?:[+-](\d{2}):(\d{2}))|Z)?)?$/;var f=c.validate_input.datetime._isoRegExp.exec(a),j=null;if(f){f.shift();f[0]=f[0].replace(/^(-)*0+/g,"$1");f[1]&&f[1]--;if(f[6])f[6]*=1E3;if(d){d=new Date(d);c.each(c.map(["FullYear","Month","Date","Hours","Minutes","Seconds","Milliseconds"],function(i){return d["get"+i]()}),function(i,g){f[g]=f[g]||i})}j=new Date(f[0]||1970,f[1]||0,f[2]||1,f[3]||0,f[4]||0,f[5]||0,f[6]||0);if(f[0]<100)j.setFullYear(f[0]||
1970);var h=0,b=f[7]&&f[7].charAt(0);if(b!="Z"){h=(f[8]||0)*60+(Number(f[9])||0);if(b!="-")h*=-1}if(b)h-=j.getTimezoneOffset();h&&j.setTime(j.getTime()+h*6E4)}return j},toISOString:function(a,d){var f=function(g){return g<10?"0"+g:g};d=d||{};var j=[],h=d.zulu?"getUTC":"get",b="";if(d.selector!="time"){b=a[h+"FullYear"]();b=["0000".substr((b+"").length)+b,f(a[h+"Month"]()+1),f(a[h+"Date"]())].join("-")}j.push(b);if(d.selector!="date"){b=[f(a[h+"Hours"]()),f(a[h+"Minutes"]()),f(a[h+"Seconds"]())].join(":");
h=a[h+"Milliseconds"]();if(d.milliseconds)b+="."+(h<100?"0":"")+f(h);if(d.zulu)b+="Z";else if(d.selector!="time"){h=a.getTimezoneOffset();var i=Math.abs(h);b+=(h>0?"-":"+")+f(Math.floor(i/60))+":"+f(i%60)}j.push(b)}return j.join("T")}})})(jQuery);
(function(c){c.fn.data_input=function(e){return this.each(function(){var a=c(this),d=a.data("$.data_input");d&&d._destroy();d=new c.data_input(this,e);a.data("$.data_input",d)})};c.data_input=function(e,a){this.options=c.extend(true,{},c.data_input.defaults,a);this.container=c(e);this.input=c(":input",this.container);this.init();var d=this;this.input.bind("remove",function(){d._destroy()})};c.data_input.prototype={init:function(){var e=this,a=this.container,d=this.input;if(a.is(".topic"))d.validate_topic(c.extend(true,
{},this.options.suggest,{type:a.attr("data-ect")}));else if(a.is(".text"))d.validate_input({validator:c.validate_input.text});else if(a.is(".datetime"))d.validate_input({validator:c.validate_input.datetime});else if(a.is(".enumerated"))d.validate_enumerated();else if(a.is(".int"))d.validate_input({validator:c.validate_input["int"]});else if(a.is(".float"))d.validate_input({validator:c.validate_input["float"]});else if(a.is(".uri"))d.validate_input({validator:c.validate_input.uri});else if(a.is(".boolean"))d.validate_boolean();
else if(a.is(".enumeration"))d.validate_input({validator:c.validate_input.mqlkey});else if(a.is(".rawstring"))d.validate_input({validator:c.validate_input.text});else throw new Error("Invalid data-input: "+a.attr("class"));this.input.bind("focusin.data_input",function(){e.container.addClass("focus")}).bind("focusout.data_input",function(){e.container.removeClass("focus")}).bind("valid.data_input",function(f,j){var h=e.input.attr("name");e.container.data("name_value",[h,j.id||j.value]);e.container.removeClass("error").addClass("valid")}).bind("invalid.data_input",
function(){e.container.removeData("name_value");e.container.removeClass("valid").addClass("error")}).bind("keypress.data_input",function(f){f.keyCode===13&&!f.isDefaultPrevented()&&e.container.trigger("submit")}).bind("keyup.data_input",function(f){f.keyCode===27&&e.container.trigger("cancel")})},_destroy:function(){this.input.unbind(".data_input")},validate:function(){var e=this.input;c.each(["$.validate_topic","$.validate_input","$.validate_enumerated","$.validate_boolean"],function(a,d){var f=
e.data(d);if(f){f.validate(true);return false}})},reset:function(){this.container.removeData("name_value");if(this.input.is(":text"))this.input.val("");else if(this.input.is("select"))this.input[0].selectedIndex=0;else this.input.is(":radio")&&this.input.each(function(){this.checked=false})}};c.extend(c.data_input,{defaults:{suggest:{service_url:"http://www.freebase.com",service_path:"/private/suggest",flyout_service_url:"http://www.freebase.com",flyout_service_path:"/private/flyout",category:"object",
type:"/common/topic"}}});c.fn.validate_topic=function(e){return this.each(function(){var a=c(this);if(a.is(":text")){var d=a.data("$.validate_topic");d&&d._destroy();d=new c.validate_topic(this,e);a.data("$.validate_topic",d)}})};c.validate_topic=function(e,a){this.options=c.extend(true,{},a);this.input=c(e);this.init()};c.validate_topic.prototype={init:function(){var e=this;this.input.suggest(this.options).bind("fb-textchange.validate_topic",function(){e.invalid()}).bind("fb-select.validate_topic",
function(a,d){e.input.val(d.id);e.valid(d)})},invalid:function(){this.input.trigger("invalid")},valid:function(e){this.input.trigger("valid",e)},_destroy:function(){this.input.unbind(".validate_topic")},validate:function(){}};c.fn.validate_enumerated=function(e){return this.each(function(){var a=c(this);if(a.is("select")){var d=a.data("$.validate_enumerated");d&&d._destroy();d=new c.validate_enumerated(this,e);a.data("$.validate_enumerated",d)}})};c.validate_enumerated=function(e,a){this.options=
c.extend(true,{},a);this.input=c(e);this.init()};c.validate_enumerated.prototype={init:function(){var e=this;this.input.bind("change.validate_enumerated",function(){this.value?e.valid({text:c(":selected",this).text(),id:this.value}):e.invalid()})},invalid:function(){this.input.trigger("invalid")},valid:function(e){this.input.trigger("valid",e)},_destroy:function(){this.input.unbind(".validate_enumerated")},validate:function(){}};c.fn.validate_boolean=function(e){return this.each(function(){var a=
c(this);if(a.is(":radio")){var d=a.data("$.validate_boolean");d&&d._destroy();d=new c.validate_boolean(this,e);a.data("$.validate_boolean",d)}})};c.validate_boolean=function(e,a){this.options=c.extend(true,{},a);this.input=c(e);this.init()};c.validate_boolean.prototype={init:function(){var e=this;this.input.bind("change.validate_boolean",function(){e.valid({text:c(this).text(),value:this.value})})},_destroy:function(){this.input.unbind(".validate_boolean")},valid:function(e){this.input.trigger("valid",
e)},validate:function(){}}})(jQuery);
(function(c,e){var a=e.options.base_url,d=e.options.id,f=e.options.lang,j=e.options.suggest,h=e.edit={prop_add_begin:function(b){var i={id:d,pid:b.attr("data-id"),lang:f};c.ajax({url:a+"/prop_add_begin.ajax",data:i,dataType:"json",success:function(g){g=c(g.result.html).hide();var k={mode:"add",event_prefix:"propbox.edit.prop_add.",ajax:{data:i,url:a+"/prop_add_submit.ajax"},init:h.init_prop_add_form,validate:h.validate_prop_add_form,submit:h.submit_prop_add_form,form:g,prop_section:b};h.init(k);k.form.bind("propbox.edit.prop_add.success",
function(){h.reset_data_input(k);c(":input:visible:first",k.form).focus();c(".button-cancel",k.form).text("Done")})},error:function(g){h.ajax_error(g,form)}})},init_prop_add_form:function(b){h.init_data_input(b);c(":input:visible:first",b.form).focus()},validate_prop_add_form:function(b){return h.validate_data_input(b)},submit_prop_add_form:function(b){var i=c.extend({},b.ajax.data);c(".data-input",b.form).each(function(){var g=c(this).data("name_value");if(g)i[g[0]]=g[1]});c.ajax({url:b.ajax.url,
type:"POST",dataType:"json",data:i,success:function(g,k,l){if(g.code==="/api/status/error")return h.ajax_error_handler(l,b);g=c(g.result.html);if(g.is("tr")){c(".data-table > tbody",b.prop_section).append(g);c(".data-table > thead",b.prop_section).show()}else c(".data-list",b.prop_section).append(g);b.form.trigger(b.event_prefix+"success")},error:function(g){h.ajax_error_handler(g,b)}})},value_edit_begin:function(b,i){var g;if(i.is("tr"))g=i.attr("data-id");else{g=c(".property-value:first",i);g=g.attr("data-id")||
g.attr("data-value")}var k={id:d,pid:b.attr("data-id"),lang:f,edit:g};c.ajax({url:a+"/value_edit_begin.ajax",data:k,dataType:"json",success:function(l){l=c(l.result.html).hide();l={mode:"edit",event_prefix:"propbox.edit.value_edit.",ajax:{data:k,url:a+"/value_edit_submit.ajax"},init:h.init_value_edit_form,validate:h.validate_value_edit_form,submit:h.submit_value_edit_form,form:l,prop_section:b,prop_row:i};h.init(l);l.form.bind("propbox.edit.value_edit.success",function(){console.log("propbox.edit.value_edit.success")})},
error:function(l){h.ajax_error(l,form)}})},init_data_input:function(b){c(".data-input",b.form).each(function(){c(this).data_input({suggest:j}).bind("submit",function(){b.form.trigger(b.event_prefix+"submit")}).bind("cancel",function(){b.form.trigger(b.event_prefix+"cancel")})})},validate_data_input:function(b){var i=true;c(".data-input",b.form).each(function(g){var k=c(this);k.data("$.data_input").validate(true);if(g===0&&!k.is(".valid"))i=h.data_input_required(b,k);else if(k.is(".error"))i=h.data_input_invalid(b,
k)});return i},reset_data_input:function(b){c(".data-input",b.form).each(function(){c(this).data("$.data_input").reset()})},init:function(b){if(b.mode==="add"){var i=c(">.data-section",b.prop_section);c(".data-table tr.empty-row, .data-list li.empty-row",i).hide();b.prop_section.append(b.form)}else if(b.mode==="edit"){b.prop_row.hide();b.prop_row.after(b.form)}var g=b.event_prefix||"propbox.edit.";b.form.bind(g+"submit",function(){h.submit(b)}).bind(g+"cancel",function(){h.cancel(b)}).bind(g+"error",
function(k,l){h.error(b,l);b.form.removeClass("loading")}).bind(g+"success",function(){b.form.removeClass("loading")});c(".button-submit",b.form).click(function(){b.form.trigger(g+"submit")});c(".button-cancel",b.form).click(function(){b.form.trigger(g+"cancel")});b.form.show();e.kbs.scroll_to(b.prop_section);b.init(b)},cancel:function(b){b.form.hide().remove();b.prop_section.removeClass("editing");b=c(">.data-section",b.prop_section);c(".data-table tr, .data-list li",b).filter(":not(.empty-row)").length||
c(".data-table tr.empty-row, .data-list li.empty-row",b).show()},submit:function(b){if(!b.form.is(".loading")){document.activeElement&&c(document.activeElement).blur();h.clear_form_message(b);if(b.validate)if(!b.validate(b))return;b.form.addClass("loading");b.submit&&b.submit(b)}},data_input_required:function(b,i){var g=i.prev(".form-label").text();h.form_error(b,"Required: "+g)},data_input_invalid:function(b,i){var g=i.prev(".form-label").text();h.form_error(b,"Invalid: "+g)},form_error:function(b,
i){return h.form_message(b,i,"error")},form_message:function(b,i,g){var k=c('<a class="close-msg" href="#">x</a>').click(function(){c(this).parents("tr:first").remove();return false});i=c("<span>").text(i);k=c("<td>").append(k).append(i);k=c('<tr class="row-msg">').append(k);g&&k.addClass("row-msg-"+g);c(".edit-row",b.form).before(k);return k},clear_form_message:function(b){c(".row-msg",b.form).remove()},ajax_error:function(b,i){var g;try{g=JSON.parse(b.responseText);if(g.messages&&g.messages.length)g=
JSON.stringify(g.messages[0])}catch(k){}if(!g)g=b.responseText;h.error(i,g);i.form.removeClass("loading")}}})(jQuery,window.propbox);
