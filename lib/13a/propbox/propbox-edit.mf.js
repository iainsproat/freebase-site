
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
(function(c,d){d.require("dojo.date.stamp");d.require("dojo.date.locale");d.require("dojo.number");c.fn.validate_input=function(b){return this.each(function(){var f=c(this);if(f.is(":text")){var h=f.data("$.validate_input");h&&h._destroy();h=new e(this,b);f.data("$.validate_input",h)}})};var e=c.validate_input=function(b,f){var h=this.options=c.extend(true,{},e.defaults,f);if(typeof h.validator!=="function")throw"A validator is required";if(!h.lang)h.lang="/lang/en";h.lang=h.lang==="/lang/en"?["lang/en"]:
[h.lang,"/lang/en"];h.locales=[];c.each(h.lang,function(k,a){h.locales[k]=d.i18n.normalizeLocale(a.split("/").pop())});this.input=c(b);this.init();var m=this;this.input.bind("remove",function(){m._destroy()});return this};e.prototype={init:function(){var b=this;this.input.bind("keyup.validate_input",function(f){b.textchange(f)}).bind(c.browser.msie?"paste.validate_input":"input.validate_input",function(f){b.textchange(f)}).bind("keypress.validate_input",function(f){f.keyCode===13&&b.validate(true)}).bind("blur.validate_input",
function(){b.validate(true)})},_destroy:function(){this.input.unbind(".validate_input")},valid:function(b){this.input.trigger("valid",b)},invalid:function(b,f){this.input.trigger("invalid",f)},empty:function(){this.input.trigger("empty")},textchange:function(){clearTimeout(this.textchange_timeout);var b=this;this.textchange_timeout=setTimeout(function(){b.validate()},200)},validate:function(b){b&&clearTimeout(this.textchange_timeout);b=this.options;var f=c.trim(this.input.val());if(f==="")return this.empty();
try{return this.valid(b.validator(f,b))}catch(h){return this.invalid(f,""+h)}}};c.extend(e,{defaults:{validator:function(b){return{text:b,value:b}}},log:function(){},invalid:function(b,f,h,m){throw new Error("Invalid "+h+(m?": "+m:""));},text:function(b,f){if(b.lengh>4096)return this.invalid(b,f,type,"Text too long");return{text:b,value:b}},topic:function(){return e.defaults.validator},enumerated:function(){return e.defaults.validator},"boolean":function(){return e.defaults.validator},uri:function(b,
f){var h=e.uri.regex;if(!h)h=e.uri.regex=/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
if(h.test(b))return{text:b,value:b};return e.invalid(b,f,"uri")},"int":function(b,f){return e.number.parse(b,f,false)},"float":function(b,f){return e.number.parse(b,f,true)},number:function(b,f,h){return e.number.parse(b,f,h)},datetime:function(b,f){return e.datetime.parse(b,f)},mqlkey:function(b,f){var h=e.mqlkey.regex;if(!h)h=e.mqlkey.regex=/^[A-Za-z0-9][A-Za-z0-9_-]*$/;if(h.test(b))return{text:b,value:b};return e.invalid(b,f,"mqlkey")}});c.extend(e.number,{parse:function(b,f,h){var m=f&&f.locales||
["en"],k,a;k=0;for(a=m.length;k<a;k++){var g=m[k];f=d.number.parse(b,{locale:g});if(!isNaN(f)){b={};if(h){b.value=f;b.text=d.number.format(f,{locale:g})}else{b.value=d.number.round(f,0);b.text=d.number.format(b.value,{locale:g})}return b}}throw e.invalid("number",b);}});c.extend(e.datetime,{formats:["yyyy",["dateFormatItem-y"],"yyyy-MM",["dateFormatItem-yM","dateFormatItem-yMMM"],"yyyy-MM-dd",["dateFormat-short","dateFormat-medium","dateFormat-long"]],parse:function(b,f){if(!d.date.stamp._isoRegExp)d.date.stamp._isoRegExp=
/^(?:(-?\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(.\d+)?)?((?:[+-](\d{2}):(\d{2}))|Z)?)?$/;var h=d.date.stamp.fromISOString(b);if(h)return{text:b,value:b,date:h};var m=f&&f.locales||["en"],k,a,g,i,j,l;k=0;for(a=m.length;k<a;k++){var o=m[k],n=d.date.locale._getGregorianBundle(o);g=0;for(i=e.datetime.formats.length;g<i;g+=2){var p=e.datetime.formats[g],r=e.datetime.formats[g+1];j=0;for(l=r.length;j<l;j++){var q=n[r[j]];if(q){q=i18n.normalize_pattern(q);try{h=d.date.locale.parse(b,
{datePattern:q,selector:"date",locale:o});return{text:b,value:d.date.locale.format(h,{datePattern:p,selector:"date"}),date:h}}catch(s){}}}}}throw e.invalid("datetime",b);}})})(jQuery,dojo);
(function(c){c.fn.data_input=function(d){return this.each(function(){var e=c(this),b=e.data("$.data_input");b&&b._destroy();b=new c.data_input(this,d);e.data("$.data_input",b)})};c.data_input=function(d,e){this.options=c.extend(true,{},c.data_input.defaults,e);this.container=c(d);this.metadata=this.container.metadata();this.input=c(":input",this.container);this.init();var b=this;this.input.bind("remove",function(){b._destroy()})};c.data_input.prototype={init:function(){var d=this,e=this.container,
b=this.input,f=this.options;b.bind("focusin.data_input",function(){d.container.addClass("focus")}).bind("focusout.data_input",function(){d.container.removeClass("focus")}).bind("valid.data_input",function(h,m){var k={name:d.input.attr("name")};if(m.id)k.id=m.id;else{k.value=m.value;if(d.metadata.type==="/type/text")k.lang=d.metadata.lang||f.lang}d.container.data("data",k);d.container.removeClass("error").addClass("valid");d.container.trigger("valid")}).bind("invalid.data_input",function(){d.container.removeData("data");
d.container.removeClass("valid").addClass("error");d.container.trigger("invalid")}).bind("empty.data_input",function(){var h={name:d.input.attr("name")};if(d.metadata&&d.metadata.lang)h.lang=d.metadata.lang;d.container.data("data",h);d.container.removeClass("valid").removeClass("error");d.container.trigger("empty")}).bind("keypress.data_input",function(h){h.keyCode===13&&!h.isDefaultPrevented()&&d.container.trigger("submit")}).bind("keyup.data_input",function(h){h.keyCode===27&&d.container.trigger("cancel")});
if(e.is(".topic")){b.validate_topic(c.extend(true,{},f.suggest,{type:d.metadata.type})).bind("valid.data_input",function(h,m){d.fb_select(m)}).bind("invalid.data_input",function(){d.fb_textchange()});if(this.metadata&&this.metadata.id){b.data("data.suggest",this.metadata);this.validate()}}else if(e.is(".text"))b.validate_input({validator:c.validate_input.text});else if(e.is(".datetime"))b.validate_input({validator:c.validate_input.datetime,lang:f.lang});else if(e.is(".enumerated")){b.validate_enumerated().bind("valid.data_input",
function(h,m){d.fb_select(m)}).bind("invalid.data_input",function(){d.fb_textchange()});this.metadata&&this.metadata.id&&this.validate()}else if(e.is(".int"))b.validate_input({validator:c.validate_input["int"],lang:f.lang});else if(e.is(".float"))b.validate_input({validator:c.validate_input["float"],lang:f.lang});else if(e.is(".uri"))b.validate_input({validator:c.validate_input.uri});else if(e.is(".boolean"))b.validate_boolean();else if(e.is(".enumeration"))b.validate_input({validator:c.validate_input.mqlkey});
else if(e.is(".rawstring"))b.validate_input({validator:c.validate_input.text});else throw new Error("Invalid data-input: "+e.attr("class"));},_destroy:function(){this.input.unbind(".data_input")},validate:function(){var d=this.input;c.each(["$.validate_topic","$.validate_input","$.validate_enumerated","$.validate_boolean"],function(e,b){var f=d.data(b);if(f){f.validate(true);return false}})},reset:function(){this.container.removeData("data");if(this.input.is(":text"))this.input.val("");else if(this.input.is("select"))this.input[0].selectedIndex=
0;else this.input.is(":radio")&&this.input.each(function(){this.checked=false})},fb_textchange:function(){},fb_select:function(){},ajax_beforeSend:function(d){if(!this.xhr_queue)this.xhr_queue=[];this.xhr_queue.push(d);this.container.trigger("loading")},ajax_complete:function(d){if(!this.xhr_queue)this.xhr_queue=[];for(var e=0,b=this.xhr_queue.length;e<b;e++)if(d===this.xhr_queue[e]){this.xhr_queue.splice(e,1);break}this.xhr_queue.length===0&&this.container.trigger("loading_complete")}};c.extend(c.data_input,
{defaults:{suggest:{service_url:"http://www.freebase.com",service_path:"/private/suggest",flyout_service_url:"http://www.freebase.com",flyout_service_path:"/private/flyout",mqlread_url:"http://api.freebase.com/api/service/mqlread",category:"object",type:"/common/topic"}}});c.fn.validate_topic=function(d){return this.each(function(){var e=c(this);if(e.is(":text")){var b=e.data("$.validate_topic");b&&b._destroy();b=new c.validate_topic(this,d);e.data("$.validate_topic",b)}})};c.validate_topic=function(d,
e){this.options=c.extend(true,{},e);this.input=c(d);this.init()};c.validate_topic.prototype={init:function(){var d=this;this.input.suggest(this.options).bind("fb-textchange.validate_topic",function(){d.input.val()===""?d.empty():d.invalid()}).bind("fb-select.validate_topic",function(e,b){d.input.val(b.name!=null?b.name:b.id);d.valid(b)})},invalid:function(){this.input.trigger("invalid")},valid:function(d){this.input.trigger("valid",d)},empty:function(){this.input.trigger("empty")},_destroy:function(){this.input.unbind(".validate_topic")},
validate:function(){if(this.input.val()==="")this.empty();else{var d=this.input.data("data.suggest");d?this.valid(d):this.invalid()}}};c.fn.validate_enumerated=function(d){return this.each(function(){var e=c(this);if(e.is("select")){var b=e.data("$.validate_enumerated");b&&b._destroy();b=new c.validate_enumerated(this,d);e.data("$.validate_enumerated",b)}})};c.validate_enumerated=function(d,e){this.options=c.extend(true,{},e);this.input=c(d);this.init()};c.validate_enumerated.prototype={init:function(){var d=
this;this.input.bind("change.validate_enumerated, keypress.validate_enumerated",function(){this.selectedIndex===0?d.empty():d.valid({text:c(":selected",this).text(),id:this.value})})},invalid:function(){this.input.trigger("invalid")},valid:function(d){this.input.trigger("valid",d);this.input.trigger("fb-select",d)},empty:function(){this.input.trigger("empty")},_destroy:function(){this.input.unbind(".validate_enumerated")},validate:function(){var d=this.input[0];d.selectedIndex>0?this.valid({text:c(":selected",
this.input).text(),id:d.value}):this.empty()}};c.fn.validate_boolean=function(d){var e,b;this.each(function(){var h=c(this);if(h.is(":radio"))if(h.val().toLowerCase()==="true")e=h;else if(h.val().toLowerCase()==="false")b=h});if(e&&b){var f=e.data("$.validate_boolean");f&&f._destroy();f=new c.validate_boolean(e,b,d);e.data("$.validate_boolean",f)}return this};c.validate_boolean=function(d,e,b){this.options=c.extend(true,{},b);this.tradio=d;this.fradio=e;this.input=this.tradio;this.init()};c.validate_boolean.prototype=
{init:function(){var d=this;this.tradio.bind("change.validate_boolean",function(){d.validate()})},_destroy:function(){this.input.unbind(".validate_boolean")},valid:function(d){this.input.trigger("valid",d)},empty:function(){this.input.trigger("empty")},validate:function(){if(this.tradio.is(":checked"))this.valid({text:this.tradio.text(),value:true});else this.fradio.is(":checked")?this.valid({text:this.fradio.text(),value:false}):this.empty()}}})(jQuery);
(function(c){var d=window.editparams={Empty:function(e,b,f){this.structure=e;this.data=b;this.msg=f;this.toString=function(){return"Empty: "+this.msg}},Invalid:function(e,b,f){this.structure=e;this.data=b;this.msg=f;this.toString=function(){return"Invalid: "+this.msg}},parse:function(e,b){function f(g,i,j,l,o){try{d.validate(i,j);o.push(j)}catch(n){if(n instanceof d.Empty)o.push(j);else throw n;}}var h=(e.values||[]).slice(),m=e.properties||[],k=e.expected_type.mediator||m.length;if(k){if(!m.length)throw new d.Invalid(e,
null,"mediator musth have 1 or more properties");if(h.length&&h.length!==1)throw new d.Invalid(e,null,"Can't edit more than one value (row) for a mediator");}var a=[];c(".data-input",b).each(function(){var g=c(this),i=g.data("$.data_input");if(!i)throw new d.Invalid(e,null,"$.data-input not initialized for",this);i.validate(true);if(g.is(".error"))throw new d.Invalid(e,null,"$.data-input is invalid",this);i=g.data("data");if(!i)throw new d.Invalid(e,null,"$.data-input has no data",this);if(k){if(!a.length){a.push({});
c.each(m,function(o,n){a[0][n.id]=c.extend({},n,{values:[]})})}var j=a[0][i.name];if(j){var l=[];if(h.length)l=h[0][j.id].values||[];f(g,j,i,l,j.values)}else console.warn("editparams","unknown mediator property data",i)}else f(g,e,i,h,a)});return k?d.parse_mediator(e,h,a):d.parse_simple(e,h,a)},parse_mediator:function(e,b,f){if(f.length!==1)throw new d.Invalid(e,f,"Must specify one (new or updated) value for a mediator");f=f[0];var h;if(b.length)h=b[0];var m={};if(h)m.id=h.id;else{m.id=null;m.create=
"unconditional";m.connect=e.unique?"replace":"insert";m.type=[{id:e.expected_type.id,connect:"insert"}];(b=e.expected_type.included_types)&&b.forEach(function(j){m.type.push({id:j,connect:"insert"})})}b=false;e=e.properties;for(var k=0,a=e.length;k<a;k++){var g=e[k],i=d.parse_simple(g,h&&h[g.id]&&h[g.id].values||[],f[g.id]&&f[g.id].values||[]);if(i.length){m[g.id]=i;b=true}}return b?[m]:[]},parse_simple:function(e,b,f){return d.diff(e,b,f)},diff:function(e,b,f){var h=e.expected_type,m=e.expected_type.id,
k=e.unique,a=m==="/type/text";if(k)if(!a)if(b.length&&b.length!==1)throw new d.Invalid(e,b,"Can't edit more than one value (row) for a unique property.");else if(f.length&&f.length!==1)throw new d.Invalid(e,f,"Can't edit more than one value (row) for a unique property.");var g=[];if(d.LITERAL_TYPE_IDS[m]){g.push("value");a&&g.push("lang")}else g.push("id");m=[];var i=[],j,l;j=0;for(l=b.length;j<l;j++){var o=b[j];d.validate(e,o);d.inArray.apply(null,[o,f].concat(g))===-1&&m.push(d.clause(o,"delete"))}j=
0;for(l=f.length;j<l;j++){o=f[j];try{d.validate(e,o)}catch(n){continue}if(d.inArray.apply(null,[o,b].concat(g))===-1){if(k)if(a){var p=d.inArray(o,m,"lang");p!==-1&&m.splice(p,1)}else return[d.clause(o,"replace",h)];i.push(d.clause(o,k?"replace":"insert",h))}}return m.concat(i)},validate:function(e,b){var f=e.expected_type.id;if(d.LITERAL_TYPE_IDS[f])if(d.isEmpty(b.value))throw new d.Empty(e,b);else{if(f==="/type/text"&&d.isEmpty(b.lang))throw new d.Invalid(e,b,"Expected data.lang for /type/text");
if(f==="/type/int"||f==="/type/float"){if(c.type(b.value)!=="number")throw new d.Invalid(e,b,"Expected number data.value for "+f);}else if(f==="/type/boolean"){if(c.type(b.value)!=="boolean")throw new d.Invalid(e,b,"Expected boolean data.value for /type/boolean");}else if(c.type(b.value)!=="string")throw new d.Invalid(e,b,"Expected string data.value for "+f);}else if(d.isEmpty(b.id))throw new d.Empty(e,b);return b},clause:function(e,b,f){var h={connect:b};if(e.id){h.id=e.id;if(b!=="delete"&&f&&!f.enumeration){var m=
[{id:f.id,connect:"insert"}];(e=f.included_types)&&e.forEach(function(k){m.push({id:k,connect:"insert"})});h.type=m}}else{h.value=e.value;if(e.lang)h.lang=e.lang}return h},inArray:function(e,b){var f=Array.prototype.slice.call(arguments,2);if(!f.length)return c.inArray(e,b);for(var h=0,m=b.length;h<m;h++){for(var k=b[h],a=true,g=0,i=f.length;g<i;g++){var j=f[g];if(k[j]!=e[j]){a=false;break}}if(a)return h}return-1},isEmpty:function(e){return e==null||e===""},LITERAL_TYPE_IDS:{"/type/int":1,"/type/float":1,
"/type/boolean":1,"/type/rawstring":1,"/type/uri":1,"/type/text":1,"/type/datetime":1,"/type/id":1,"/type/key":1,"/type/value":1,"/type/enumeration":1}}})(jQuery);
(function(c,d,e){var b=d.options.base_ajax_url,f=d.options.id,h=d.options.lang,m=d.options.suggest,k=d.edit={prop_add_begin:function(a,g){var i={s:f,p:a.attr("data-id"),lang:h};c.ajax({url:b+"/prop_add_begin.ajax",data:i,dataType:"json",success:function(j,l,o){if(j.code!=="/api/status/ok")return k.ajax_error(o,null,a);j=c(j.result.html).hide();var n={mode:"add",event_prefix:"propbox.edit.prop_add.",ajax:{data:i,url:b+"/prop_edit_submit.ajax"},init:k.init_prop_add_form,submit:k.submit_prop_add_form,
prop_section:a,msg_row:c(".row-msg",j),edit_row:c(".edit-row",j),submit_row:c(".edit-row-submit",j),structure:j.metadata()};k.init(n);n.edit_row.bind("propbox.edit.prop_add.success",function(){if(g)n.edit_row.trigger(n.event_prefix+"cancel");else{k.reset_data_inputs(n);c(":input:visible:first",n.edit_row).focus();c(".button-submit",n.submit_row).attr("disabled","disabled").addClass("disabled");c(".button-cancel",n.submit_row).text("Done")}})},error:function(j){k.ajax_error(j,null,a)}})},init_prop_add_form:function(a){k.init_data_inputs(a);
c(":input:visible:first",a.edit_row).focus()},submit_prop_add_form:function(a){var g=c.extend({},a.ajax.data);try{var i=e.parse(a.structure,a.edit_row);g.o=JSON.stringify(i)}catch(j){g=c(".data-input.error",a.edit_row);if(g.length){a.edit_row.trigger(a.event_prefix+"error","Please specify a valid value");g.eq(0).find(":input").focus().select()}else a.edit_row.trigger(a.event_prefix+"error",j.toString());return}c.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:g,success:function(l,o,n){if(l.code!==
"/api/status/ok")return k.ajax_error(n,a);l=c(l.result.html);a.msg_row.before(l);i18n.ize(l);c(".edit",l).show();d.init_menus(l,true);d.kbs.set_next(null,l,true);a.edit_row.trigger(a.event_prefix+"success")},error:function(l){k.ajax_error(l,a)}})},value_edit_begin:function(a,g){var i;if(g.is("tr"))i=g.attr("data-id");else{i=c(".property-value:first",g);i=i.attr("data-id")||i.attr("data-value")||i.attr("datetime")}var j={s:f,p:a.attr("data-id"),replace:i,lang:h};c.ajax({url:b+"/value_edit_begin.ajax",
data:j,dataType:"json",success:function(l,o,n){if(l.code!=="/api/status/ok")return k.ajax_error(n,null,a,g);l=c(l.result.html).hide();var p={mode:"edit",event_prefix:"propbox.edit.value_edit.",ajax:{data:j,url:b+"/prop_edit_submit.ajax"},init:k.init_value_edit_form,submit:k.submit_value_edit_form,prop_section:a,prop_row:g,msg_row:c(".row-msg",l),edit_row:c(".edit-row",l),submit_row:c(".edit-row-submit",l),structure:l.metadata()};k.init(p);p.edit_row.bind("propbox.edit.value_edit.success",function(){p.msg_row.remove();
p.edit_row.remove();p.submit_row.remove()}).bind("propbox.edit.value_edit.cancel",function(){p.prop_row.show()}).bind("propbox.edit.value_edit.delete",function(){k.loading_begin(p);d.edit.value_delete_begin(a,g,function(){p.msg_row.remove();p.edit_row.remove();p.submit_row.remove()})})},error:function(l){k.ajax_error(l,null,a,g)}})},init_value_edit_form:function(a){k.init_data_inputs(a);c(":input:visible:first",a.edit_row).focus()},submit_value_edit_form:function(a){var g=c.extend({},a.ajax.data);
try{var i=e.parse(a.structure,a.edit_row);g.o=JSON.stringify(i)}catch(j){g=c(".data-input.error",a.edit_row);if(g.length){a.edit_row.trigger(a.event_prefix+"error","Please specify a valid value");g.eq(0).find(":input").focus().select()}else a.edit_row.trigger(a.event_prefix+"error",j.toString());return}c.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:g,success:function(l,o,n){if(l.code!=="/api/status/ok")return k.ajax_error(n,a);l=c(l.result.html);a.prop_row.after(l);i18n.ize(l);c(".edit",
l).show();d.init_menus(l,true);d.kbs.set_next(null,l,true);a.prop_row.remove();a.edit_row.trigger(a.event_prefix+"success")},error:function(l){k.ajax_error(l,a)}})},value_delete_begin:function(a,g,i){var j;if(g.is("tr"))j=g.attr("data-id");else{j=c(".property-value:first",g);j=j.attr("data-id")||j.attr("data-value")||j.attr("datetime")}j={s:f,p:a.attr("data-id"),o:j,lang:h};c.ajax({url:b+"/value_delete_submit.ajax",type:"POST",data:j,dataType:"json",success:function(l,o,n){if(l.code!=="/api/status/ok")return k.ajax_error(n,
null,a,g);l=c(l.result.html);g.before(l);g.hide();a.removeClass("editing");i&&i()},error:function(l){k.ajax_error(l,null,a,g)}})},value_delete_undo:function(a){var g=c(a).parents(".row-msg:first"),i=g.next(".data-row:hidden"),j=i.parents(".property-section");if(i.is("tr"))a=i.attr("data-id");else{a=c(".property-value:first",i);a=a.attr("data-id")||a.attr("data-value")||a.attr("datetime")}a={s:f,p:j.attr("data-id"),o:a,lang:h};c.ajax({url:b+"/value_delete_undo.ajax",type:"POST",data:a,dataType:"json",
success:function(l,o,n){if(l.code!=="/api/status/ok")return k.ajax_error(n,null,j,i);i.show();g.remove()},error:function(l){k.ajax_error(l,null,j,i)}});return false},loading_begin:function(a){c.each([a.edit_row,a.msg_row,a.submit_row],function(g,i){i&&i.addClass("loading")})},loading_complete:function(a){c.each([a.edit_row,a.msg_row,a.submit_row],function(g,i){i&&i.removeClass("loading")})},init_data_inputs:function(a){c(".data-input",a.edit_row).each(function(){k.init_data_input(c(this),a)})},init_data_input:function(a,
g){a.data_input({lang:h,suggest:m}).bind("valid",function(){g.edit_row.trigger(g.event_prefix+"valid");var i=a.parent(".form-field"),j=i.next(".magicbox-template");if(j.length){j=c("<div>").html(j.html());j=c(".form-field",j);i.after(j);k.init_data_input(c(".data-input",j),g)}}).bind("empty",function(){g.edit_row.trigger(g.event_prefix+"valid")}).bind("invalid",function(){g.edit_row.trigger(g.event_prefix+"invalid")}).bind("submit",function(){g.edit_row.trigger(g.event_prefix+"submit")}).bind("cancel",
function(){g.edit_row.trigger(g.event_prefix+"cancel")}).bind("loading",function(){c(this).addClass("loading")}).bind("loading_complete",function(){c(this).removeClass("loading")});if(a.is(".datetime"))i18n.ize_datetime_input(c(":text",a));else if(a.is(".int")||a.is(".float"))i18n.ize_number_input(c(":text",a))},reset_data_inputs:function(a){c(".data-input",a.edit_row).each(function(){c(this).data("$.data_input").reset()})},init:function(a){if(a.mode==="add"){var g=c(">.data-section",a.prop_section);
c("> .data-table > tbody > .empty-row, > .data-list > .empty-row",g).hide();c("> .data-table > tbody, > .data-list",g).append(a.msg_row).append(a.edit_row).append(a.submit_row)}else if(a.mode==="edit"){a.prop_row.hide();a.prop_row.after(a.msg_row);a.msg_row.after(a.edit_row);a.edit_row.after(a.submit_row)}c(".data-table > thead",a.prop_section).show();var i=a.event_prefix||"propbox.edit.";a.edit_row.bind(i+"valid",function(){c(".button-submit",a.submit_row).removeAttr("disabled").removeClass("disabled")}).bind(i+
"invalid",function(){c(".button-submit",a.submit_row).attr("disabled","disabled").addClass("disabled")}).bind(i+"submit",function(){k.submit(a)}).bind(i+"cancel",function(){k.cancel(a)}).bind(i+"error",function(j,l){k.error(a,l);k.loading_complete(a);a.prop_section.removeClass("editing")}).bind(i+"success",function(){k.loading_complete(a);a.prop_section.removeClass("editing")});c(".button-submit",a.submit_row).click(function(){a.edit_row.trigger(i+"submit")});c(".button-cancel",a.submit_row).click(function(){a.edit_row.trigger(i+
"cancel")});c(".button-delete",a.submit_row).click(function(){a.edit_row.trigger(i+"delete")});a.edit_row.show();a.submit_row.show();d.kbs.scroll_to(a.prop_section);a.init&&a.init(a)},cancel:function(a){a.msg_row.remove();a.edit_row.remove();a.submit_row.remove();a.prop_section.removeClass("editing");a=c(">.data-section",a.prop_section);c("> .data-table > tbody > tr, > .data-list > li",a).filter(":not(.empty-row)").length||c("> .data-table > tbody > .empty-row, > .data-list > .empty-row",a).show()},
submit:function(a){if(!a.edit_row.is(".loading"))if(!c(".button-submit",a.submit_row).is(":disabled")){document.activeElement&&c(document.activeElement).blur();k.clear_form_message(a);k.loading_begin(a);a.submit&&a.submit(a)}},error:function(a,g){c(".button-submit",a.submit_row).attr("disabled","disabled").addClass("disabled");return k.form_message(a,g,"error")},form_message:function(a,g,i){a.msg_row.find(".close-msg").css("visibility","visible").next().find(".msg-default").hide().next().text(g);
a.msg_row.attr("class","row-msg");i&&a.msg_row.addClass("row-msg-"+i)},clear_form_message:function(a){a.msg_row.find(".close-msg").css("visibility","hidden").next().find(".msg-default").show().next().html("&nbsp;")},ajax_error:function(a,g,i,j){a=a.responseText;if(g)g.edit_row.trigger(g.event_prefix+"error",a);else{g=c(".data-table",i);a=g.length?k.row_msg(a,"error","tr",c(">thead>tr:first>th",g).length):k.row_msg(a,"error","li");if(j){j.before(a);j.is(".edit-row")?j.removeClass("loading"):i.removeClass("editing")}else{g.length?
c(">tbody",g).append(a):c(".data-list",i).append(a);i.removeClass("editing")}}},row_msg:function(a,g,i,j){var l=c('<a class="close-msg" href="#">x</a>').click(function(){c(this).parents(".row-msg:first").remove();return false}),o=c("<span>").text(a);a=c("<"+i+' class="row-msg">');if(i==="tr"){i=c("<td>").append(l).append(o);j&&i.attr("colspan",j);a.append(i)}else a.append(l).append(o);g&&a.addClass("row-msg-"+g);return a}}})(jQuery,window.propbox,window.editparams);
