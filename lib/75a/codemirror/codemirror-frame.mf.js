
/*
 * Copyright 2012, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Additional Licenses for Third Party components can be found here:
 * http://wiki.freebase.com/wiki/Freebase_Site_License
 *
 */
function method(g,m){return function(){g[m].apply(g,arguments)}}var StopIteration={toString:function(){return"StopIteration"}};function forEach(g,m){if(g.next)try{for(;;)m(g.next())}catch(j){if(j!=StopIteration)throw j;}else for(var l=0;l<g.length;l++)m(g[l])}function map(g,m){var j=[];forEach(g,function(l){j.push(m(l))});return j}function matcher(g){return function(m){return g.test(m)}}function hasClass(g,m){var j=g.className;return j&&(new RegExp("(^| )"+m+"($| )")).test(j)}
function insertAfter(g,m){m.parentNode.insertBefore(g,m.nextSibling);return g}function removeElement(g){g.parentNode&&g.parentNode.removeChild(g)}function clearElement(g){for(;g.firstChild;)g.removeChild(g.firstChild)}function isAncestor(g,m){for(;m=m.parentNode;)if(g==m)return true;return false}var nbsp="\u00a0",matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("};
function normalizeEvent(g){if(!g.stopPropagation){g.stopPropagation=function(){this.cancelBubble=true};g.preventDefault=function(){this.returnValue=false}}if(!g.stop)g.stop=function(){this.stopPropagation();this.preventDefault()};if(g.type=="keypress"){g.code=g.charCode==null?g.keyCode:g.charCode;g.character=String.fromCharCode(g.code)}return g}
function addEventHandler(g,m,j,l){function n(o){j(normalizeEvent(o||window.event))}if(typeof g.addEventListener=="function"){g.addEventListener(m,n,false);if(l)return function(){g.removeEventListener(m,n,false)}}else{g.attachEvent("on"+m,n);if(l)return function(){g.detachEvent("on"+m,n)}}}function nodeText(g){return g.textContent||g.innerText||g.nodeValue||""}function nodeTop(g){for(var m=0;g.offsetParent;){m+=g.offsetTop;g=g.offsetParent}return m}
function isBR(g){g=g.nodeName;return g=="BR"||g=="br"}function isSpan(g){g=g.nodeName;return g=="SPAN"||g=="span"}
var stringStream=function(g){function m(){for(;l==j.length;){n+=j;j="";l=0;try{j=g.next()}catch(o){if(o!=StopIteration)throw o;else return false}}return true}var j="",l=0,n="";return{peek:function(){if(!m())return null;return j.charAt(l)},next:function(){if(!m())if(n.length>0)throw"End of stringstream reached without emptying buffer ('"+n+"').";else throw StopIteration;return j.charAt(l++)},get:function(){var o=n;n="";if(l>0){o+=j.slice(0,l);j=j.slice(l);l=0}return o},push:function(o){j=j.slice(0,
l)+o+j.slice(l)},lookAhead:function(o,p,h,b){function a(k){return b?k.toLowerCase():k}o=a(o);var c=false,d=n,e=l;for(h&&this.nextWhileMatches(/[\s\u00a0]/);;){h=l+o.length;var f=j.length-l;if(h<=j.length){c=o==a(j.slice(l,h));l=h;break}else if(o.slice(0,f)==a(j.slice(l))){n+=j;j="";try{j=g.next()}catch(i){break}l=0;o=o.slice(f)}else break}if(!(c&&p)){j=n.slice(d.length)+j;l=e;n=d}return c},more:function(){return this.peek()!==null},applies:function(o){var p=this.peek();return p!==null&&o(p)},nextWhile:function(o){for(var p;(p=
this.peek())!==null&&o(p);)this.next()},matches:function(o){var p=this.peek();return p!==null&&o.test(p)},nextWhileMatches:function(o){for(var p;(p=this.peek())!==null&&o.test(p);)this.next()},equals:function(o){return o===this.peek()},endOfLine:function(){var o=this.peek();return o==null||o=="\n"}}},select={};
(function(){function g(a,c){for(;a&&a.parentNode!=c;)a=a.parentNode;return a}function m(a,c){for(;!a.previousSibling&&a.parentNode!=c;)a=a.parentNode;return g(a.previousSibling,c)}function j(a){var c=a.nextSibling;if(c){for(;c.firstChild;)c=c.firstChild;return c.nodeType==3||isBR(c)?c:j(c)}else{for(a=a.parentNode;a&&!a.nextSibling;)a=a.parentNode;return a&&j(a)}}select.ie_selection=document.selection&&document.selection.createRangeCollection;select.scrollToNode=function(a,c){if(a){for(var d=a,e=document.body,
f=document.documentElement,i=!d.nextSibling||!d.nextSibling.nextSibling||!d.nextSibling.nextSibling.nextSibling,k=0;d&&!d.offsetTop;){k++;d=d.previousSibling}if(k==0)i=false;if(!(webkit&&d&&d.offsetTop==5&&d.offsetLeft==5)){k=k*(d?d.offsetHeight:0);var q=0,s=a?a.offsetWidth:0;for(d=d;d&&d.offsetParent;){k+=d.offsetTop;isBR(d)||(q+=d.offsetLeft);d=d.offsetParent}d=e.scrollLeft||f.scrollLeft||0;e=e.scrollTop||f.scrollTop||0;var t=false,v=window.innerWidth||f.clientWidth||0;if(c||s<v){if(c){var w=select.offsetInNode(a),
z=nodeText(a).length;if(z)q+=s*(w/z)}s=q-d;if(s<0||s>v){d=q;t=true}}q=k-e;if(q<0||i||q>(window.innerHeight||f.clientHeight||0)-50){e=i?1E6:k;t=true}t&&window.scrollTo(d,e)}}};select.scrollToCursor=function(a){select.scrollToNode(select.selectionTopNode(a,true)||a.firstChild,true)};var l=null;select.snapshotChanged=function(){if(l)l.changed=true};select.snapshotReplaceNode=function(a,c,d,e){function f(i){if(a==i.node){l.changed=true;if(d&&i.offset>d)i.offset-=d;else{i.node=c;i.offset+=e||0}}else if(select.ie_selection&&
i.offset==0&&i.node==j(a))l.changed=true}if(l){f(l.start);f(l.end)}};select.snapshotMove=function(a,c,d,e,f){function i(k){if(a==k.node&&(!f||k.offset==0)){l.changed=true;k.node=c;k.offset=e?Math.max(0,k.offset+d):d}}if(l){i(l.start);i(l.end)}};if(select.ie_selection){var n=function(a){function c(s){for(var t=null;!t&&s;){t=s.nextSibling;s=s.parentNode}return d(t)}function d(s){for(;s&&s.firstChild;)s=s.firstChild;return{node:s,offset:0}}var e=document.selection.createRange();e.collapse(a);a=e.parentElement();
if(!isAncestor(document.body,a))return null;if(!a.firstChild)return d(a);var f=e.duplicate();f.moveToElementText(a);f.collapse(true);for(var i=a.firstChild;i;i=i.nextSibling){if(i.nodeType==3){var k=i.nodeValue.length;f.move("character",k)}else{f.moveToElementText(i);f.collapse(false)}var q=e.compareEndPoints("StartToStart",f);if(q==0)return c(i);if(q!=1){if(i.nodeType!=3)return d(i);f.setEndPoint("StartToEnd",e);return{node:i,offset:k-f.text.length}}}return c(a)};select.markSelection=function(){l=
null;if(document.selection){var a=n(true),c=n(false);if(a&&c)l={start:a,end:c,changed:false}}};select.selectMarked=function(){function a(e){var f=document.body.createTextRange(),i=e.node;if(i)if(i.nodeType==3){f.moveToElementText(i.parentNode);for(e=e.offset;i.previousSibling;){i=i.previousSibling;e+=(i.innerText||"").length}f.move("character",e)}else{f.moveToElementText(i);f.collapse(true)}else{f.moveToElementText(document.body);f.collapse(false)}return f}if(l&&l.changed){var c=a(l.start),d=a(l.end);
c.setEndPoint("StartToEnd",d);c.select()}};select.offsetInNode=function(a){var c=document.selection;if(!c)return 0;c=c.createRange();var d=c.duplicate();try{d.moveToElementText(a)}catch(e){return 0}c.setEndPoint("StartToStart",d);return c.text.length};select.selectionTopNode=function(a,c){function d(v,w){if(w.nodeType==3){for(var z=0,A=w.previousSibling;A&&A.nodeType==3;){z+=A.nodeValue.length;A=A.previousSibling}if(A){try{v.moveToElementText(A)}catch(u){return false}v.collapse(false)}else v.moveToElementText(w.parentNode);
z&&v.move("character",z)}else try{v.moveToElementText(w)}catch(x){return false}return true}var e=document.selection;if(!e)return false;var f=e.createRange(),i=f.duplicate();f.collapse(c);var k=f.parentElement();if(k&&isAncestor(a,k)){i.moveToElementText(k);if(f.compareEndPoints("StartToStart",i)==1)return g(k,a)}c=0;for(k=a.childNodes.length-1;c<k;){var q=Math.ceil((k+c)/2),s=a.childNodes[q];if(!s)return false;if(!d(i,s))return false;if(f.compareEndPoints("StartToStart",i)==1)c=q;else k=q-1}if(c==
0){e=e.createRange();f=e.duplicate();try{f.moveToElementText(a)}catch(t){return null}if(e.compareEndPoints("StartToStart",f)==0)return null}return a.childNodes[c]||null};select.focusAfterNode=function(a,c){var d=document.body.createTextRange();d.moveToElementText(a||c);d.collapse(!a);d.select()};select.somethingSelected=function(){var a=document.selection;return a&&a.createRange().text!=""};var o=function(a){var c=document.selection;if(c){c=c.createRange();c.pasteHTML(a);c.collapse(false);c.select()}};
select.insertNewlineAtCursor=function(){o("<br>")};select.insertTabAtCursor=function(){o("\u00a0\u00a0\u00a0\u00a0")};select.cursorPos=function(a,c){var d=document.selection;if(!d)return null;for(var e=select.selectionTopNode(a,c);e&&!isBR(e);)e=e.previousSibling;d=d.createRange();var f=d.duplicate();d.collapse(c);if(e){f.moveToElementText(e);f.collapse(false)}else{try{f.moveToElementText(a)}catch(i){return null}f.collapse(true)}d.setEndPoint("StartToStart",f);return{node:e,offset:d.text.length}};
select.setCursorPos=function(a,c,d){function e(i){var k=document.body.createTextRange();if(i.node){k.moveToElementText(i.node);k.collapse(false)}else{k.moveToElementText(a);k.collapse(true)}k.move("character",i.offset);return k}var f=e(c);d&&d!=c&&f.setEndPoint("EndToEnd",e(d));f.select()};select.getBookmark=function(a){var c=select.cursorPos(a,true);a=select.cursorPos(a,false);if(c&&a)return{from:c,to:a}};select.setBookmark=function(a,c){c&&select.setCursorPos(a,c.from,c.to)}}else{var p=function(a,
c){for(;a.nodeType!=3&&!isBR(a);){var d=a.childNodes[c]||a.nextSibling;for(c=0;!d&&a.parentNode;){a=a.parentNode;d=a.nextSibling}a=d;if(!d)break}return{node:a,offset:c}};select.markSelection=function(){var a=window.getSelection();if(!a||a.rangeCount==0)return l=null;a=a.getRangeAt(0);l={start:p(a.startContainer,a.startOffset),end:p(a.endContainer,a.endOffset),changed:false}};select.selectMarked=function(){function a(){if(d.start.node==d.end.node&&d.start.offset==d.end.offset){var f=window.getSelection();
if(!f||f.rangeCount==0)return true;f=f.getRangeAt(0);f=p(f.startContainer,f.startOffset);return d.start.node!=f.node||d.start.offset!=f.offset}}function c(f,i){if(f.node)f.offset==0?e["set"+i+"Before"](f.node):e["set"+i](f.node,f.offset);else e.setStartAfter(document.body.lastChild||document.body)}var d=l;if(d&&(d.changed||webkit&&a())){var e=document.createRange();c(d.end,"End");c(d.start,"Start");h(e)}};var h=function(a){var c=window.getSelection();if(c){c.removeAllRanges();c.addRange(a)}},b=function(){var a=
window.getSelection();return!a||a.rangeCount==0?false:a.getRangeAt(0)};select.selectionTopNode=function(a,c){var d=b();if(!d)return false;var e=c?d.startContainer:d.endContainer,f=c?d.startOffset:d.endOffset;window.opera&&!c&&d.endContainer==a&&d.endOffset==d.startOffset+1&&a.childNodes[d.startOffset]&&isBR(a.childNodes[d.startOffset])&&f--;return e.nodeType==3?f>0?g(e,a):m(e,a):e.nodeName.toUpperCase()=="HTML"?f==1?null:a.lastChild:e==a?f==0?null:e.childNodes[f-1]:f==e.childNodes.length?g(e,a):f==
0?m(e,a):g(e.childNodes[f-1],a)};select.focusAfterNode=function(a,c){var d=document.createRange();d.setStartBefore(c.firstChild||c);if(a&&!a.firstChild)d.setEndAfter(a);else a?d.setEnd(a,a.childNodes.length):d.setEndBefore(c.firstChild||c);d.collapse(false);h(d)};select.somethingSelected=function(){var a=b();return a&&!a.collapsed};select.offsetInNode=function(a){var c=b();if(!c)return 0;c=c.cloneRange();c.setStartBefore(a);return c.toString().length};select.insertNodeAtCursor=function(a){var c=b();
if(c){c.deleteContents();c.insertNode(a);webkitLastLineHack(document.body);if(window.opera&&isBR(a)&&isSpan(a.parentNode)){c=a.nextSibling;var d=a.parentNode,e=d.parentNode;e.insertBefore(a,d.nextSibling);for(d="";c&&c.nodeType==3;c=c.nextSibling){d+=c.nodeValue;removeElement(c)}e.insertBefore(makePartSpan(d,document),a.nextSibling)}c=document.createRange();c.selectNode(a);c.collapse(false);h(c)}};select.insertNewlineAtCursor=function(){select.insertNodeAtCursor(document.createElement("BR"))};select.insertTabAtCursor=
function(){select.insertNodeAtCursor(document.createTextNode("\u00a0\u00a0\u00a0\u00a0"))};select.cursorPos=function(a,c){var d=b();if(d){for(var e=select.selectionTopNode(a,c);e&&!isBR(e);)e=e.previousSibling;d=d.cloneRange();d.collapse(c);e?d.setStartAfter(e):d.setStartBefore(a);d=d.toString();return{node:e,offset:d.length}}};select.setCursorPos=function(a,c,d){function e(i,k,q){function s(z){z.nodeType==3?t.push(z):forEach(z.childNodes,s)}if(k==0&&i&&!i.nextSibling){f["set"+q+"After"](i);return true}if(i=
i?i.nextSibling:a.firstChild){if(k==0){f["set"+q+"Before"](i);return true}for(var t=[];;){for(;i&&!t.length;){s(i);i=i.nextSibling}var v=t.shift();if(!v)return false;var w=v.nodeValue.length;if(w>=k){f["set"+q](v,k);return true}k-=w}}}var f=document.createRange();d=d||c;e(d.node,d.offset,"End")&&e(c.node,c.offset,"Start")&&h(f)}}})();
function UndoHistory(g,m,j,l){this.container=g;this.maxDepth=m;this.commitDelay=j;this.editor=l;this.parent=l.parent;this.last=this.first=g={text:"",from:null,to:null};this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[]}
UndoHistory.prototype={scheduleCommit:function(){var g=this;this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(function(){g.tryCommit()},this.commitDelay)},touch:function(g){this.setTouched(g);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var g=this.history.pop();this.redoHistory.push(this.updateTo(g,"applyChain"));this.notifyEnvironment();return this.chainNode(g)}},redo:function(){this.commit();if(this.redoHistory.length){var g=this.redoHistory.pop();
this.addUndoLevel(this.updateTo(g,"applyChain"));this.notifyEnvironment();return this.chainNode(g)}},clear:function(){this.history=[];this.redoHistory=[]},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length}},push:function(g,m,j){for(var l=[],n=0;n<j.length;n++){var o=n==j.length-1?m:this.container.ownerDocument.createElement("BR");l.push({from:g,to:o,text:cleanText(j[n])});g=o}this.pushChains([l],g==null&&m==null);this.notifyEnvironment()},pushChains:function(g,m){this.commit(m);
this.addUndoLevel(this.updateTo(g,"applyChain"));this.redoHistory=[]},chainNode:function(g){for(var m=0;m<g.length;m++){var j=g[m][0];if(j=j&&(j.from||j.to))return j}},reset:function(){this.history=[];this.redoHistory=[]},textAfter:function(g){return this.after(g).text},nodeAfter:function(g){return this.after(g).to},nodeBefore:function(g){return this.before(g).from},tryCommit:function(){if(window.parent&&window.UndoHistory)this.editor.highlightDirty()?this.commit(true):this.scheduleCommit()},commit:function(g){this.parent.clearTimeout(this.commitTimeout);
g||this.editor.highlightDirty(true);g=this.touchedChains();if(g.length){this.addUndoLevel(this.updateTo(g,"linkChain"));this.redoHistory=[];this.notifyEnvironment()}},updateTo:function(g,m){for(var j=[],l=[],n=0;n<g.length;n++){j.push(this.shadowChain(g[n]));l.push(this[m](g[n]))}m=="applyChain"&&this.notifyDirty(l);return j},notifyDirty:function(g){forEach(g,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},notifyEnvironment:function(){this.onChange&&this.onChange();window.frameElement&&
window.frameElement.CodeMirror.updateNumbers&&window.frameElement.CodeMirror.updateNumbers()},linkChain:function(g){for(var m=0;m<g.length;m++){var j=g[m];if(j.from)j.from.historyAfter=j;else this.first=j;if(j.to)j.to.historyBefore=j;else this.last=j}},after:function(g){return g?g.historyAfter:this.first},before:function(g){return g?g.historyBefore:this.last},setTouched:function(g){if(g){if(!g.historyTouched){this.touched.push(g);g.historyTouched=true}}else this.firstTouched=true},addUndoLevel:function(g){this.history.push(g);
this.history.length>this.maxDepth&&this.history.shift()},touchedChains:function(){function g(h,b){if(h)h.historyTemp=b;else n=b}function m(h){for(var b=[],a=h?h.nextSibling:l.container.firstChild;a&&(!isBR(a)||a.hackBR);a=a.nextSibling)!a.hackBR&&a.currentText&&b.push(a.currentText);return{from:h,to:a,text:cleanText(b.join(""))}}function j(h,b){for(var a=b+"Sibling",c=h[a];c&&!isBR(c);)c=c[a];return c}var l=this,n=null,o=[];l.firstTouched&&l.touched.push(null);forEach(l.touched,function(h){if(!(h&&
(h.parentNode!=l.container||h.hackBR))){if(h)h.historyTouched=false;else l.firstTouched=false;var b=m(h),a=l.after(h);if(!a||a.text!=b.text||a.to!=b.to){o.push(b);g(h,b)}}});var p=[];l.touched=[];forEach(o,function(h){if(h.from?h.from.historyTemp:n){for(var b=[],a=h.from,c=true;;){var d=a?a.historyTemp:n;if(!d)if(c)break;else d=m(a);b.unshift(d);g(a,null);if(!a)break;c=l.after(a);a=j(a,"previous")}a=h.to;for(c=l.before(h.from);;){if(!a)break;d=a?a.historyTemp:n;if(!d)if(c)break;else d=m(a);b.push(d);
g(a,null);c=l.before(a);a=j(a,"next")}p.push(b)}});return p},shadowChain:function(g){var m=[],j=this.after(g[0].from);for(g=g[g.length-1].to;;){m.push(j);j=j.to;if(!j||j==g)break;else j=j.historyAfter||this.before(g)}return m},applyChain:function(g){var m=select.cursorPos(this.container,false),j=this,l=g[0].from,n=g[g.length-1].to;(function(c,d){for(var e=c?c.nextSibling:j.container.firstChild;e!=d;){var f=e.nextSibling;removeElement(e);e=f}})(l,n);for(var o=0;o<g.length;o++){var p=g[o];o>0&&j.container.insertBefore(p.from,
n);var h=makePartSpan(fixSpaces(p.text));j.container.insertBefore(h,n);if(m&&m.node==p.from){h=0;var b=this.after(p.from);if(b&&o==g.length-1){for(var a=0;a<m.offset&&p.text.charAt(a)==b.text.charAt(a);a++);if(m.offset>a)h=p.text.length-b.text.length}select.setCursorPos(this.container,{node:p.from,offset:Math.max(0,m.offset+h)})}else m&&o==g.length-1&&m.node&&m.node.parentNode!=this.container&&select.setCursorPos(this.container,{node:p.from,offset:p.text.length})}this.linkChain(g);return l}};
var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent),webkit=/AppleWebKit/.test(navigator.userAgent),safari=/Apple Computer, Inc/.test(navigator.vendor),gecko=navigator.userAgent.match(/gecko\/(\d{8})/i);if(gecko)gecko=Number(gecko[1]);var mac=/Mac/.test(navigator.platform),brokenOpera=window.opera&&/Version\/10.[56]/.test(navigator.userAgent),slowWebkit=/AppleWebKit\/533/.test(navigator.userAgent);
function makeWhiteSpace(g){for(var m=[],j=true;g>0;g--){m.push(j||g==1?nbsp:" ");j^=true}return m.join("")}function fixSpaces(g){if(g.charAt(0)==" ")g=nbsp+g.slice(1);return g.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(m){return makeWhiteSpace(m.length)})}function cleanText(g){return g.replace(/\u00a0/g," ").replace(/\u200b/g,"")}
function makePartSpan(g){var m=g;if(g.nodeType==3)m=g.nodeValue;else g=document.createTextNode(m);var j=document.createElement("SPAN");j.isPart=true;j.appendChild(g);j.currentText=m;return j}
var webkitLastLineHack=webkit?function(g){var m=g.lastChild;if(!m||!m.hackBR){m=document.createElement("BR");m.hackBR=true;g.appendChild(m)}}:function(){},Editor=function(){function g(b){var a=makeWhiteSpace(indentUnit);return map(b.replace(/\t/g,a).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function m(b,a){function c(f,i){if(f.nodeType==3){if((f.nodeValue=fixSpaces(f.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "))).length)e=false;d.push(f)}else if(isBR(f)&&f.childNodes.length==
0){e=true;d.push(f)}else{for(var k=f.firstChild;k;k=k.nextSibling)c(k);if(!e&&h.hasOwnProperty(f.nodeName.toUpperCase())){e=true;if(!a||!i)d.push(document.createElement("BR"))}}}var d=[],e=true;c(b,true);return d}function j(b){function a(f){var i=f.parentNode,k=f.nextSibling;return function(q){i.insertBefore(q,k)}}var c=[],d=null,e=true;return{next:function(){if(!b)throw StopIteration;var f=b;b=f.nextSibling;var i;if(f.isPart&&f.childNodes.length==1&&f.firstChild.nodeType==3){f.currentText=f.firstChild.nodeValue;
i=!/[\n\t\r]/.test(f.currentText)}else i=false;if(i){c.push(f);e=false;return f.currentText}else if(isBR(f)){e&&window.opera&&f.parentNode.insertBefore(makePartSpan(""),f);c.push(f);e=true;return"\n"}else{i=!f.nextSibling;d=a(f);removeElement(f);f=m(f,i);for(i=0;i<f.length;i++){var k=i,q=f[i],s="\n";if(q.nodeType==3){select.snapshotChanged();q=makePartSpan(q);s=q.currentText;e=false}else{e&&window.opera&&d(makePartSpan(""));e=true}q.dirty=true;c.push(q);d(q);f[k]=s}return f.join("")}},nodes:c}}function l(b){for(;b&&
!isBR(b);)b=b.previousSibling;return b}function n(b,a){if(b){if(isBR(b))b=b.nextSibling}else b=a.firstChild;for(;b&&!isBR(b);)b=b.nextSibling;return b}function o(b,a,c,d){function e(k){k=cleanText(b.history.textAfter(k));return d?k.toLowerCase():k}this.editor=b;this.history=b.history;this.history.commit();this.valid=!!a;this.atOccurrence=false;if(d==undefined)d=a==a.toLowerCase();var f={node:null,offset:0};if(c&&typeof c=="object"&&typeof c.character=="number"){b.checkLine(c.line);c={node:c.line,
offset:c.character};this.pos={from:c,to:c}}else this.pos=c?{from:select.cursorPos(b.container,true)||f,to:select.cursorPos(b.container,false)||f}:{from:f,to:f};if(d)a=a.toLowerCase();var i=a.split("\n");this.matches=i.length==1?function(k,q,s){var t=e(q),v=a.length,w;if(k?s>=v&&(w=t.lastIndexOf(a,s-v))!=-1:(w=t.indexOf(a,s))!=-1)return{from:{node:q,offset:w},to:{node:q,offset:w+v}}}:function(k,q,s){var t=k?i.length-1:0,v=i[t],w=e(q),z=k?w.indexOf(v)+v.length:w.lastIndexOf(v);if(!(k?z>=s||z!=v.length:
z<=s||z!=w.length-v.length))for(s=q;;){if(k&&!s)return;s=k?this.history.nodeBefore(s):this.history.nodeAfter(s);if(!k&&!s)return;w=e(s);v=i[k?--t:++t];if(t>0&&t<i.length-1)if(w!=v)return;else continue;t=k?w.lastIndexOf(v):w.indexOf(v)+v.length;if(k?t!=w.length-v.length:t!=v.length)return;return{from:{node:k?s:q,offset:k?t:z},to:{node:k?q:s,offset:k?z:t}}}}}function p(b){this.options=b;window.indentUnit=b.indentUnit;this.parent=parent;var a=this.container=document.body;this.history=new UndoHistory(a,
b.undoDepth,b.undoDelay,this);var c=this;if(!p.Parser)throw"No parser loaded.";b.parserConfig&&p.Parser.configure&&p.Parser.configure(b.parserConfig);b.readOnly||select.setCursorPos(a,{node:null,offset:0});this.dirty=[];this.importCode(b.content||"");this.history.onChange=b.onChange;if(b.readOnly){if(!b.textWrapping)a.style.whiteSpace="nowrap"}else{if(b.continuousScanning!==false){this.scanner=this.documentScanner(b.passTime);this.delayScanning()}var d=function(){if(document.body.contentEditable!=
undefined&&internetExplorer)document.body.contentEditable="true";else document.designMode="on";if(internetExplorer&&b.height!="dynamic")document.body.style.minHeight=frameElement.clientHeight-2*document.body.offsetTop-5+"px";document.documentElement.style.borderWidth="0";if(!b.textWrapping)a.style.whiteSpace="nowrap"};try{d()}catch(e){var f=addEventHandler(document,"focus",function(){f();d()},true)}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,
"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));var i=function(){c.cursorActivity(false)};addEventHandler(document.body,"mouseup",i);addEventHandler(document.body,"cut",i);gecko&&addEventHandler(window,"pagehide",function(){c.unloaded=true});addEventHandler(document.body,"paste",function(k){i();var q=null;try{var s=k.clipboardData||window.clipboardData;if(s)q=s.getData("Text")}catch(t){}if(q!==null){k.stop();c.replaceSelection(q);select.scrollToCursor(c.container)}});this.options.autoMatchParens&&
addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}}var h={P:true,DIV:true,LI:true};o.prototype={findNext:function(){return this.find(false)},findPrevious:function(){return this.find(true)},find:function(b){function a(){var i={node:e,offset:f};c.pos={from:i,to:i};return c.atOccurrence=false}if(!this.valid)return false;var c=this,d=b?this.pos.from:this.pos.to,e=d.node,f=d.offset;if(e&&!e.parentNode){e=null;f=0}for(;;){if(this.pos=this.matches(b,e,f))return this.atOccurrence=
true;if(b){if(!e)return a();e=this.history.nodeBefore(e);f=this.history.textAfter(e).length}else{d=this.history.nodeAfter(e);if(!d){f=this.history.textAfter(e).length;return a()}e=d;f=0}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.pos.from,this.pos.to);select.scrollToCursor(this.editor.container)}},replace:function(b){if(this.atOccurrence){this.pos.to=this.editor.replaceRange(this.pos.from,this.pos.to,b);this.atOccurrence=false}},position:function(){if(this.atOccurrence)return{line:this.pos.from.node,
character:this.pos.from.offset}}};p.prototype={importCode:function(b){this.history.push(null,null,g(b));this.history.reset()},getCode:function(){if(!this.container.firstChild)return"";var b=[];select.markSelection();forEach(j(this.container.firstChild),method(b,"push"));webkitLastLineHack(this.container);select.selectMarked();webkit&&this.container.lastChild.hackBR&&b.pop();return cleanText(b.join(""))},checkLine:function(b){if(b===false||!(b==null||b.parentNode==this.container))throw parent.CodeMirror.InvalidLineHandle;
},cursorPosition:function(b){if(b==null)b=true;return(b=select.cursorPos(this.container,b))?{line:b.node,character:b.offset}:{line:null,character:0}},firstLine:function(){return null},lastLine:function(){return this.container.lastChild?l(this.container.lastChild):null},nextLine:function(b){this.checkLine(b);return n(b,this.container)||false},prevLine:function(b){this.checkLine(b);if(b==null)return false;return l(b.previousSibling)},visibleLineCount:function(){for(var b=this.container.firstChild;b&&
isBR(b);)b=b.nextSibling;if(!b)return false;return Math.floor((window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight)/b.offsetHeight)},selectLines:function(b,a,c,d){this.checkLine(b);b={node:b,offset:a};a=null;if(d!==undefined){this.checkLine(c);a={node:c,offset:d}}select.setCursorPos(this.container,b,a);select.scrollToCursor(this.container)},lineContent:function(b){var a=[];for(b=b?b.nextSibling:this.container.firstChild;b&&!isBR(b);b=b.nextSibling)a.push(nodeText(b));
return cleanText(a.join(""))},setLineContent:function(b,a){this.history.commit();this.replaceRange({node:b,offset:0},{node:b,offset:this.history.textAfter(b).length},a);this.addDirtyNode(b);this.scheduleHighlight()},removeLine:function(b){for(var a=b?b.nextSibling:this.container.firstChild;a;){var c=a.nextSibling;removeElement(a);if(isBR(a))break;a=c}this.addDirtyNode(b);this.scheduleHighlight()},insertIntoLine:function(b,a,c){var d=null;if(a=="end")d=n(b,this.container);else for(var e=b?b.nextSibling:
this.container.firstChild;e;e=e.nextSibling){if(a==0){d=e;break}var f=nodeText(e);if(f.length>a){d=e.nextSibling;c=f.slice(0,a)+c+f.slice(a);removeElement(e);break}a-=f.length}a=g(c);for(c=0;c<a.length;c++){c>0&&this.container.insertBefore(document.createElement("BR"),d);this.container.insertBefore(makePartSpan(a[c]),d)}this.addDirtyNode(b);this.scheduleHighlight()},selectedText:function(){var b=this.history;b.commit();var a=select.cursorPos(this.container,true),c=select.cursorPos(this.container,
false);if(!a||!c)return"";if(a.node==c.node)return b.textAfter(a.node).slice(a.offset,c.offset);var d=[b.textAfter(a.node).slice(a.offset)];for(a=b.nodeAfter(a.node);a!=c.node;a=b.nodeAfter(a))d.push(b.textAfter(a));d.push(b.textAfter(c.node).slice(0,c.offset));return cleanText(d.join("\n"))},replaceSelection:function(b){this.history.commit();var a=select.cursorPos(this.container,true),c=select.cursorPos(this.container,false);if(a&&c){c=this.replaceRange(a,c,b);select.setCursorPos(this.container,
c);webkitLastLineHack(this.container)}},cursorCoords:function(b){function a(i,k){var q=-(document.body.scrollTop||document.documentElement.scrollTop||0),s=-(document.body.scrollLeft||document.documentElement.scrollLeft||0)+k;forEach([i,window.frameElement],function(t){for(;t;){s+=t.offsetLeft;q+=t.offsetTop;t=t.offsetParent}});return{x:s,y:q,yBot:q+i.offsetHeight}}function c(i,k){var q=document.createElement("SPAN");q.appendChild(document.createTextNode(i));try{return k(q)}finally{q.parentNode&&q.parentNode.removeChild(q)}}
var d=select.cursorPos(this.container,b);if(!d)return null;b=d.offset;for(var e=d.node,f=this;b;){e=e?e.nextSibling:this.container.firstChild;d=nodeText(e);if(b<d.length)return c(d.substr(0,b),function(i){i.style.position="absolute";i.style.visibility="hidden";i.className=e.className;f.container.appendChild(i);return a(e,i.offsetWidth)});b-=d.length}return e&&isSpan(e)?a(e,e.offsetWidth):e&&e.nextSibling&&isSpan(e.nextSibling)?a(e.nextSibling,0):c("\u200b",function(i){e?e.parentNode.insertBefore(i,
e.nextSibling):f.container.insertBefore(i,f.container.firstChild);return a(i,0)})},reroutePasteEvent:function(){if(!(this.capturingPaste||window.opera||gecko&&gecko>=20101026)){this.capturingPaste=true;var b=window.frameElement.CodeMirror.textareaHack;parent.focus();b.value="";b.focus();var a=this;this.parent.setTimeout(function(){a.capturingPaste=false;window.focus();a.selectionSnapshot&&window.select.setBookmark(a.container,a.selectionSnapshot);var c=b.value;if(c){a.replaceSelection(c);select.scrollToCursor(a.container)}},
10)}},replaceRange:function(b,a,c){c=g(c);c[0]=this.history.textAfter(b.node).slice(0,b.offset)+c[0];var d=c[c.length-1];c[c.length-1]=d+this.history.textAfter(a.node).slice(a.offset);a=this.history.nodeAfter(a.node);this.history.push(b.node,a,c);return{node:this.history.nodeBefore(a),offset:d.length}},getSearchCursor:function(b,a,c){return new o(this,b,a,c)},reindent:function(){this.container.firstChild&&this.indentRegion(null,this.container.lastChild)},reindentSelection:function(b){if(select.somethingSelected()){var a=
select.selectionTopNode(this.container,true),c=select.selectionTopNode(this.container,false);a===false||c===false||this.indentRegion(a,c,b)}else this.indentAtCursor(b)},grabKeys:function(b,a){this.frozen=b;this.keyFilter=a},ungrabKeys:function(){this.frozen="leave"},setParser:function(b,a){p.Parser=window[b];(a=a||this.options.parserConfig)&&p.Parser.configure&&p.Parser.configure(a);if(this.container.firstChild){forEach(this.container.childNodes,function(c){if(c.nodeType!=3)c.dirty=true});this.addDirtyNode(this.firstChild);
this.scheduleHighlight()}},keyDown:function(b){if(this.frozen=="leave")this.keyFilter=this.frozen=null;if(this.frozen&&(!this.keyFilter||this.keyFilter(b.keyCode,b))){b.stop();this.frozen(b)}else{var a=b.keyCode;this.delayScanning();this.options.autoMatchParens&&this.scheduleParenHighlight();if(a==13){if(b.ctrlKey&&!b.altKey)this.reparseBuffer();else{select.insertNewlineAtCursor();a=this.options.enterMode;if(a!="flat")this.indentAtCursor(a=="keep"?"keep":undefined);select.scrollToCursor(this.container)}b.stop()}else if(a==
9&&this.options.tabMode!="default"&&!b.ctrlKey){this.handleTab(!b.shiftKey);b.stop()}else if(a==32&&b.shiftKey&&this.options.tabMode=="default"){this.handleTab(true);b.stop()}else if(a==36&&!b.shiftKey&&!b.ctrlKey)this.home()&&b.stop();else if(a==35&&!b.shiftKey&&!b.ctrlKey)this.end()&&b.stop();else if(a==33&&!b.shiftKey&&!b.ctrlKey&&!gecko)this.pageUp()&&b.stop();else if(a==34&&!b.shiftKey&&!b.ctrlKey&&!gecko)this.pageDown()&&b.stop();else if((a==219||a==221)&&b.ctrlKey&&!b.altKey){this.highlightParens(b.shiftKey,
true);b.stop()}else if(b.metaKey&&!b.shiftKey&&(a==37||a==39)){var c=select.selectionTopNode(this.container);if(!(c===false||!this.container.firstChild)){if(a==37)select.focusAfterNode(l(c),this.container);else{a=n(c,this.container);select.focusAfterNode(a?a.previousSibling:this.container.lastChild,this.container)}b.stop()}}else if((b.ctrlKey||b.metaKey)&&!b.altKey)if(b.shiftKey&&a==90||a==89){select.scrollToNode(this.history.redo());b.stop()}else if(a==90||safari&&a==8){select.scrollToNode(this.history.undo());
b.stop()}else if(a==83&&this.options.saveFunction){this.options.saveFunction();b.stop()}else a==86&&!mac&&this.reroutePasteEvent()}},keyPress:function(b){var a=this.options.electricChars&&p.Parser.electricChars,c=this;if(this.frozen&&(!this.keyFilter||this.keyFilter(b.keyCode||b.code,b))||b.code==13||b.code==9&&this.options.tabMode!="default"||b.code==32&&b.shiftKey&&this.options.tabMode=="default")b.stop();else if(mac&&(b.ctrlKey||b.metaKey)&&b.character=="v")this.reroutePasteEvent();else if(a&&
a.indexOf(b.character)!=-1)this.parent.setTimeout(function(){c.indentAtCursor(null)},0);else if(brokenOpera)if(b.code==8){var d=select.selectionTopNode(this.container);c=this;var e=d?d.nextSibling:this.container.firstChild;d!==false&&e&&isBR(e)&&this.parent.setTimeout(function(){select.selectionTopNode(c.container)==e&&select.focusAfterNode(e.previousSibling,c.container)},20)}else{if(b.code==46){d=select.selectionTopNode(this.container);c=this;d&&isBR(d)&&this.parent.setTimeout(function(){select.selectionTopNode(c.container)!=
d&&select.focusAfterNode(d,c.container)},20)}}else if(slowWebkit){e=(d=select.selectionTopNode(this.container))?d.nextSibling:this.container.firstChild;if(d&&e&&isBR(e)&&!isBR(d)){var f=document.createTextNode("\u200b");this.container.insertBefore(f,e);this.parent.setTimeout(function(){if(f.nodeValue=="\u200b")removeElement(f);else f.nodeValue=f.nodeValue.replace("\u200b","")},20)}}webkit&&!this.options.textWrapping&&setTimeout(function(){var i=select.selectionTopNode(c.container,true);i&&i.nodeType==
3&&i.previousSibling&&isBR(i.previousSibling)&&i.nextSibling&&isBR(i.nextSibling)&&i.parentNode.replaceChild(document.createElement("BR"),i.previousSibling)},50)},keyUp:function(b){this.cursorActivity(b.keyCode>=16&&b.keyCode<=18||b.keyCode>=33&&b.keyCode<=40)},indentLineAfter:function(b,a){function c(s){s=s?s.nextSibling:d.container.firstChild;if(!s||!hasClass(s,"whitespace"))return null;return s}var d=this,e=c(b),f=0,i=e?e.currentText.length:0,k=e?e.nextSibling:b?b.nextSibling:this.container.firstChild;
if(a=="keep"){if(b){var q=c(l(b.previousSibling));if(q)f=q.currentText.length}}else{q=b&&k&&k.currentText?k.currentText:"";if(a!=null&&this.options.tabMode=="shift")f=a?i+indentUnit:Math.max(0,i-indentUnit);else if(b)f=b.indentation(q,i,a);else if(p.Parser.firstIndentation)f=p.Parser.firstIndentation(q,i,a)}i=f-i;if(i<0)if(f==0){if(k)select.snapshotMove(e.firstChild,k.firstChild||k,0);removeElement(e);e=null}else{select.snapshotMove(e.firstChild,e.firstChild,i,true);e.currentText=makeWhiteSpace(f);
e.firstChild.nodeValue=e.currentText}else if(i>0)if(e){e.currentText=makeWhiteSpace(f);e.firstChild.nodeValue=e.currentText;select.snapshotMove(e.firstChild,e.firstChild,i,true)}else{e=makePartSpan(makeWhiteSpace(f));e.className="whitespace";b?insertAfter(e,b):this.container.insertBefore(e,this.container.firstChild);select.snapshotMove(k&&(k.firstChild||k),e.firstChild,f,false,true)}else e&&select.snapshotMove(e.firstChild,e.firstChild,f,false);i!=0&&this.addDirtyNode(b)},highlightAtCursor:function(){var b=
select.selectionTopNode(this.container,true),a=select.selectionTopNode(this.container,false);if(b===false||a===false)return false;select.markSelection();if(this.highlight(b,n(a,this.container),true,20)===false)return false;select.selectMarked();return true},handleTab:function(b){this.options.tabMode=="spaces"?select.insertTabAtCursor():this.reindentSelection(b)},home:function(){var b=select.selectionTopNode(this.container,true),a=b;if(b===false||!(!b||b.isPart||isBR(b))||!this.container.firstChild)return false;
for(;b&&!isBR(b);)b=b.previousSibling;var c=b?b.nextSibling:this.container.firstChild;c&&c!=a&&c.isPart&&hasClass(c,"whitespace")?select.focusAfterNode(c,this.container):select.focusAfterNode(b,this.container);select.scrollToCursor(this.container);return true},end:function(){var b=select.selectionTopNode(this.container,true);if(b===false)return false;b=n(b,this.container);if(!b)return false;select.focusAfterNode(b.previousSibling,this.container);select.scrollToCursor(this.container);return true},
pageUp:function(){var b=this.cursorPosition().line,a=this.visibleLineCount();if(b===false||a===false)return false;a-=2;for(var c=0;c<a;c++){b=this.prevLine(b);if(b===false)break}if(c==0)return false;select.setCursorPos(this.container,{node:b,offset:0});select.scrollToCursor(this.container);return true},pageDown:function(){var b=this.cursorPosition().line,a=this.visibleLineCount();if(b===false||a===false)return false;a-=2;for(var c=0;c<a;c++){var d=this.nextLine(b);if(d===false)break;b=d}if(c==0)return false;
select.setCursorPos(this.container,{node:b,offset:0});select.scrollToCursor(this.container);return true},scheduleParenHighlight:function(){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);var b=this;this.parenEvent=this.parent.setTimeout(function(){b.highlightParens()},300)},highlightParens:function(b,a){function c(w,z){if(w)if(i.options.markParen)i.options.markParen(w,z);else{w.style.fontWeight="bold";w.style.color=z?"#8F8":"#F88"}}function d(w){if(w)if(i.options.unmarkParen)i.options.unmarkParen(w);
else{w.style.fontWeight="";w.style.color=""}}function e(w){if(w.currentText)return(w=w.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/))&&w[1]}function f(){for(var w=[],z,A=true,u=q;u;u=t?u.nextSibling:u.previousSibling)if(u.className==s&&isSpan(u)&&(z=e(u))){if(/[\(\[\{]/.test(z)==t)w.push(z);else if(w.length){if(w.pop()!=matching[z])A=false}else A=false;if(!w.length)break}else if(u.dirty||!isSpan(u)&&!isBR(u))return{node:u,status:"dirty"};return{node:u,status:u&&A}}var i=this;if(!a&&
i.highlighted){d(i.highlighted[0]);d(i.highlighted[1])}if(window.parent&&window.select){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);this.parenEvent=null;var k,q=select.selectionTopNode(this.container,true);if(q&&this.highlightAtCursor())if((q=select.selectionTopNode(this.container,true))&&((k=e(q))||(q=q.nextSibling)&&(k=e(q))))for(var s=q.className,t=/[\(\[\{]/.test(k);;){var v=f();if(v.status=="dirty"){this.highlight(v.node,n(v.node));v.node.dirty=false}else{c(q,v.status);c(v.node,
v.status);if(a)i.parent.setTimeout(function(){d(q);d(v.node)},500);else i.highlighted=[q,v.node];b&&v.node&&select.focusAfterNode(v.node.previousSibling,this.container);break}}}},indentAtCursor:function(b){if(this.container.firstChild)if(this.highlightAtCursor()){var a=select.selectionTopNode(this.container,false);if(a!==false){select.markSelection();this.indentLineAfter(l(a),b);select.selectMarked()}}},indentRegion:function(b,a,c){var d=b=l(b),e=b&&l(b.previousSibling);isBR(a)||(a=n(a,this.container));
this.addDirtyNode(b);do{var f=n(d,this.container);d&&this.highlight(e,f,true);this.indentLineAfter(d,c);e=d;d=f}while(d!=a);select.setCursorPos(this.container,{node:b,offset:0},{node:a,offset:0})},cursorActivity:function(b){if(this.unloaded){window.document.designMode="off";window.document.designMode="on";this.unloaded=false}if(internetExplorer){this.container.createTextRange().execCommand("unlink");clearTimeout(this.saveSelectionSnapshot);var a=this;this.saveSelectionSnapshot=setTimeout(function(){var e=
select.getBookmark(a.container);if(e)a.selectionSnapshot=e},200)}var c=this.options.cursorActivity;if(!b||c){var d=select.selectionTopNode(this.container,false);if(!(d===false||!this.container.firstChild)){d=d||this.container.firstChild;c&&c(d);if(!b){this.scheduleHighlight();this.addDirtyNode(d)}}}},reparseBuffer:function(){forEach(this.container.childNodes,function(b){b.dirty=true});this.container.firstChild&&this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(b){if(b=b||this.container.firstChild){for(var a=
0;a<this.dirty.length;a++)if(this.dirty[a]==b)return;if(b.nodeType!=3)b.dirty=true;this.dirty.push(b)}},allClean:function(){return!this.dirty.length},scheduleHighlight:function(){var b=this;this.parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=this.parent.setTimeout(function(){b.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){for(;this.dirty.length>0;){var b=this.dirty.pop();try{for(;b&&b.parentNode!=this.container;)b=b.parentNode;if(b&&(b.dirty||b.nodeType==3))return b}catch(a){}}return null},
highlightDirty:function(b){if(!window.parent||!window.select)return false;this.options.readOnly||select.markSelection();for(var a,c=b?null:(new Date).getTime()+this.options.passTime;((new Date).getTime()<c||b)&&(a=this.getDirtyNode());){var d=this.highlight(a,c);d&&d.node&&d.dirty&&this.addDirtyNode(d.node.nextSibling)}this.options.readOnly||select.selectMarked();a&&this.scheduleHighlight();return this.dirty.length==0},documentScanner:function(b){var a=this,c=null;return function(){if(window.parent&&
window.select){if(c&&c.parentNode!=a.container)c=null;select.markSelection();var d=a.highlight(c,(new Date).getTime()+b,true);select.selectMarked();d=d?d.node&&d.node.nextSibling:null;c=c==d?null:d;a.delayScanning()}}},delayScanning:function(){if(this.scanner){this.parent.clearTimeout(this.documentScan);this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(b,a,c,d){function e(u){if(u){var x=u.oldNextSibling;if(w||x===undefined||u.nextSibling!=
x)i.history.touch(u);u.oldNextSibling=u.nextSibling}else{x=i.container.oldFirstChild;if(w||x===undefined||i.container.firstChild!=x)i.history.touch(null);i.container.oldFirstChild=i.container.firstChild}}var f=this.container,i=this,k=this.options.activeTokens,q=typeof a=="number"?a:null;if(!f.firstChild)return false;for(;b&&(!b.parserFromHere||b.dirty);){if(d!=null&&isBR(b)&&--d<0)return false;b=b.previousSibling}if(b&&!b.nextSibling)return false;var s=j(b?b.nextSibling:f.firstChild);d=stringStream(s);
var t=b?b.parserFromHere(d):p.Parser.make(d),v={current:null,get:function(){if(!this.current)this.current=s.nodes.shift();return this.current},next:function(){this.current=null},remove:function(){f.removeChild(this.get());this.current=null},getNonEmpty:function(){for(var u=this.get();u&&isSpan(u)&&u.currentText=="";)if(window.opera&&(u.previousSibling==null||isBR(u.previousSibling))&&(u.nextSibling==null||isBR(u.nextSibling))){this.next();u=this.get()}else{var x=u;this.remove();u=this.get();select.snapshotMove(x.firstChild,
u&&(u.firstChild||u),0)}return u}},w=false,z=true,A=0;forEach(t,function(u){var x=v.getNonEmpty();if(u.value=="\n"){if(!isBR(x))throw"Parser out of sync. Expected BR.";if(x.dirty||!x.indentation)w=true;e(b);b=x;x.parserFromHere=t.copy();x.indentation=u.indentation;x.dirty=false;if(q==null&&x==a)throw StopIteration;if(q!=null&&(new Date).getTime()>=q||!w&&!z&&A>1&&!c)throw StopIteration;z=w;w=false;A=0;v.next()}else{if(!isSpan(x))throw"Parser out of sync. Expected SPAN.";if(x.dirty)w=true;A++;if(!x.reduced&&
x.currentText==u.value&&x.className==u.style){x.dirty=false;v.next()}else{w=true;var F=makePartSpan(u.value);F.className=u.style;f.insertBefore(F,x);k&&k(F,u,i);u=u.value.length;for(var I=0;u>0;){x=v.get();var D=x.currentText.length;select.snapshotReplaceNode(x.firstChild,F.firstChild,u,I);if(D>u){x=x;x.currentText=x.currentText.substring(u);x.reduced=true;u=0}else{u-=D;I+=D;v.remove()}}}}});e(b);webkitLastLineHack(this.container);return{node:v.getNonEmpty(),dirty:w}}};return p}();
addEventHandler(window,"load",function(){var g=window.frameElement.CodeMirror;g.editor=new Editor(g.options);this.parent.setTimeout(method(g,"init"),0)});
function tokenizer(g,m){function j(n){return n!="\n"&&/^[\s\u00a0]*$/.test(n)}var l={state:m,take:function(n){if(typeof n=="string")n={style:n,type:n};n.content=(n.content||"")+g.get();/\n$/.test(n.content)||g.nextWhile(j);n.value=n.content+g.get();return n},next:function(){if(!g.more())throw StopIteration;var n;if(g.equals("\n")){g.next();return this.take("whitespace")}if(g.applies(j))n="whitespace";else for(;!n;)n=this.state(g,function(o){l.state=o});return this.take(n)}};return l}
var XMLParser=Editor.Parser=function(){var g={autoSelfClosers:{br:true,img:true,hr:true,link:true,input:true,meta:true,col:true,frame:true,base:true,area:true},doNotIndent:{pre:true,"!cdata":true}},m={autoSelfClosers:{},doNotIndent:{"!cdata":true}},j=g,l=false,n=function(){function o(a,c){var d=a.next();if(d=="<")if(a.equals("!")){a.next();if(a.equals("["))if(a.lookAhead("[CDATA[",true)){c(b("xml-cdata","]]\>"));return null}else return"xml-text";else if(a.lookAhead("--",true)){c(b("xml-comment","--\>"));
return null}else if(a.lookAhead("DOCTYPE",true)){a.nextWhileMatches(/[\w\._\-]/);c(b("xml-doctype",">"));return"xml-doctype"}else return"xml-text"}else if(a.equals("?")){a.next();a.nextWhileMatches(/[\w\._\-]/);c(b("xml-processing","?>"));return"xml-processing"}else{a.equals("/")&&a.next();c(p);return"xml-punctuation"}else if(d=="&"){for(;!a.endOfLine();)if(a.next()==";")break;return"xml-entity"}else{a.nextWhileMatches(/[^&<\n]/);return"xml-text"}}function p(a,c){var d=a.next();if(d==">"){c(o);return"xml-punctuation"}else if(/[?\/]/.test(d)&&
a.equals(">")){a.next();c(o);return"xml-punctuation"}else if(d=="=")return"xml-punctuation";else if(/[\'\"]/.test(d)){c(h(d));return null}else{a.nextWhileMatches(/[^\s\u00a0=<>\"\'\/?]/);return"xml-name"}}function h(a){return function(c,d){for(;!c.endOfLine();)if(c.next()==a){d(p);break}return"xml-attribute"}}function b(a,c){return function(d,e){for(;!d.endOfLine();){if(d.lookAhead(c,true)){e(o);break}d.next()}return a}}return function(a,c){return tokenizer(a,c||o)}}();return{make:function(o){function p(B){for(var C=
B.length-1;C>=0;C--)u.push(B[C])}function h(){p(arguments);M=true}function b(){p(arguments);M=false}function a(){A.style+=" xml-error"}function c(B){return function(C,G){if(G==B)h();else{a();h(arguments.callee)}}}function d(B,C){var G=j.doNotIndent.hasOwnProperty(B)||D&&D.noIndent;D={prev:D,name:B,indent:F,startOfLine:C,noIndent:G}}function e(B){return function(C,G){var E=B;if(E&&E.noIndent)return G;if(l&&/<!\[CDATA\[/.test(C))return 0;if(E&&/^<\//.test(C))E=E.prev;for(;E&&!E.startOfLine;)E=E.prev;
return E?E.indent+indentUnit:0}}function f(){return b(i,f)}function i(B,C){if(C=="<")h(k,t,s(x==1));else if(C=="</")h(q,c(">"));else{if(B=="xml-cdata"){if(!D||D.name!="!cdata")d("!cdata");if(/\]\]>$/.test(C))D=D.prev}else N.hasOwnProperty(B)||a();h()}}function k(B,C){if(B=="xml-name"){I=C.toLowerCase();A.style="xml-tagname";h()}else{I=null;b()}}function q(B,C){if(B=="xml-name"){A.style="xml-tagname";if(D&&C.toLowerCase()==D.name)D=D.prev;else a()}h()}function s(B){return function(C,G){if(G=="/>"||
G==">"&&j.autoSelfClosers.hasOwnProperty(I))h();else if(G==">"){d(I,B);h()}else{a();h(arguments.callee)}}}function t(B){if(B=="xml-name"){A.style="xml-attname";h(v,t)}else b()}function v(B,C){if(C=="=")h(w);else C==">"||C=="/>"?b(s):b()}function w(B){B=="xml-attribute"?h(w):b()}var z=n(o),A,u=[f],x=0,F=0,I=null,D=null,M,N={"xml-text":true,"xml-entity":true,"xml-comment":true,"xml-processing":true,"xml-doctype":true};return{indentation:function(){return F},next:function(){A=z.next();if(A.style=="whitespace"&&
x==0)F=A.value.length;else x++;if(A.content=="\n"){F=x=0;A.indentation=e(D)}if(A.style=="whitespace"||A.type=="xml-comment")return A;for(;;){M=false;u.pop()(A.style,A.content);if(M)return A}},copy:function(){var B=u.concat([]),C=z.state,G=D,E=this;return function(J){u=B.concat([]);x=F=0;D=G;z=n(J,C);return E}}}},electricChars:"/",configure:function(o){if(o.useHTMLKludges!=null)j=o.useHTMLKludges?g:m;if(o.alignCDATA)l=o.alignCDATA}}}(),CSSParser=Editor.Parser=function(){function g(j,l,n){return function(o){return!j||
/^\}/.test(o)?n:l?n+indentUnit*2:n+indentUnit}}var m=function(){function j(p,h){var b=p.next();if(b=="@"){p.nextWhileMatches(/\w/);return"css-at"}else if(b=="/"&&p.equals("*")){h(l);return null}else if(b=="<"&&p.equals("!")){h(n);return null}else if(b=="=")return"css-compare";else if(p.equals("=")&&(b=="~"||b=="|")){p.next();return"css-compare"}else if(b=='"'||b=="'"){h(o(b));return null}else if(b=="#"){p.nextWhileMatches(/\w/);return"css-hash"}else if(b=="!"){p.nextWhileMatches(/[ \t]/);p.nextWhileMatches(/\w/);
return"css-important"}else if(/\d/.test(b)){p.nextWhileMatches(/[\w.%]/);return"css-unit"}else if(/[,.+>*\/]/.test(b))return"css-select-op";else if(/[;{}:\[\]]/.test(b))return"css-punctuation";else{p.nextWhileMatches(/[\w\\\-_]/);return"css-identifier"}}function l(p,h){for(var b=false;!p.endOfLine();){var a=p.next();if(b&&a=="/"){h(j);break}b=a=="*"}return"css-comment"}function n(p,h){for(var b=0;!p.endOfLine();){var a=p.next();if(b>=2&&a==">"){h(j);break}b=a=="-"?b+1:0}return"css-comment"}function o(p){return function(h,
b){for(var a=false;!h.endOfLine();){var c=h.next();if(c==p&&!a)break;a=!a&&c=="\\"}a||b(j);return"css-string"}}return function(p,h){return tokenizer(p,h||j)}}();return{make:function(j,l){l=l||0;var n=m(j),o=false,p=false,h=false,b={next:function(){var a=n.next(),c=a.style,d=a.content;if(c=="css-hash")c=a.style=p?"css-colorcode":"css-identifier";if(c=="css-identifier")if(p)a.style="css-value";else if(!o&&!h)a.style="css-selector";if(d=="\n")a.indentation=g(o,p,l);if(d=="{"&&h=="@media")h=false;else if(d==
"{")o=true;else if(d=="}")o=p=h=false;else if(d==";")p=h=false;else if(o&&c!="css-comment"&&c!="whitespace")p=true;else if(!o&&c=="css-at")h=d;return a},copy:function(){var a=o,c=p,d=n.state;return function(e){n=m(e,d);o=a;p=c;return b}}};return b},electricChars:"}"}}(),tokenizeJavaScript=function(){function g(h,b){for(var a=false;!h.endOfLine();){var c=h.next();if(c==b&&!a)return false;a=!a&&c=="\\"}return a}function m(h,b){return function(a,c){var d=h,e=j(h,b,a,function(i){d=i}),f=e.type=="operator"||
e.type=="keyword c"||e.type.match(/^[\[{}\(,;:]$/);if(f!=b||d!=h)c(m(d,f));return e}}function j(h,b,a,c){function d(){a.nextWhileMatches(p);var q=a.get(),s=l.hasOwnProperty(q)&&l.propertyIsEnumerable(q)&&l[q];return s?{type:s.type,style:s.style,content:q}:{type:"variable",style:"js-variable",content:q}}function e(q){var s="/*";for(q=q=="*";;){if(a.endOfLine())break;var t=a.next();if(t=="/"&&q){s=null;break}q=t=="*"}c(s);return{type:"comment",style:"js-comment"}}function f(){a.nextWhileMatches(n);
return{type:"operator",style:"js-operator"}}function i(q){var s=g(a,q);c(s?q:null);return{type:"string",style:"js-string"}}if(h=='"'||h=="'")return i(h);var k=a.next();if(h=="/*")return e(k);else if(k=='"'||k=="'")return i(k);else if(/[\[\]{}\(\),;\:\.]/.test(k))return{type:k,style:"js-punctuation"};else if(k=="0"&&(a.equals("x")||a.equals("X"))){a.next();a.nextWhileMatches(o);return{type:"number",style:"js-atom"}}else if(/[0-9]/.test(k)){a.nextWhileMatches(/[0-9]/);if(a.equals(".")){a.next();a.nextWhileMatches(/[0-9]/)}if(a.equals("e")||
a.equals("E")){a.next();a.equals("-")&&a.next();a.nextWhileMatches(/[0-9]/)}return{type:"number",style:"js-atom"}}else if(k=="/")if(a.equals("*")){a.next();return e(k)}else if(a.equals("/")){g(a,null);return{type:"comment",style:"js-comment"}}else{if(b){g(a,"/");a.nextWhileMatches(/[gi]/);h={type:"regexp",style:"js-string"}}else h=f();return h}else return n.test(k)?f():d()}var l=function(){function h(f,i){return{type:f,style:"js-"+i}}var b=h("keyword a","keyword"),a=h("keyword b","keyword"),c=h("keyword c",
"keyword"),d=h("operator","keyword"),e=h("atom","atom");return{"if":b,"while":b,"with":b,"else":a,"do":a,"try":a,"finally":a,"return":c,"break":c,"continue":c,"new":c,"delete":c,"throw":c,"in":d,"typeof":d,"instanceof":d,"var":h("var","keyword"),"function":h("function","keyword"),"catch":h("catch","keyword"),"for":h("for","keyword"),"switch":h("switch","keyword"),"case":h("case","keyword"),"default":h("default","keyword"),"true":e,"false":e,"null":e,undefined:e,NaN:e,Infinity:e}}(),n=/[+\-*&%=<>!?|]/,
o=/[0-9A-Fa-f]/,p=/[\w\$_]/;return function(h,b){return tokenizer(h,b||m(false,true))}}(),JSParser=Editor.Parser=function(){function g(n,o,p,h,b,a){this.indented=n;this.column=o;this.type=p;if(h!=null)this.align=h;this.prev=b;this.info=a}function m(n){return function(o){var p=o&&o.charAt(0),h=n.type,b=p==h;return h=="vardef"?n.indented+4:h=="form"&&p=="{"?n.indented:h=="stat"||h=="form"?n.indented+indentUnit:n.info=="switch"&&!b?n.indented+(/^(?:case|default)\b/.test(o)?indentUnit:2*indentUnit):n.align?
n.column-(b?1:0):n.indented+(b?0:indentUnit)}}var j={atom:true,number:true,variable:true,string:true,regexp:true},l=false;return{make:function(n,o){function p(r){for(var y=r.length-1;y>=0;y--)J.push(r[y])}function h(){p(arguments);S=true}function b(){p(arguments);S=false}function a(){K={prev:K,vars:{"this":true,arguments:true}}}function c(){K=K.prev}function d(r){if(K){O="js-variabledef";K.vars[r]=true}}function e(r,y){var L=function(){H=new g(Q,R,r,null,H,y)};L.lex=true;return L}function f(){if(H.type==
")")Q=H.indented;H=H.prev}function i(r){return function(y){if(y==r)h();else r==";"?b():h(arguments.callee)}}function k(){return b(s,k)}function q(){return b(t,q)}function s(r){if(r=="var")h(e("vardef"),F,i(";"),f);else if(r=="keyword a")h(e("form"),t,s,f);else if(r=="keyword b")h(e("form"),s,f);else if(r=="{")h(e("}"),x,f);else if(r==";")h();else if(r=="function")h(C);else if(r=="for")h(e("form"),i("("),e(")"),D,i(")"),f,s,f);else if(r=="variable")h(e("stat"),w);else if(r=="switch")h(e("form"),t,
e("}","switch"),i("{"),x,f,f);else if(r=="case")h(t,i(":"));else if(r=="default")h(i(":"));else r=="catch"?h(e("form"),a,i("("),G,i(")"),s,f,c):b(e("stat"),t,i(";"),f)}function t(r){if(j.hasOwnProperty(r))h(v);else if(r=="function")h(C);else if(r=="keyword c")h(t);else if(r=="(")h(e(")"),t,i(")"),f,v);else if(r=="operator")h(t);else if(r=="[")h(e("]"),u(t,"]"),f,v);else r=="{"?h(e("}"),u(A,"}"),f,v):h()}function v(r,y){if(r=="operator"&&/\+\+|--/.test(y))h(v);else if(r=="operator")h(t);else if(r==
";")b();else if(r=="(")h(e(")"),u(t,")"),f,v);else if(r==".")h(z,v);else r=="["&&h(e("]"),t,i("]"),f,v)}function w(r){r==":"?h(f,s):b(v,i(";"),f)}function z(r){if(r=="variable"){O="js-property";h()}}function A(r){if(r=="variable")O="js-property";j.hasOwnProperty(r)&&h(i(":"),t)}function u(r,y){function L(P){if(P==",")h(r,L);else P==y?h():h(i(y))}return function(P){P==y?h():b(r,L)}}function x(r){r=="}"?h():b(s,x)}function F(r,y){if(r=="variable"){d(y);h(I)}else h()}function I(r,y){if(y=="=")h(t,I);
else r==","&&h(F)}function D(r){if(r=="var")h(F,N);else if(r==";")b(N);else r=="variable"?h(M):b(N)}function M(r,y){y=="in"?h(t):h(v,N)}function N(r,y){if(r==";")h(B);else y=="in"?h(t):h(t,i(";"),B)}function B(r){r==")"?b():h(t)}function C(r,y){if(r=="variable"){d(y);h(C)}else r=="("&&h(a,u(G,")"),s,c)}function G(r,y){if(r=="variable"){d(y);h()}}var E=tokenizeJavaScript(n),J=[l?q:k],K=null,H=new g((o||0)-indentUnit,0,"block",false),R=0,Q=0,S,O,T={next:function(){for(;J[J.length-1].lex;)J.pop()();
var r=E.next();if(r.type=="whitespace"&&R==0)Q=r.value.length;R+=r.value.length;if(r.content=="\n"){Q=R=0;if(!("align"in H))H.align=false;r.indentation=m(H)}if(r.type=="whitespace"||r.type=="comment")return r;if(!("align"in H))H.align=true;for(;;){S=O=false;J.pop()(r.type,r.content);if(S){if(O)r.style=O;else{var y;if(y=r.type=="variable")a:{for(y=K;y;){if(y.vars[r.content]){y=true;break a}y=y.prev}y=false}if(y)r.style="js-localvariable"}return r}}},copy:function(){var r=K,y=H,L=J.concat([]),P=E.state;
return function(U){K=r;H=y;J=L.concat([]);R=Q=0;E=tokenizeJavaScript(U,P);return T}}};f.lex=true;return T},electricChars:"{}:",configure:function(n){if(n.json!=null)l=n.json}}}(),HTMLMixedParser=Editor.Parser=function(){function g(){var j=["XMLParser"];for(var l in m)j.push(m[l]);for(var n in j)if(!window[j[n]])throw new Error(j[n]+" parser must be loaded for HTML mixed mode to work.");XMLParser.configure({useHTMLKludges:true})}var m={script:"JSParser",style:"CSSParser"};return{make:function(j){function l(){var a=
o.next();if(a.content=="<")h=true;else if(a.style=="xml-tagname"&&h===true)h=a.content.toLowerCase();else if(a.content==">"){if(m[h])b.next=n(window[m[h]],"</"+h);h=false}return a}function n(a,c){var d=o.indentation();p=a.make(j,d+indentUnit);return function(){if(j.lookAhead(c,false,false,true)){p=null;b.next=l;return l()}var e=p.next(),f=e.value.lastIndexOf("<"),i=Math.min(e.value.length-f,c.length);if(f!=-1&&e.value.slice(f,f+i).toLowerCase()==c.slice(0,i)&&j.lookAhead(c.slice(i),false,false,true)){j.push(e.value.slice(f));
e.value=e.value.slice(0,f)}if(e.indentation){var k=e.indentation;e.indentation=function(q){return q=="</"?d:k(q)}}return e}}g();var o=XMLParser.make(j),p=null,h=false,b={next:l,copy:function(){var a=o.copy(),c=p&&p.copy(),d=b.next,e=h;return function(f){j=f;o=a(f);p=c&&c(f);b.next=d;h=e;return b}}};return b},electricChars:"{}/:",configure:function(j){if(j.triggers)m=j.triggers}}}(),DummyParser=Editor.Parser=function(){function g(m){for(;!m.endOfLine();)m.next();return"text"}return{make:function(m){function j(o){return function(){return o}}
m=tokenizer(m,g);var l=0,n={next:function(){var o=m.next();if(o.type=="whitespace")if(o.value=="\n")o.indentation=j(l);else l=o.value.length;return o},copy:function(){var o=l;return function(p){l=o;m=tokenizer(p,g);return n}}};return n}}}();
