<acre:script>
	var mf = acre.require("MANIFEST").mf;
  var h = mf.require("core", "helpers");
	var i18n = mf.require("i18n", "i18n");
</acre:script>

<!-- called by ui.init -->
<div mjt.def="body()">
  <div id="message-panel"></div>
  <div id="about-bar"></div>
  <div id="columns">
    <div id="list-column"  class="refresh column"></div>
    <div id="file-margin"  class="refresh column"></div>
    <div id="file-column"  class="column row">
      <div id="button-bar" class="refresh"></div>
      <div id="file-area"  class="refresh"></div>
    </div>
  </div>
  <span mjt.script="ondomready">
    var flw = parseInt(ui.get_editor_prefs('flw'));
    
    $$(window).resize(function(){
      $$('#list-column').width(flw);
      $$('#file-margin').css('left', flw);
      $$('#file-column').css('left', flw + $$('#file-margin').width());
      
      var fixer = $$('#fixer');
      var fixerOffset = fixer.offset();
      var filecolumn_offset = $$('#file-column').offset();
      var filecolumn_height = 
          Math.max(fixerOffset.top + fixer[0].offsetHeight, $$(window).height()) - 
          Math.max(filecolumn_offset.top, $$('#header').height()+1);
      var filecolumn_width  = 
          Math.max(fixerOffset.left + fixer[0].offsetWidth, $$(window).width()) - 
          filecolumn_offset.left;
      var filearea_offset = $$('#file-area').offset();
      var filearea_height = 
          Math.max(fixerOffset.top + fixer[0].offsetHeight, $$(window).height()) - 
          filearea_offset.top;
          
      $$('.row').width( filecolumn_width );
      $$('.column').height( filecolumn_height - 1 );
      $$('#file-area').height( filearea_height - 1 );
      $$('#file-list').height( filearea_height - $$('#app-search').height() - $$('#app-edits').height() );
      $$('.refresh-right').show();
      if (ui.dialog) {
        ui.dialog.css('left', ($$(window).width() - ui.dialog.outerWidth())/2);
      }
    });
    
    $$('#file-margin').draggable({ 
      axis: 'x',
      iframeFix: true,
      containment: [125,,400,],
      drag : function(event, jqui) {
        flw = $$('#file-margin').offset().left;
        $$(window).trigger('resize');            
      },
      stop : function(event, jqui) {
        flw = $$('#file-margin').offset().left;
        ui.set_editor_prefs({flw: flw});
        $$(window).trigger('resize');            
      }
    });
    
    $$('#file-area').click(ui.do_click_error);
  </span>
</div>

<!-- called by ui.refresh_app_templates -->    
<div mjt.def="header(state)" mjt.strip="1">
  <span mjt.script="">
  	var store = ui.get_store();
	  var user = ui.get_user();
	  var app = ui.get_app();
  </span>
  <p mjt.if="state == 'open'">
    <span class="app-name">Acre App Editor</span>
  </p>
  <p mjt.elif="state == 'loading'"><span class="app-name">Loading...</span></p>
  <div mjt.else="" id="button-appsettings" class="app-name" mjt.onclick="ui.do_show_menu('appsettings')">
    <p><span class="button-menu">$${app.get_display_name()}</span></p>
  </div>
</div>

<!-- called by ui.refresh_app_templates -->
<div mjt.def="about_bar()">
  <span mjt.script="">
    var app       = ui.get_app();
    var is_author = app.is_author();
    var is_remote = app.is_remote();
    var user      = ui.get_user();
    var versions  = app.get_versions();
    var release   = app.get_released_version();
    var version   = app.get_version_label();

    var path      = app.get_path();
    var vpath     = app.get_versioned_path(); 
    var ppath     = release ? path.replace("//", "//release.") : null;
    var num       = versions.length;
    if (ppath &amp;&amp; ppath != vpath) { num -= 1; }
  </span>
  <div id="about-bar-left" class="column left">
      <span mjt.if="version">
        Version $$version
      </span>
      <span mjt.else="">
        <span mjt.script="">version = "Current";</span>
        Current 
      </span>
  </div>
  <div id="about-bar-margin" class="column margin"> </div>
  <div id="about-bar-middle" class="column row">
    <div mjt.if="is_remote">
      <h2><em>This app is hosted on $${app.get_acre_host()}</em></h2>
    </div>
    <div mjt.elif="is_author">
      <button id="button-trunk" class="button-primary" mjt.onclick="ui.do_choose_app(ui.get_app().get_path())">
        Edit Current</button>
      or
      <button id="button-clone" mjt.onclick="ui.do_show_dialog('new_app', [true])">
        Clone this App</button>      
    </div>
    <div mjt.else="">
      <button id="button-clone" class="button-primary" mjt.attrs="user?{}:{'disabled':'disabled'}" mjt.onclick="ui.do_show_dialog('new_app', [true])" >
        Clone this App</button> 
        <span mjt.if="!user">
          <a href="$${$$('#nav-signin').attr('href')}" title="Sign in to your Freebase account">Sign in</a>
        </span> 
        to make an app based on this one!
    </div>
    <div id="about-bar-right" class="refresh-right">
      <span mjt.if="versions.length"><b>
        Versions:
        <a mjt.if="ppath &amp;&amp; ppath != vpath" class="app-link" apppath="$$ppath" href="$${ui.get_appeditor_url(ppath)}">Release</a>
        <a mjt.if="version &amp;&amp; version != 'Current'" class="app-link" apppath="$$path" href="$${ui.get_appeditor_url(path)}">Current</a>
        <a mjt.if="num > 0" href="#0" mjt.onclick="return ui.do_show_menu('appsettings',['general'])">more...</a>
      </b></span>
    </div>
  </div>
</div>

<div mjt.def="list_column()">
  <button id="button-new-file" mjt.if="ui.get_app().is_writable()" mjt.onclick="ui.do_show_dialog('add_file')">
    New File</button>
  <h1>Files</h1>
  
  <div id="file-list"></div>
  <div id="app-edits-shim">
    $${app_edits()}
  </div>
  
  <div id="app-search">
    <form id="codesearch-form" action="http://codesearch.$${ui.get_app().get_acre_host()}/" target="_blank">
      <div class="file-list-section-title">Find code in app:</div>
      <input id='codesearch-app' type='hidden' name="app" value='$${ui.get_app().get_path()}' />
      <input type="text" name="q" value=""/>
    </form>
  </div>
</div>
  <div mjt.def="app_edits()">
    <span mjt.script="">
      var recent = false;
      var change = ui.get_app().get_last_change();
      if (change) {
        var delta = + new Date() - mjt.freebase.date_from_iso(change.timestamp);
        if (delta &lt; 3600000) { recent = true; }
      }
    </span>
    <div mjt.if="recent" id="app-edits">
      <div class="content">
        <span class="file-list-section-title">Active Author: </span>
        <span class="change">
          $$change.attribution.name edited '$${mjt.freebase.mqlkey_unquote(change.file)}' $${ui.get_relative_timestamp(change.timestamp)}
        </span>
      </div>
    </div>
  </div>

<!-- called by ui.refresh_file_templates -->  
<div mjt.def="file_list()">
  <div mjt.def="filelist_section(section_key, section_name, app, filenames, link)">
    <ul section="$$section_key">
      <li mjt.if="filenames" class="file-list-section-header">
        <span class="file-list-section-toggle" section="$$section_key" mjt.if="ui.get_editor_prefs('t_'+section_key)">&#9660;</span>
        <span class="file-list-section-toggle" section="$$section_key" mjt.else="">&#9658;</span>
        <a mjt.if="link" class="file-list-section-title app-link" 
          apppath="$${app.get_path()}" href="$${ui.get_appeditor_url(app.get_path())}">$$section_name</a>
        <span mjt.else="" class="file-list-section-title">$$section_name</span>
      </li>
      <li mjt.if="filenames" mjt.for="filename in filenames" 
          mjt.attrs="{'class': make_file_classes(app.get_file(filename), section_key), 'fname' : app.get_file(filename).get_relative_path()}" >
          <div class="file-delete" mjt.attrs="app.is_writable() ? {'class':'file-delete'} : {'class':'file-nodelete'}" mjt.onclick="ui.do_show_dialog('delete_file', [filename])"></div>
          <a href="$${ui.get_appeditor_url(app.get_file(filename))}">$$filename</a>
      </li>
    </ul>
 </div>
  <span mjt.script="">
    var app = ui.get_app();
    var ordered_filenames = ui.order_section_files(app);
    
    function make_file_classes(file, section) {
      var classes = 'file-list-item';
      var current_filepath =  ui.get_file() ? ui.get_file().get_relative_path() : null;
      if (file.get_relative_path() == current_filepath) { classes += ' selected-file'; }
      if (file.is_dirty("to_delete"))                   { classes += ' deleted-file'; }
      if (file.is_dirty())                              { classes += ' edited-file'; }
      if (!ui.get_editor_prefs("t_" + section)) { classes += ' hidden-file'; }
      return classes;
    }
  </span>

  <div mjt.for="handler_key, handler in ui.get_store().get_acre_handlers()" >
    $${filelist_section( handler_key, handler.plural_name, app, ordered_filenames[handler_key])}
  </div>
  <div mjt.if="ordered_filenames['test'] &amp;&amp; ordered_filenames['test'].length">
    $${filelist_section("test", "Tests", app, ordered_filenames["test"])}
  </div>
  
  <span mjt.script="ondomready">            
    $$('.file-list-section-toggle').click(function(e){
      var section = $$(this).attr("section");
      if ($$(this).text() == "&#9660;") {
        $$(this).text("&#9658;");
        ui.set_editor_prefs("t_"+section, false);
        $$("ul[section='"+section+"'] .file-list-item").addClass('hidden-file');
      } else {
        $$(this).text("&#9660;");
        ui.set_editor_prefs("t_"+section, true);
        $$("ul[section='"+section+"'] .file-list-item").removeClass('hidden-file');
      }
    });
    
    $$('#file-list .file-list-item').click(function(e){
      if (e.ctrlKey || e.metaKey || e.altKey || e.shiftKey) {
        /* default browser behaviour = open link in new tab */
      } else {
        var new_name = $$(this).attr("fname");
        ui.do_choose_file(new_name);
        return false;
      }
    });
  </span>
</div>

<!-- called by ui.refresh_file_templates -->  
<div mjt.def="button_bar()">
  <span mjt.script="">
    var app = ui.get_app();
    var file = ui.get_file();
    var writable = app ? app.is_writable() : false;
    
    var opts = file ? file.get_editor_supported_features() : false;
    var show_opts = opts.margin || opts.softwrap || opts.hotswap || opts.emql;
    
    var fileactions_open = $$('#button-fileactions').hasClass('button-open');
    var editoroptions_open = $$('#button-editoroptions').hasClass('button-open');
  </span>
    <div id="file-buttons">
      <div mjt.if="file">
      <div id="file-buttons-right" class="refresh-right">
        <button id="button-view" mjt.onclick="ui.do_run_view(null, false);" title="$${mjt.bless(ui.shortcut.get_keys('View'))}"
          mjt.attrs="file.get_editor_supported_features('inline_preview')?{'disabled':'disabled'}:{}">
          View</button>
        <button id="button-preview" class="button-primary" mjt.onclick="ui.do_run_view(null, true);"  title="$${mjt.bless(ui.shortcut.get_keys('View with Console'))}"
          mjt.attrs="file.get_editor_supported_features('inline_preview')?{'disabled':'disabled'}:{}">
          View with Console</button>
      </div>
      <span class="buttonset">
        <button id="button-save" class="button-left button-primary" mjt.onclick="ui.do_file_save()"
          mjt.attrs="file.is_dirty()?{}:{'disabled':'disabled'}" title="$${mjt.bless(ui.shortcut.get_keys('Save File'))}">
          Save
        </button><button id="button-saveall" class="button-middle" mjt.onclick=" ui.do_app_save_all()" 
          mjt.attrs="app.is_dirty()?{}:{'disabled':'disabled'}">
          Save All
        </button><button id="button-save" class="button-right" mjt.onclick="ui.do_show_dialog('save_file_as')"
          mjt.attrs="!ui.get_user()||file.get_acre_handler()=='binary'?{'disabled':'disabled'}:{}">
          Save As</button>
        <button id="button-undo" class="button-left" mjt.attrs="ui._has_undos?{}:{'disabled':'disabled'}"
          mjt.onclick="ui.do_file_editor_undo()"  title="$${mjt.bless(ui.shortcut.get_keys('Undo'))}">
          Undo
        </button><button id="button-redo" class="button-right" mjt.attrs="ui._has_redos?{}:{'disabled':'disabled'}"
          mjt.onclick="ui.do_file_editor_redo()"  title="$${mjt.bless(ui.shortcut.get_keys('Redo'))}">
          Redo</button>
        <button id="button-indent" mjt.onclick="ui.do_file_editor_indent()" title="$${mjt.bless(ui.shortcut.get_keys('Indent Selection'))}"
          mjt.attrs="file.get_editor_supported_features('indent')&amp;&amp;writable?{}:{'disabled':'disabled'}">
          Indent
        </button>
      </span>
      <span class="buttonset">
       <button id="button-fileactions" class="button-left" mjt.onclick="ui.do_show_menu('fileactions');"
          mjt.attrs="fileactions_open ? {'class':'button-open'} : {}">    
          <span class="button-menu">File</span></button><button id="button-editoroptions" class="button-middle" mjt.onclick="ui.do_show_menu('editoroptions');"
          mjt.attrs="editoroptions_open?{'class':'button-open'}:(show_opts?{}:{'disabled':'disabled'})">
          <span class="button-menu">Editor</span></button><button id="button-help" class="button-right" mjt.onclick="ui.do_show_menu('help');">
          <span class="button-menu">Help</span></button>
      </span>
      <span class="buttoncount">
        <span class=" buttonset linecount" mjt.if="file.get_editor_supported_features('linenumbers')">
          Line <input id="linenumber" type="text" class="form-textbox" value="$${ui.get_line()||''}" title="$${mjt.bless(ui.shortcut.get_keys('Jump to Line'))}" />
        </span>
      </span>
    </div>
    <span mjt.script="ondomready">
      $$('#linenumber').keypress(function(e){
        if (e.which == 13) {
          var line = parseInt($$('#linenumber').val(),10);
          ui.do_file_editor_goto_line(line);
        }
      });
    </span>
  </div>
</div>

<div id="query-editor-buttons" mjt.def="query_button_bar()">
  <span mjt.script="">
    var writable = ui.get_app().is_writable();
  </span>
  <button class="button-primary" mjt.onclick="ui.get_file()._current_editor.query_run()" title="$${mjt.bless(ui.shortcut.get_keys('View'))}">
    Run</button>
  <button mjt.onclick="ui.get_file()._current_editor.query_assist()" title="Tab"
    mjt.attrs="writable?{}:{'disabled':'disabled'}">Query Assist</button>
  <button mjt.onclick="ui.get_file()._current_editor.generate_template()"
    mjt.attrs="writable?{}:{'disabled':'disabled'}">Create Template</button>
</div>

<!-- utilities -->  
<div mjt.def="message_panel(type, msg, tid)" class="message-$$type">
  <!--<span id="message-panel-close">x</span>-->
  <div class="message-icon $$type"></div> $${mjt.bless(msg)} 
  <span class="message-tid">$${tid||""}</span>
  <span mjt.script="ondomready">
    $$('#message-panel-close').click(function(){
      ui.MessagePanel.clear();
    })
</div>